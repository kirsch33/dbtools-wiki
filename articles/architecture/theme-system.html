<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Theme System | DBTools Developer Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Theme System | DBTools Developer Documentation ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/architecture/theme-system.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="conceptual" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../images/logo.png" alt="DBTools">
            DBTools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="theme-system">Theme System</h1>

<p>DBTools implements a comprehensive WPF theming system that provides a cohesive dark theme across all windows and controls. The system is designed to work within Revit's add-in environment while avoiding conflicts with other add-ins.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<pre><code>+-----------------------------------------------------------------------------------+
|                            DBTools Theme Stack                                     |
+-----------------------------------------------------------------------------------+
|                                                                                    |
|  +-------------------+     +--------------------+     +------------------------+   |
|  | DBTools.Themes    |     | Vendored Libraries |     | DBTools.Core           |   |
|  | (Resources)       |     | (UI Frameworks)    |     | (Theme Loading)        |   |
|  +-------------------+     +--------------------+     +------------------------+   |
|          |                         |                            |                  |
|          v                         v                            v                  |
|  +----------------+     +---------------------+     +------------------------+    |
|  | App.Theme.xaml | --&gt; | DBTools.HandyControl| --&gt; | DbtWindowInitHelper    |    |
|  | (Root Dict)    |     | DBTools.Fluent.Ribbon|    | DbtThemeValidator      |    |
|  +----------------+     | DBTools.ControlzEx  |     +------------------------+    |
|          |              +---------------------+                                    |
|          v                                                                        |
|  +---------------------------+                                                    |
|  | Merged Dictionaries       |                                                    |
|  | - App.Tokens.xaml         |                                                    |
|  | - App.Brushes.xaml        |                                                    |
|  | - App.Controls.Base.xaml  |                                                    |
|  | - App.DataGrid.xaml       |                                                    |
|  | - App.Menus.xaml          |                                                    |
|  | - App.Components.xaml     |                                                    |
|  | - App.FluentRibbon.xaml   |                                                    |
|  +---------------------------+                                                    |
+-----------------------------------------------------------------------------------+
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Theme.xaml:1-21</code></p>
</blockquote>
<h2 id="project-structure">Project Structure</h2>
<p>The <code>DBTools.Themes</code> project contains all theme resources and references vendored UI libraries:</p>
<pre><code>DBTools.Themes/
+-- DBTools.Themes.csproj       # Project configuration with vendored refs
+-- BrushKeys.cs                # ComponentResourceKey definitions
+-- Assets/
|   +-- db_tools_icon.png       # Window icon
+-- Themes/
    +-- App.Theme.xaml          # Root theme dictionary
    +-- App.Tokens.xaml         # Spacing, sizing, typography tokens
    +-- App.Brushes.xaml        # Color/brush definitions
    +-- App.Converters.xaml     # Value converters
    +-- App.Controls.Base.xaml  # Basic control styles
    +-- App.DataGrid.xaml       # DataGrid-specific styles
    +-- App.Menus.xaml          # Menu/ContextMenu styles
    +-- App.Components.xaml     # Composite component styles
    +-- App.FluentRibbon.xaml   # Fluent.Ribbon theme bridge
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/DBTools.Themes.csproj:1-72</code></p>
</blockquote>
<h2 id="vendored-ui-libraries">Vendored UI Libraries</h2>
<p>DBTools uses renamed/vendored copies of third-party UI libraries to avoid assembly conflicts with other Revit add-ins (especially pyRevit):</p>
<table>
<thead>
<tr>
<th>Library</th>
<th>Vendored Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>HandyControl</td>
<td>DBTools.HandyControl</td>
<td>Base theme framework</td>
</tr>
<tr>
<td>Fluent.Ribbon</td>
<td>DBTools.Fluent.Ribbon</td>
<td>Ribbon window/controls</td>
</tr>
<tr>
<td>ControlzEx</td>
<td>DBTools.ControlzEx</td>
<td>Window chrome behaviors</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/DBTools.Themes.csproj:54-71</code></p>
</blockquote>
<h3 id="why-vendored-libraries">Why Vendored Libraries?</h3>
<p>WPF theme assemblies cannot be ILRepack-merged or embedded as resources because they require <code>Assembly.Location</code> for <code>pack://</code> URI resolution. The vendoring process:</p>
<ol>
<li>Clones upstream repos to <code>vendor/</code></li>
<li>Renames assembly names and updates pack URIs</li>
<li>Builds renamed assemblies to <code>csharp/.artifacts/vendor/</code></li>
<li>Deploys alongside <code>DBTools.dll</code></li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build-vendored-deps.sh:1-446</code></p>
</blockquote>
<h2 id="theme-loading-mechanism">Theme Loading Mechanism</h2>
<h3 id="window-scoped-theming">Window-Scoped Theming</h3>
<p>DBTools applies themes at the <strong>window level</strong> (not application level) because Revit's Application.Resources are shared across all add-ins. This prevents theme pollution between add-ins.</p>
<pre><code class="lang-csharp">public static void EnsureWindowScopedTheme(Window window)
{
    WpfUiThread.EnsurePackUriSupport();

    if (!ResourceDictionaryHelper.HasSource(window.Resources, ThemeSource))
    {
        window.Resources.MergedDictionaries.Add(new ResourceDictionary
        {
            Source = new Uri(ThemeSource, UriKind.Absolute)
        });
    }

    DbtThemeValidator.FreezeFreezablesOrThrow(window.Resources);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowInitHelper.cs:91-108</code></p>
</blockquote>
<h3 id="theme-initialization-flow">Theme Initialization Flow</h3>
<ol>
<li><strong>Window Constructor</strong>: <code>DbtWindowInitHelper.Initialize()</code> is called</li>
<li><strong>Pack URI Support</strong>: <code>WpfUiThread.EnsurePackUriSupport()</code> ensures pack:// scheme is registered</li>
<li><strong>Dictionary Merge</strong>: <code>App.Theme.xaml</code> is merged into <code>Window.Resources</code></li>
<li><strong>Resource Freeze</strong>: All freezable resources are frozen to prevent runtime leaks</li>
<li><strong>Validation</strong>: Theme contract is validated (dictionary order, completeness)</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowInitHelper.cs:44-78</code></p>
</blockquote>
<h3 id="theme-opt-out">Theme Opt-Out</h3>
<p>Windows can opt out of DBTools theming via <code>IThemeOptOut</code>:</p>
<pre><code class="lang-csharp">public interface IThemeOptOut
{
    bool UseDefaultTheme { get; set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowBase.cs:13-21</code></p>
</blockquote>
<h2 id="resourcedictionary-structure">ResourceDictionary Structure</h2>
<h3 id="root-theme-dictionary">Root Theme Dictionary</h3>
<p><code>App.Theme.xaml</code> is the root dictionary that merges all theme components:</p>
<pre><code class="lang-xml">&lt;ResourceDictionary xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;&gt;
    &lt;ResourceDictionary.MergedDictionaries&gt;
        &lt;!-- HandyControl Foundation --&gt;
        &lt;ResourceDictionary Source=&quot;pack://application:,,,/DBTools.HandyControl;component/Themes/SkinDark.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;pack://application:,,,/DBTools.HandyControl;component/Themes/Theme.xaml&quot;/&gt;

        &lt;!-- Fluent.Ribbon for ribbon windows --&gt;
        &lt;ResourceDictionary Source=&quot;pack://application:,,,/DBTools.Fluent.Ribbon;component/Themes/Generic.xaml&quot;/&gt;

        &lt;!-- DBTools Custom Themes --&gt;
        &lt;ResourceDictionary Source=&quot;App.Tokens.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.Brushes.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.Converters.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.Controls.Base.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.DataGrid.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.Menus.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.Components.xaml&quot;/&gt;
        &lt;ResourceDictionary Source=&quot;App.FluentRibbon.xaml&quot;/&gt;
    &lt;/ResourceDictionary.MergedDictionaries&gt;
&lt;/ResourceDictionary&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Theme.xaml:1-21</code></p>
</blockquote>
<h3 id="dictionary-order-contract">Dictionary Order Contract</h3>
<p>The merged dictionary order is locked and validated at runtime:</p>
<pre><code class="lang-csharp">private static readonly IReadOnlyList&lt;string&gt; ExpectedMergedDictionarySources = new[]
{
    &quot;pack://application:,,,/DBTools.HandyControl;component/Themes/SkinDark.xaml&quot;,
    &quot;pack://application:,,,/DBTools.HandyControl;component/Themes/Theme.xaml&quot;,
    &quot;pack://application:,,,/DBTools.Fluent.Ribbon;component/Themes/Generic.xaml&quot;,
    &quot;pack://application:,,,/DBTools.Themes;component/Themes/App.Tokens.xaml&quot;,
    &quot;pack://application:,,,/DBTools.Themes;component/Themes/App.Brushes.xaml&quot;,
    // ... additional dictionaries
};
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Theming/DbtThemeValidator.cs:20-33</code></p>
</blockquote>
<h2 id="design-tokens">Design Tokens</h2>
<h3 id="spacing-tokens">Spacing Tokens</h3>
<p>Standard spacing values for consistent layouts:</p>
<pre><code class="lang-xml">&lt;Thickness x:Key=&quot;Spacing4&quot;&gt;4&lt;/Thickness&gt;
&lt;Thickness x:Key=&quot;Spacing8&quot;&gt;8&lt;/Thickness&gt;
&lt;Thickness x:Key=&quot;Spacing12&quot;&gt;12&lt;/Thickness&gt;
&lt;Thickness x:Key=&quot;Spacing16&quot;&gt;16&lt;/Thickness&gt;
&lt;Thickness x:Key=&quot;Spacing32&quot;&gt;32&lt;/Thickness&gt;

&lt;!-- Scalar variants for non-Thickness contexts --&gt;
&lt;sys:Double x:Key=&quot;Spacing8.Value&quot;&gt;8&lt;/sys:Double&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Tokens.xaml:5-18</code></p>
</blockquote>
<h3 id="typography-tokens">Typography Tokens</h3>
<pre><code class="lang-xml">&lt;sys:Double x:Key=&quot;FontSize.Caption&quot;&gt;11&lt;/sys:Double&gt;
&lt;sys:Double x:Key=&quot;FontSize.Body.Small&quot;&gt;12&lt;/sys:Double&gt;
&lt;sys:Double x:Key=&quot;FontSize.Body&quot;&gt;13&lt;/sys:Double&gt;
&lt;sys:Double x:Key=&quot;FontSize.Subtitle&quot;&gt;14&lt;/sys:Double&gt;
&lt;sys:Double x:Key=&quot;FontSize.Title&quot;&gt;16&lt;/sys:Double&gt;
&lt;sys:Double x:Key=&quot;FontSize.Header&quot;&gt;20&lt;/sys:Double&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Tokens.xaml:66-72</code></p>
</blockquote>
<h3 id="corner-radius-tokens">Corner Radius Tokens</h3>
<pre><code class="lang-xml">&lt;CornerRadius x:Key=&quot;Radius4&quot;&gt;4&lt;/CornerRadius&gt;
&lt;CornerRadius x:Key=&quot;Radius6&quot;&gt;6&lt;/CornerRadius&gt;
&lt;CornerRadius x:Key=&quot;Radius8&quot;&gt;8&lt;/CornerRadius&gt;
&lt;CornerRadius x:Key=&quot;Radius12&quot;&gt;12&lt;/CornerRadius&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Tokens.xaml:43-46</code></p>
</blockquote>
<h2 id="color-system">Color System</h2>
<h3 id="brushkeys-componentresourcekeys">BrushKeys (ComponentResourceKeys)</h3>
<p>All brushes are defined using <code>ComponentResourceKey</code> to enable reliable cross-template resolution:</p>
<pre><code class="lang-csharp">public static class BrushKeys
{
    public static ComponentResourceKey Primary =&gt; new(typeof(BrushKeys), &quot;Brush.Primary&quot;);
    public static ComponentResourceKey PrimaryLight =&gt; new(typeof(BrushKeys), &quot;Brush.PrimaryLight&quot;);
    public static ComponentResourceKey Paper =&gt; new(typeof(BrushKeys), &quot;Brush.Paper&quot;);
    public static ComponentResourceKey Surface =&gt; new(typeof(BrushKeys), &quot;Brush.Surface&quot;);
    public static ComponentResourceKey Body =&gt; new(typeof(BrushKeys), &quot;Brush.Body&quot;);
    // ... 130+ additional keys
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/BrushKeys.cs:1-139</code></p>
</blockquote>
<h3 id="brand-colors">Brand Colors</h3>
<p>DBTools uses a blue/gold brand palette:</p>
<pre><code class="lang-xml">&lt;!-- Core Brand Colors --&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Primary}&quot; Color=&quot;#FF1946B9&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.PrimaryLight}&quot; Color=&quot;#FF3D6AD4&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Secondary}&quot; Color=&quot;#FFFEC425&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.SecondaryLight}&quot; Color=&quot;#FFFFD54F&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Brushes.xaml:14-19</code></p>
</blockquote>
<h3 id="surface-colors">Surface Colors</h3>
<p>Dark theme surfaces with subtle differentiation:</p>
<pre><code class="lang-xml">&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Paper}&quot; Color=&quot;#FF181820&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Surface}&quot; Color=&quot;#FF222228&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.SurfaceAlt}&quot; Color=&quot;#FF1C1C22&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.CardSurface}&quot; Color=&quot;#FF1E1E24&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Brushes.xaml:24-30</code></p>
</blockquote>
<h3 id="text-colors-wcag-compliant">Text Colors (WCAG Compliant)</h3>
<p>Text colors maintain minimum 4.5:1 contrast ratio for accessibility:</p>
<pre><code class="lang-xml">&lt;!-- WCAG AA compliant - min 4.5:1 contrast ratio on dark backgrounds --&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Body}&quot; Color=&quot;#FFE6E6E6&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.BodyLight}&quot; Color=&quot;#FFBDBDBD&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.TextMuted}&quot; Color=&quot;#FF999999&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Brushes.xaml:35-40</code></p>
</blockquote>
<h3 id="status-colors">Status Colors</h3>
<p>Semantic colors for success, warning, error, and info states:</p>
<pre><code class="lang-xml">&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Success}&quot; Color=&quot;#FF4CAF50&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Warning}&quot; Color=&quot;#FFFFA000&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Error}&quot; Color=&quot;#FFCF6679&quot;/&gt;
&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.Info}&quot; Color=&quot;#FF1946B9&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Brushes.xaml:84-95</code></p>
</blockquote>
<h2 id="window-base-classes">Window Base Classes</h2>
<h3 id="dbtwindowbase">DbtWindowBase</h3>
<p>Standard modal window with theme and progress overlay support:</p>
<pre><code class="lang-csharp">public class DbtWindowBase : Window, IWindowWithOwnerProvider, IThemeOptOut
{
    public DbtWindowBase()
    {
        DbtWindowInitHelper.Initialize(this, nameof(DbtWindowBase));
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowBase.cs:27-32</code></p>
</blockquote>
<p>The XAML style applies default theme properties and progress overlay:</p>
<pre><code class="lang-xml">&lt;Style TargetType=&quot;{x:Type core:DbtWindowBase}&quot; BasedOn=&quot;{StaticResource {x:Type Window}}&quot;&gt;
    &lt;Setter Property=&quot;Icon&quot; Value=&quot;pack://application:,,,/DBTools.Themes;component/Assets/db_tools_icon.png&quot;/&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Paper}}&quot;/&gt;
    &lt;Setter Property=&quot;Foreground&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Body}}&quot;/&gt;
    &lt;Setter Property=&quot;ContentTemplate&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;DataTemplate&gt;
                &lt;Grid&gt;
                    &lt;ContentPresenter/&gt;
                    &lt;Border Panel.ZIndex=&quot;1000&quot; ...&gt;
                        &lt;progress:ProgressOverlayControl .../&gt;
                    &lt;/Border&gt;
                &lt;/Grid&gt;
            &lt;/DataTemplate&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Controls.Base.xaml:13-33</code></p>
</blockquote>
<h3 id="dbtribbonwindowbase">DbtRibbonWindowBase</h3>
<p>Ribbon window for tool UIs with tab-based navigation:</p>
<pre><code class="lang-csharp">public class DbtRibbonWindowBase : RibbonWindow, IWindowWithOwnerProvider, IThemeOptOut
{
    public DbtRibbonWindowBase()
    {
        DbtWindowInitHelper.Initialize(this, nameof(DbtRibbonWindowBase));
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtRibbonWindowBase.cs:15-19</code></p>
</blockquote>
<h2 id="fluentribbon-theme-bridge">Fluent.Ribbon Theme Bridge</h2>
<p><code>App.FluentRibbon.xaml</code> maps all 196+ Fluent.Ribbon internal brush keys to DBTools theme colors:</p>
<pre><code class="lang-xml">&lt;!-- Window Chrome --&gt;
&lt;SolidColorBrush x:Key=&quot;Fluent.Ribbon.Brushes.RibbonWindow.Background&quot;
    Color=&quot;{Binding Source={StaticResource {x:Static theme:BrushKeys.Paper}}, Path=Color}&quot;/&gt;

&lt;!-- Tab Control --&gt;
&lt;SolidColorBrush x:Key=&quot;Fluent.Ribbon.Brushes.RibbonTabItem.Selected.Background&quot;
    Color=&quot;{Binding Source={StaticResource {x:Static theme:BrushKeys.SelectionGoldStrong}}, Path=Color}&quot;/&gt;

&lt;!-- Buttons --&gt;
&lt;SolidColorBrush x:Key=&quot;Fluent.Ribbon.Brushes.Button.MouseOver.Background&quot;
    Color=&quot;{Binding Source={StaticResource {x:Static theme:BrushKeys.Hover}}, Path=Color}&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.FluentRibbon.xaml:24-211</code></p>
</blockquote>
<h3 id="transitioningcontrol-hotfix">TransitioningControl Hotfix</h3>
<p>A style override prevents animation failures during tab switching:</p>
<pre><code class="lang-xml">&lt;Style TargetType=&quot;{x:Type fluent:TransitioningControl}&quot;&gt;
    &lt;Setter Property=&quot;Template&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;ControlTemplate TargetType=&quot;{x:Type fluent:TransitioningControl}&quot;&gt;
                &lt;Border ...&gt;
                    &lt;Grid&gt;
                        &lt;ContentPresenter x:Name=&quot;PART_CurrentContent&quot; .../&gt;
                        &lt;ContentPresenter x:Name=&quot;PART_PreviousContent&quot; .../&gt;
                    &lt;/Grid&gt;
                &lt;/Border&gt;
            &lt;/ControlTemplate&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.FluentRibbon.xaml:53-97</code></p>
</blockquote>
<h2 id="control-styles">Control Styles</h2>
<h3 id="standard-controls">Standard Controls</h3>
<p>Implicit styles override WPF defaults with theme colors:</p>
<pre><code class="lang-xml">&lt;Style TargetType=&quot;Button&quot; BasedOn=&quot;{StaticResource {x:Type Button}}&quot;&gt;
    &lt;Setter Property=&quot;MinWidth&quot; Value=&quot;88&quot;/&gt;
    &lt;Setter Property=&quot;MinHeight&quot; Value=&quot;36&quot;/&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Surface}}&quot;/&gt;
    &lt;Setter Property=&quot;Foreground&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Body}}&quot;/&gt;
    &lt;Setter Property=&quot;BorderBrush&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Divider}}&quot;/&gt;
    &lt;Style.Triggers&gt;
        &lt;Trigger Property=&quot;IsMouseOver&quot; Value=&quot;True&quot;&gt;
            &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.SecondaryHover}}&quot;/&gt;
        &lt;/Trigger&gt;
    &lt;/Style.Triggers&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Controls.Base.xaml:73-92</code></p>
</blockquote>
<h3 id="datagrid-styles">DataGrid Styles</h3>
<p>Custom DataGrid with accent stripe and enhanced selection:</p>
<pre><code class="lang-xml">&lt;Style TargetType=&quot;DataGridRow&quot; BasedOn=&quot;{StaticResource {x:Type DataGridRow}}&quot;&gt;
    &lt;Setter Property=&quot;Template&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;ControlTemplate TargetType=&quot;DataGridRow&quot;&gt;
                &lt;Border x:Name=&quot;DGR_Border&quot; ...&gt;
                    &lt;Grid&gt;
                        &lt;Grid.ColumnDefinitions&gt;
                            &lt;ColumnDefinition Width=&quot;3&quot;/&gt;  &lt;!-- Accent stripe --&gt;
                            &lt;ColumnDefinition Width=&quot;*&quot;/&gt;
                        &lt;/Grid.ColumnDefinitions&gt;
                        &lt;Border x:Name=&quot;AccentStripe&quot; Grid.Column=&quot;0&quot;
                                Background=&quot;Transparent&quot;/&gt;
                        &lt;SelectiveScrollingGrid Grid.Column=&quot;1&quot;&gt;
                            &lt;!-- Row content --&gt;
                        &lt;/SelectiveScrollingGrid&gt;
                    &lt;/Grid&gt;
                &lt;/Border&gt;
                &lt;ControlTemplate.Triggers&gt;
                    &lt;Trigger Property=&quot;IsSelected&quot; Value=&quot;True&quot;&gt;
                        &lt;Setter TargetName=&quot;AccentStripe&quot; Property=&quot;Background&quot;
                                Value=&quot;{DynamicResource {x:Static theme:BrushKeys.DataGridAccentStripe}}&quot;/&gt;
                    &lt;/Trigger&gt;
                &lt;/ControlTemplate.Triggers&gt;
            &lt;/ControlTemplate&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.DataGrid.xaml:24-101</code></p>
</blockquote>
<h3 id="menu-styles">Menu Styles</h3>
<p>Full custom templates avoid Revit add-in styling conflicts:</p>
<pre><code class="lang-xml">&lt;Style x:Key=&quot;ContextMenu&quot; TargetType=&quot;ContextMenu&quot;&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Surface}}&quot;/&gt;
    &lt;Setter Property=&quot;BorderBrush&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Divider}}&quot;/&gt;
    &lt;Setter Property=&quot;Template&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;ControlTemplate TargetType=&quot;ContextMenu&quot;&gt;
                &lt;Border Background=&quot;{TemplateBinding Background}&quot;
                        CornerRadius=&quot;4&quot; SnapsToDevicePixels=&quot;True&quot;&gt;
                    &lt;Border.Effect&gt;
                        &lt;DropShadowEffect BlurRadius=&quot;8&quot; ShadowDepth=&quot;2&quot; Opacity=&quot;0.35&quot;/&gt;
                    &lt;/Border.Effect&gt;
                    &lt;ScrollViewer&gt;
                        &lt;ItemsPresenter/&gt;
                    &lt;/ScrollViewer&gt;
                &lt;/Border&gt;
            &lt;/ControlTemplate&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Menus.xaml:9-42</code></p>
</blockquote>
<h2 id="component-styles">Component Styles</h2>
<h3 id="cards">Cards</h3>
<p>Elevated card surfaces with shadows:</p>
<pre><code class="lang-xml">&lt;Style x:Key=&quot;Card&quot; TargetType=&quot;Border&quot;&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.CardSurface}}&quot;/&gt;
    &lt;Setter Property=&quot;BorderBrush&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.CardBorder}}&quot;/&gt;
    &lt;Setter Property=&quot;CornerRadius&quot; Value=&quot;{DynamicResource Radius8}&quot;/&gt;
    &lt;Setter Property=&quot;Padding&quot; Value=&quot;{DynamicResource Card.Padding}&quot;/&gt;
&lt;/Style&gt;

&lt;Style x:Key=&quot;Card.Elevated&quot; TargetType=&quot;Border&quot; BasedOn=&quot;{StaticResource Card}&quot;&gt;
    &lt;Setter Property=&quot;Effect&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;DropShadowEffect BlurRadius=&quot;18&quot; ShadowDepth=&quot;4&quot; Opacity=&quot;0.35&quot;/&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Components.xaml:205-225</code></p>
</blockquote>
<h3 id="toolbar-chips">Toolbar Chips</h3>
<p>Toggle buttons styled as filter chips:</p>
<pre><code class="lang-xml">&lt;Style x:Key=&quot;ToolbarChip&quot; TargetType=&quot;ToggleButton&quot;&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.ToolbarChipBackground}}&quot;/&gt;
    &lt;Setter Property=&quot;Template&quot;&gt;
        &lt;Setter.Value&gt;
            &lt;ControlTemplate TargetType=&quot;ToggleButton&quot;&gt;
                &lt;Border x:Name=&quot;Chip&quot; CornerRadius=&quot;{DynamicResource Radius6}&quot; ...&gt;
                    &lt;ContentPresenter/&gt;
                &lt;/Border&gt;
                &lt;ControlTemplate.Triggers&gt;
                    &lt;Trigger Property=&quot;IsChecked&quot; Value=&quot;True&quot;&gt;
                        &lt;Setter TargetName=&quot;Chip&quot; Property=&quot;Background&quot;
                                Value=&quot;{DynamicResource {x:Static theme:BrushKeys.ToolbarChipSelected}}&quot;/&gt;
                    &lt;/Trigger&gt;
                &lt;/ControlTemplate.Triggers&gt;
            &lt;/ControlTemplate&gt;
        &lt;/Setter.Value&gt;
    &lt;/Setter&gt;
&lt;/Style&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/Themes/App.Components.xaml:29-91</code></p>
</blockquote>
<h2 id="theme-validation">Theme Validation</h2>
<h3 id="startup-validation">Startup Validation</h3>
<p><code>DbtThemeValidator.ValidateOrThrow()</code> performs comprehensive theme validation:</p>
<ol>
<li><strong>Incremental Merge Test</strong>: Merges each dictionary one-by-one to pinpoint failures</li>
<li><strong>Freezable Freeze</strong>: Freezes all brushes to prevent runtime leaks</li>
<li><strong>Contract Assertion</strong>: Validates merged dictionary order matches expected</li>
<li><strong>Ghost Validation</strong>: Creates invisible control tree to force template evaluation</li>
</ol>
<pre><code class="lang-csharp">public static void ValidateOrThrow()
{
    WpfUiThread.EnsurePackUriSupport();

    // Incremental merge to pinpoint first broken dictionary
    var scratch = new ResourceDictionary();
    foreach (var source in ExpectedMergedDictionarySources)
    {
        scratch.MergedDictionaries.Add(new ResourceDictionary
        {
            Source = new Uri(source, UriKind.Absolute)
        });
    }

    FreezeFreezablesOrThrow(scratch);
    AssertMergedDictionariesContract(themeRoot);
    GhostValidate(themeRoot);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Theming/DbtThemeValidator.cs:52-92</code></p>
</blockquote>
<h3 id="ghost-validation">Ghost Validation</h3>
<p>Creates an invisible visual tree to force template instantiation and catch deferred failures:</p>
<pre><code class="lang-csharp">private static void GhostValidate(ResourceDictionary themeRoot)
{
    var root = new Grid { Width = 800, Height = 600 };
    root.Resources.MergedDictionaries.Add(themeRoot);

    root.Children.Add(BuildProbeContent(root));

    root.Measure(new Size(root.Width, root.Height));
    root.Arrange(new Rect(0, 0, root.Width, root.Height));
    root.UpdateLayout();
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Theming/DbtThemeValidator.cs:229-248</code></p>
</blockquote>
<h2 id="using-the-theme">Using the Theme</h2>
<h3 id="in-xaml">In XAML</h3>
<p>Reference brushes via <code>DynamicResource</code> and <code>BrushKeys</code>:</p>
<pre><code class="lang-xml">&lt;Window xmlns:theme=&quot;clr-namespace:DBTools.Themes;assembly=DBTools.Themes&quot;&gt;
    &lt;Border Background=&quot;{DynamicResource {x:Static theme:BrushKeys.Surface}}&quot;&gt;
        &lt;TextBlock Text=&quot;Hello&quot;
                   Foreground=&quot;{DynamicResource {x:Static theme:BrushKeys.Body}}&quot;/&gt;
    &lt;/Border&gt;
&lt;/Window&gt;
</code></pre>
<h3 id="in-code">In Code</h3>
<p>Use <code>SetResourceReference</code> for dynamic binding:</p>
<pre><code class="lang-csharp">window.SetResourceReference(Window.BackgroundProperty, BrushKeys.Paper);
window.SetResourceReference(Window.ForegroundProperty, BrushKeys.Body);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowInitHelper.cs:151-155</code></p>
</blockquote>
<h2 id="extending-the-theme">Extending the Theme</h2>
<h3 id="adding-new-brushes">Adding New Brushes</h3>
<ol>
<li>Add <code>ComponentResourceKey</code> property in <code>BrushKeys.cs</code>:</li>
</ol>
<pre><code class="lang-csharp">public static ComponentResourceKey MyNewBrush =&gt; new(typeof(BrushKeys), &quot;Brush.MyNew&quot;);
</code></pre>
<ol start="2">
<li>Add brush definition in <code>App.Brushes.xaml</code>:</li>
</ol>
<pre><code class="lang-xml">&lt;SolidColorBrush x:Key=&quot;{x:Static theme:BrushKeys.MyNewBrush}&quot; Color=&quot;#FF123456&quot;/&gt;
</code></pre>
<h3 id="adding-new-styles">Adding New Styles</h3>
<ol>
<li>Create new keyed style in appropriate dictionary:</li>
</ol>
<pre><code class="lang-xml">&lt;Style x:Key=&quot;MyCustomButton&quot; TargetType=&quot;Button&quot; BasedOn=&quot;{StaticResource {x:Type Button}}&quot;&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Primary}}&quot;/&gt;
&lt;/Style&gt;
</code></pre>
<ol start="2">
<li>For implicit styles, omit the <code>x:Key</code>:</li>
</ol>
<pre><code class="lang-xml">&lt;Style TargetType=&quot;MyCustomControl&quot;&gt;
    &lt;Setter Property=&quot;Background&quot; Value=&quot;{DynamicResource {x:Static theme:BrushKeys.Surface}}&quot;/&gt;
&lt;/Style&gt;
</code></pre>
<h3 id="xaml-resource-file-types">XAML Resource File Types</h3>
<p>Some XAML files reference <code>DBTools.Core</code> types and cannot be compiled as BAML:</p>
<pre><code class="lang-xml">&lt;!-- These files are raw resources, not compiled BAML --&gt;
&lt;Page Remove=&quot;Themes\App.Converters.xaml&quot;/&gt;
&lt;Page Remove=&quot;Themes\App.Controls.Base.xaml&quot;/&gt;
&lt;Page Remove=&quot;Themes\App.Components.xaml&quot;/&gt;

&lt;Resource Include=&quot;Themes\App.Converters.xaml&quot;/&gt;
&lt;Resource Include=&quot;Themes\App.Controls.Base.xaml&quot;/&gt;
&lt;Resource Include=&quot;Themes\App.Components.xaml&quot;/&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Themes/DBTools.Themes.csproj:38-46</code></p>
</blockquote>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="overview.html">Architecture Overview</a> - High-level system architecture</li>
<li><a href="project-references.html">Project References</a> - Project dependency graph</li>
</ul>
<hr>
<h2 id="files-reviewed">Files Reviewed</h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>csharp/src/DBTools.Themes/DBTools.Themes.csproj</code></td>
<td>Project configuration</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/BrushKeys.cs</code></td>
<td>ComponentResourceKey definitions</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Theme.xaml</code></td>
<td>Root theme dictionary</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Tokens.xaml</code></td>
<td>Design tokens</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Brushes.xaml</code></td>
<td>Color definitions</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Controls.Base.xaml</code></td>
<td>Base control styles</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.DataGrid.xaml</code></td>
<td>DataGrid styles</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Menus.xaml</code></td>
<td>Menu styles</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Components.xaml</code></td>
<td>Component styles</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.FluentRibbon.xaml</code></td>
<td>Fluent.Ribbon bridge</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Themes/Themes/App.Converters.xaml</code></td>
<td>Value converters</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Core/UI/Theming/DbtThemeValidator.cs</code></td>
<td>Theme validation</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Core/UI/Windows/DbtWindowBase.cs</code></td>
<td>Window base class</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Core/UI/Windows/DbtRibbonWindowBase.cs</code></td>
<td>Ribbon window base</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Core/UI/Windows/DbtWindowInitHelper.cs</code></td>
<td>Theme loading logic</td>
</tr>
<tr>
<td><code>csharp/src/DBTools.Core/UI/Windows/ResourceDictionaryHelper.cs</code></td>
<td>Dictionary utilities</td>
</tr>
<tr>
<td><code>csharp/build-vendored-deps.sh</code></td>
<td>Vendored library build script</td>
</tr>
</tbody>
</table>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/architecture/theme-system.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DBTools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
