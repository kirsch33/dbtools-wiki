<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>ILRepack and Assembly Embedding | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ILRepack and Assembly Embedding | DB Tools ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/architecture/ilrepack-embedding.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../public/main.js" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="conceptual" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" src="../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="ilrepack-and-assembly-embedding">ILRepack and Assembly Embedding</h1>

<!-- STATUS: draft -->
<!-- Last Updated: 2026-01-24 -->
<!-- Verified By: docs-run-20260124-020412 -->
<p>This document describes how DBTools merges and embeds assemblies to achieve a minimal deployment footprint while avoiding conflicts with other Revit add-ins.</p>
<h2 id="overview">Overview</h2>
<p>DBTools uses two complementary strategies to manage dependencies:</p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>Framework</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ILRepack</strong></td>
<td>net48 only</td>
<td>Merges most dependencies INTO <code>DBTools.dll</code></td>
</tr>
<tr>
<td><strong>Embedding</strong></td>
<td>Both TFMs</td>
<td>Embeds assemblies as resources, loaded on-demand</td>
</tr>
</tbody>
</table>
<p>Both strategies aim to:</p>
<ol>
<li>Minimize deployment files (ideally just <code>DBTools.dll</code> + <code>DBTools.Loader.dll</code> + WPF theme DLLs)</li>
<li>Avoid conflicts with other Revit add-ins that may load different versions of shared libraries</li>
<li>Prevent GAC/Revit-provided assemblies from being used instead of our versions</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:11-22</code></p>
</blockquote>
<h2 id="why-ilrepack-the-revit-add-in-conflict-problem">Why ILRepack? The Revit Add-in Conflict Problem</h2>
<p>Revit add-ins share a single <code>AppDomain</code> (net48) or <code>AssemblyLoadContext</code> (net8). When multiple add-ins depend on the same library (e.g., Serilog, Newtonsoft.Json), the first-loaded version wins.</p>
<p><strong>Problems this causes:</strong></p>
<ul>
<li>Type identity mismatches (your code expects <code>Serilog 4.0</code>, but <code>Serilog 2.0</code> was loaded first)</li>
<li>Missing method exceptions (newer API called on older assembly)</li>
<li>Mysterious crashes when reflection fails</li>
</ul>
<p><strong>ILRepack's solution:</strong></p>
<ul>
<li>Merge dependencies INTO <code>DBTools.dll</code> with internalized types</li>
<li>Types become <code>internal</code> to your assembly, invisible to other add-ins</li>
<li>No conflict possible because types aren't shared</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:17-21</code></p>
</blockquote>
<hr>
<h2 id="net48-vs-net80-windows-strategy-differences">net48 vs net8.0-windows Strategy Differences</h2>
<h3 id="net48-revit-2024">net48 (Revit 2024)</h3>
<p>Uses <strong>both</strong> ILRepack merging AND embedding:</p>
<pre><code>+-------------------+
|   DBTools.dll     |
|   (ILRepack'd)    |  &lt;-- Contains merged types from Serilog, M.E.*, etc.
+-------------------+
        |
        +-- Embedded resources: ricaun.Revit.UI.*.dll (loaded from bytes)
        |
        +-- Separate files: DBTools.Fluent.Ribbon.dll, DBTools.Themes.dll, etc.
</code></pre>
<h3 id="net80-windows-revit-20252026">net8.0-windows (Revit 2025/2026)</h3>
<p>Uses <strong>embedding only</strong> (no ILRepack):</p>
<pre><code>+-------------------+
|   DBTools.dll     |
|   (standard)      |
+-------------------+
        |
        +-- Embedded resources: ALL dependencies (DBTools.Core, Serilog, M.E.*, etc.)
        |
        +-- Separate files: DBTools.Fluent.Ribbon.dll, DBTools.Themes.dll, etc.
</code></pre>
<p><strong>Why no ILRepack for net8?</strong></p>
<ul>
<li>.NET 8's <code>AssemblyLoadContext</code> provides natural isolation</li>
<li>Each add-in can have its own isolated context</li>
<li>ILRepack has compatibility issues with some .NET 8 assemblies</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:13-14</code>, <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:32-37</code></p>
</blockquote>
<hr>
<h2 id="ilrepack-merging-net48">ILRepack Merging (net48)</h2>
<h3 id="target-mergenet48assemblies">Target: <code>MergeNet48Assemblies</code></h3>
<p>The build target <code>MergeNet48Assemblies</code> performs the merge:</p>
<pre><code class="lang-csharp">Target MergeNet48Assemblies =&gt; _ =&gt; _
    .Description(&quot;Merge ALL dependencies into DBTools.dll for net48 via ILRepack (except WPF themes)&quot;)
    .DependsOn(FlattenYearOutputs)
    .After(BuildApp, BuildTests)
    .Before(PromoteToDist)
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:23-28</code></p>
</blockquote>
<h3 id="what-gets-merged-everything-except-whitelist">What Gets Merged (Everything Except Whitelist)</h3>
<p>The strategy is &quot;merge everything EXCEPT a small whitelist&quot;:</p>
<pre><code class="lang-csharp">var keepSeparate = new HashSet&lt;string&gt;(StringComparer.OrdinalIgnoreCase)
{
    &quot;DBTools.dll&quot;,                              // Primary assembly (merging INTO this)
    &quot;DBTools.Loader.dll&quot;,                       // Entry point loaded by Revit
    &quot;DBTools.HandyControl.dll&quot;,                 // WPF theme - needs file Location
    &quot;DBTools.Fluent.Ribbon.dll&quot;,                // WPF theme - needs file Location
    &quot;DBTools.ControlzEx.dll&quot;,                   // WPF theme - needs file Location
    &quot;DBTools.Themes.dll&quot;,                       // WPF theme - needs file Location
    &quot;Microsoft.Extensions.Logging.Abstractions.dll&quot;, // Shared with sandbox
    // Revit API (shouldn't be in output)
    &quot;RevitAPI.dll&quot;, &quot;RevitAPIUI.dll&quot;, &quot;AdWindows.dll&quot;, &quot;UIFramework.dll&quot;
};
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:50-65</code></p>
</blockquote>
<h3 id="prefix-based-exclusions">Prefix-Based Exclusions</h3>
<p>Some assemblies are excluded by prefix (because NuGet adds version numbers):</p>
<pre><code class="lang-csharp">var keepSeparatePrefixes = new[] { &quot;ricaun.Revit.UI&quot; };
</code></pre>
<p><strong>Why ricaun assemblies aren't merged:</strong></p>
<ul>
<li>ILRepack corrupts ricaun IL, causing runtime crashes</li>
<li>Instead, ricaun assemblies are EMBEDDED as resources</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:68-70</code></p>
</blockquote>
<h3 id="internalization-with-exclusions">Internalization with Exclusions</h3>
<p>ILRepack internalizes merged types, but some namespaces must stay public:</p>
<pre><code class="lang-csharp">var excludeFile = yearDir / &quot;ilrepack-exclude.txt&quot;;
File.WriteAllText(excludeFile, &quot;^DBTools\\.Core\\.\n^Serilog\\.\n^Microsoft\\.Extensions\\.\n^Microsoft\\.Bcl\\.\n^System\\.\n^ricaun\\.Revit\\.&quot;);
</code></pre>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>Why Public</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DBTools.Core.*</code></td>
<td>Base classes used by tools</td>
</tr>
<tr>
<td><code>Serilog.*</code></td>
<td>Reflection-based sink discovery</td>
</tr>
<tr>
<td><code>Microsoft.Extensions.*</code></td>
<td>DI and configuration</td>
</tr>
<tr>
<td><code>Microsoft.Bcl.*</code></td>
<td>Polyfill interfaces (IAsyncDisposable)</td>
</tr>
<tr>
<td><code>System.*</code></td>
<td>Polyfill types</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:115-127</code></p>
</blockquote>
<h3 id="ilrepack-command">ILRepack Command</h3>
<p>The actual merge command:</p>
<pre><code class="lang-csharp">args.Append($&quot;/internalize:\&quot;{excludeFile}\&quot; &quot;);  // Internalize with exclusions
args.Append(&quot;/allowdup &quot;);                        // Handle duplicate polyfill types
args.Append(&quot;/ndebug &quot;);                          // Skip debug info
args.Append($&quot;/lib:\&quot;{revitPath}\&quot; &quot;);            // Resolve Revit API references
args.Append($&quot;/out:\&quot;{dbToolsDll}\&quot; &quot;);           // Output to DBTools.dll
args.Append($&quot;\&quot;{backupOriginal}\&quot; &quot;);            // Primary assembly
// + all assemblies to merge
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:129-144</code></p>
</blockquote>
<hr>
<h2 id="assembly-embedding-strategy">Assembly Embedding Strategy</h2>
<h3 id="build-target-dbt_embedcopylocalassemblies">Build Target: <code>DBT_EmbedCopyLocalAssemblies</code></h3>
<p>The embedding happens during MSBuild via a custom target:</p>
<pre><code class="lang-xml">&lt;Target Name=&quot;DBT_EmbedCopyLocalAssemblies&quot;
        AfterTargets=&quot;ResolveReferences&quot;
        Condition=&quot;'$(DesignTimeBuild)'!='true'&quot;&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:234-236</code></p>
</blockquote>
<h3 id="resource-naming-convention">Resource Naming Convention</h3>
<p>Embedded assemblies use a logical name pattern:</p>
<pre><code>DBTools.EmbeddedAssemblies.{AssemblyName}.dll
</code></pre>
<p>For example:</p>
<ul>
<li><code>DBTools.EmbeddedAssemblies.Serilog.dll</code></li>
<li><code>DBTools.EmbeddedAssemblies.DBTools.Core.dll</code></li>
</ul>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
  &lt;_EmbedLogical Include=&quot;@(_EmbedIdentity-&gt;'DBTools.EmbeddedAssemblies.%(Name).dll')&quot;&gt;
    &lt;SourcePath&gt;%(OriginalItemSpec)&lt;/SourcePath&gt;
  &lt;/_EmbedLogical&gt;
  &lt;EmbeddedResource Include=&quot;%(_EmbedLogicalDistinct.SourcePath)&quot;
                    LogicalName=&quot;%(_EmbedLogicalDistinct.Identity)&quot; /&gt;
&lt;/ItemGroup&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:262-268</code></p>
</blockquote>
<h3 id="exclusions-from-embedding">Exclusions from Embedding</h3>
<p><strong>Revit-provided assemblies (never copy/embed):</strong></p>
<pre><code class="lang-xml">&lt;_EmbedCandidate Remove=&quot;@(_EmbedCandidate)&quot;
                 Condition=&quot;'%(Filename)%(Extension)' == 'RevitAPI.dll'&quot; /&gt;
&lt;_EmbedCandidate Remove=&quot;@(_EmbedCandidate)&quot;
                 Condition=&quot;'%(Filename)%(Extension)' == 'Newtonsoft.Json.dll'&quot; /&gt;
</code></pre>
<p><strong>WPF theme assemblies (need file Location):</strong></p>
<pre><code class="lang-xml">&lt;_EmbedCandidate Remove=&quot;@(_EmbedCandidate)&quot;
                 Condition=&quot;$([System.String]::Copy('%(Filename)').StartsWith('DBTools.Fluent.Ribbon'))&quot; /&gt;
&lt;_EmbedCandidate Remove=&quot;@(_EmbedCandidate)&quot;
                 Condition=&quot;$([System.String]::Copy('%(Filename)').StartsWith('DBTools.ControlzEx'))&quot; /&gt;
&lt;_EmbedCandidate Remove=&quot;@(_EmbedCandidate)&quot;
                 Condition=&quot;$([System.String]::Copy('%(Filename)').StartsWith('DBTools.Themes'))&quot; /&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:241-251</code></p>
</blockquote>
<hr>
<h2 id="runtime-assembly-resolution">Runtime Assembly Resolution</h2>
<h3 id="embeddedassemblyresolver">EmbeddedAssemblyResolver</h3>
<p>The resolver is installed early during add-in startup:</p>
<pre><code class="lang-csharp">public static void Install(Assembly mainAssembly, string? deployedDir = null)
{
    // ...
#if NET8_0_OR_GREATER
    var alc = AssemblyLoadContext.GetLoadContext(mainAssembly) ?? AssemblyLoadContext.Default;
    alc.Resolving += (context, name) =&gt; ResolveNet8(context, mainAssembly, name);
#else
    AppDomain.CurrentDomain.AssemblyResolve += (_, args) =&gt; Resolve(mainAssembly, args.Name);
#endif
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:24-38</code></p>
</blockquote>
<h3 id="resolution-flow-net48">Resolution Flow (net48)</h3>
<pre><code>Assembly requested (e.g., &quot;Serilog&quot;)
        |
        v
1. Already loaded in AppDomain?
   YES -&gt; Return existing (prevents duplicates)
        |
        v
2. Try embedded resource: &quot;DBTools.EmbeddedAssemblies.Serilog.dll&quot;
   FOUND -&gt; Assembly.Load(bytes)
        |
        v
3. Check if merged via ILRepack (TryGetMergedAssembly)
   MERGED -&gt; Return mainAssembly
        |
        v
4. DBTools.* namespace? Try file-based fallbacks
   FOUND -&gt; Assembly.LoadFrom(path)
        |
        v
5. Return null (let CLR handle)
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:40-95</code></p>
</blockquote>
<h3 id="merged-assembly-detection-net48">Merged Assembly Detection (net48)</h3>
<p>For ILRepack'd assemblies, the resolver returns the main assembly:</p>
<pre><code class="lang-csharp">private static Assembly? TryGetMergedAssembly(Assembly mainAssembly, string requestedName)
{
    // WPF themes NOT merged
    if (requestedName.Equals(&quot;DBTools.Fluent.Ribbon&quot;, ...) ||
        requestedName.Equals(&quot;DBTools.ControlzEx&quot;, ...) ||
        requestedName.Equals(&quot;DBTools.Themes&quot;, ...) ||
        requestedName.Equals(&quot;DBTools.Loader&quot;, ...))
        return null;

    // DBTools.Core is merged
    if (requestedName.Equals(&quot;DBTools.Core&quot;, ...))
        return mainAssembly;

    // Other merged deps
    if (requestedName.StartsWith(&quot;Serilog&quot;, ...) ||
        requestedName.StartsWith(&quot;Microsoft.Extensions&quot;, ...) ||
        requestedName.Equals(&quot;YamlDotNet&quot;, ...))
        return mainAssembly;

    return null;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:223-263</code></p>
</blockquote>
<h3 id="resolution-flow-net8">Resolution Flow (net8)</h3>
<pre><code class="lang-csharp">private static Assembly? ResolveNet8(AssemblyLoadContext alc, Assembly mainAssembly, AssemblyName requested)
{
    // 1. Already loaded? Return it
    var alreadyLoaded = alc.Assemblies.FirstOrDefault(...);
    if (alreadyLoaded != null) return alreadyLoaded;

    // 2. Try embedded resource
    var resourceName = ResourcePrefix + requestedName + &quot;.dll&quot;;
    using var stream = mainAssembly.GetManifestResourceStream(resourceName);
    if (stream != null)
    {
        return alc.LoadFromStream(ms);  // Load into same ALC
    }

    // 3. File-based fallbacks for WPF assemblies
    return TryLoadFromFileFallbacksNet8(alc, mainAssembly, requestedName);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:146-189</code></p>
</blockquote>
<hr>
<h2 id="wpf-theme-assemblies-why-they-stay-separate">WPF Theme Assemblies: Why They Stay Separate</h2>
<h3 id="the-pack-uri-problem">The pack:// URI Problem</h3>
<p>WPF's XAML parser uses <code>pack://</code> URIs to locate resources within assemblies:</p>
<pre><code class="lang-xml">&lt;ResourceDictionary Source=&quot;pack://application:,,,/DBTools.Fluent.Ribbon;component/Themes/Generic.xaml&quot; /&gt;
</code></pre>
<p>The parser uses <code>Assembly.Location</code> to resolve these URIs. Assemblies loaded from byte arrays have <code>Location = &quot;&quot;</code>, breaking resource lookup.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:93-94</code>, <code>csharp/src/DBTools.App/DBTools.App.csproj:244-251</code></p>
</blockquote>
<h3 id="which-assemblies-need-file-location">Which Assemblies Need File Location</h3>
<table>
<thead>
<tr>
<th>Assembly</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DBTools.Fluent.Ribbon</code></td>
<td>Contains BAML for ribbon controls</td>
</tr>
<tr>
<td><code>DBTools.ControlzEx</code></td>
<td>Contains BAML for window behaviors</td>
</tr>
<tr>
<td><code>DBTools.HandyControl</code></td>
<td>Contains BAML for HandyControl widgets</td>
</tr>
<tr>
<td><code>DBTools.Themes</code></td>
<td>Contains merged theme dictionaries</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:53-57</code></p>
</blockquote>
<h3 id="file-based-resolution-fallbacks">File-Based Resolution Fallbacks</h3>
<p>For WPF assemblies, the resolver tries file-based loading:</p>
<pre><code class="lang-csharp">private static Assembly? TryLoadFromFileFallbacks(Assembly mainAssembly, string requestedName)
{
    // 1. Check %APPDATA%/DBTools/vendor/&lt;type&gt;/&lt;tfm&gt;/
    var appDataPath = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        &quot;DBTools&quot;, &quot;vendor&quot;, vendorType, vendorTfm, dllName);
    if (File.Exists(appDataPath))
        return Assembly.LoadFrom(appDataPath);

    // 2. Check deployed directory (next to DBTools.Loader.dll)
    return TryLoadFromDeployedDir(deployedDir, dllName);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:101-129</code></p>
</blockquote>
<hr>
<h2 id="preloading-critical-assemblies-net48">Preloading Critical Assemblies (net48)</h2>
<h3 id="the-gac-problem">The GAC Problem</h3>
<p>On net48, <code>AssemblyResolve</code> only fires when an assembly CAN'T be found. If an older version exists in the GAC or was loaded by another add-in, the CLR uses it instead of asking our resolver.</p>
<h3 id="solution-preload-during-startup">Solution: Preload During Startup</h3>
<p>Before any code uses these assemblies, <code>DBTools.Loader</code> preloads them from embedded resources:</p>
<pre><code class="lang-csharp">#if !NET8_0_OR_GREATER
    PreloadEmbeddedConfigurationAssemblies(assembly);
    PreloadEmbeddedSerilogAssemblies(assembly);
#endif
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:25-28</code></p>
</blockquote>
<h3 id="configuration-assembly-preload">Configuration Assembly Preload</h3>
<pre><code class="lang-csharp">private static void PreloadEmbeddedConfigurationAssemblies(Assembly mainAssembly)
{
    var configAssemblies = new[]
    {
        &quot;Microsoft.Extensions.Primitives&quot;,
        &quot;Microsoft.Extensions.FileProviders.Abstractions&quot;,
        &quot;Microsoft.Extensions.FileProviders.Physical&quot;,
        &quot;Microsoft.Extensions.Configuration.Abstractions&quot;,
        &quot;Microsoft.Extensions.Configuration&quot;,
        &quot;Microsoft.Extensions.Configuration.FileExtensions&quot;,
        &quot;Microsoft.Extensions.Configuration.Json&quot;,
        &quot;Microsoft.Extensions.Configuration.Binder&quot;
    };

    foreach (var name in configAssemblies)
    {
        var alreadyLoaded = GetLoadedAssemblyBySimpleName(name);
        if (alreadyLoaded != null) continue;

        var resourceName = &quot;DBTools.EmbeddedAssemblies.&quot; + name + &quot;.dll&quot;;
        using (var stream = mainAssembly.GetManifestResourceStream(resourceName))
        {
            if (stream == null) continue;
            using (var ms = new MemoryStream())
            {
                stream.CopyTo(ms);
                Assembly.Load(ms.ToArray());
            }
        }
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:109-143</code></p>
</blockquote>
<h3 id="serilog-assembly-preload">Serilog Assembly Preload</h3>
<p>Critical: Dependencies must be loaded BEFORE dependents:</p>
<pre><code class="lang-csharp">var serilogAssemblies = new[]
{
    // 1. Base abstractions first
    &quot;Microsoft.Extensions.Logging.Abstractions&quot;,
    &quot;Microsoft.Extensions.DependencyInjection.Abstractions&quot;,

    // 2. M.E.Logging (depends on Abstractions)
    &quot;Microsoft.Extensions.Logging&quot;,

    // 3. Serilog core
    &quot;Serilog&quot;,

    // 4. Serilog extensions (depend on above)
    &quot;Serilog.Extensions.Logging&quot;,
    &quot;Serilog.Enrichers.Thread&quot;,
    &quot;Serilog.Sinks.File&quot;
};
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:150-170</code></p>
</blockquote>
<hr>
<h2 id="forbidden-host-assemblies">Forbidden Host Assemblies</h2>
<h3 id="build-time-guardrails">Build-Time Guardrails</h3>
<p>The build prevents certain assemblies from landing in output:</p>
<pre><code class="lang-xml">&lt;ItemGroup&gt;
  &lt;ForbiddenHostAssembly Include=&quot;RevitAPI.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;RevitAPIUI.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;AdWindows.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;UIFramework.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;Newtonsoft.Json.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;System.Runtime.dll&quot; /&gt;
  &lt;ForbiddenHostAssembly Include=&quot;System.ObjectModel.dll&quot; /&gt;
&lt;/ItemGroup&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:169-177</code></p>
</blockquote>
<h3 id="automatic-cleanup">Automatic Cleanup</h3>
<p>A build target removes forbidden assemblies if transitive dependencies copied them:</p>
<pre><code class="lang-xml">&lt;Target Name=&quot;DBT_RemoveForbiddenAfterCopy&quot;
        AfterTargets=&quot;CopyFilesToOutputDirectory&quot;
        BeforeTargets=&quot;FailIfHostAssembliesInOutput&quot;&gt;
  &lt;Delete Files=&quot;@(_DBT_ForbiddenToClear)&quot; /&gt;
&lt;/Target&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:181-196</code></p>
</blockquote>
<h3 id="build-failure-on-violation">Build Failure on Violation</h3>
<p>If any forbidden assemblies remain after cleanup, the build fails:</p>
<pre><code class="lang-xml">&lt;Target Name=&quot;FailIfHostAssembliesInOutput&quot;&gt;
  &lt;Error Text=&quot;Forbidden host assemblies detected in output: @(_ForbiddenInOutput).&quot;
         Condition=&quot;'@(_ForbiddenInOutput)' != ''&quot; /&gt;
&lt;/Target&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:198-211</code></p>
</blockquote>
<hr>
<h2 id="summary-what-goes-where">Summary: What Goes Where</h2>
<table>
<thead>
<tr>
<th>Assembly Type</th>
<th>net48</th>
<th>net8.0-windows</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td>DBTools.Core</td>
<td>ILRepack merged</td>
<td>Embedded resource</td>
<td>Inside DBTools.dll</td>
</tr>
<tr>
<td>Serilog.*</td>
<td>ILRepack merged</td>
<td>Embedded resource</td>
<td>Inside DBTools.dll</td>
</tr>
<tr>
<td>M.E.DI/Config</td>
<td>ILRepack merged</td>
<td>Embedded resource</td>
<td>Inside DBTools.dll</td>
</tr>
<tr>
<td>YamlDotNet</td>
<td>ILRepack merged</td>
<td>Embedded resource</td>
<td>Inside DBTools.dll</td>
</tr>
<tr>
<td>ricaun.Revit.*</td>
<td>Embedded resource</td>
<td>Embedded resource</td>
<td>Inside DBTools.dll</td>
</tr>
<tr>
<td>DBTools.Themes</td>
<td>Separate file</td>
<td>Separate file</td>
<td>Next to DBTools.dll</td>
</tr>
<tr>
<td>DBTools.Fluent.Ribbon</td>
<td>Separate file</td>
<td>Separate file</td>
<td>Next to DBTools.dll</td>
</tr>
<tr>
<td>DBTools.ControlzEx</td>
<td>Separate file</td>
<td>Separate file</td>
<td>Next to DBTools.dll</td>
</tr>
<tr>
<td>DBTools.HandyControl</td>
<td>Separate file</td>
<td>Separate file</td>
<td>Next to DBTools.dll</td>
</tr>
<tr>
<td>DBTools.Loader</td>
<td>Separate file</td>
<td>Separate file</td>
<td>Next to DBTools.dll</td>
</tr>
<tr>
<td>RevitAPI/UI</td>
<td>Never copied</td>
<td>Never copied</td>
<td>Revit provides</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="issue-type-x-not-found-or-method-y-not-found">Issue: &quot;Type X not found&quot; or &quot;Method Y not found&quot;</h3>
<p><strong>Cause:</strong> Assembly version mismatch - another add-in loaded a different version first.</p>
<p><strong>Solutions:</strong></p>
<ol>
<li>Ensure dependencies are embedded or merged</li>
<li>Check if the assembly is in <code>keepSeparate</code> whitelist unnecessarily</li>
<li>Preload the assembly during startup</li>
</ol>
<h3 id="issue-wpf-resource-not-found-pack-uri-failure">Issue: WPF resource not found (pack:// URI failure)</h3>
<p><strong>Cause:</strong> WPF assembly loaded from bytes instead of file.</p>
<p><strong>Solutions:</strong></p>
<ol>
<li>Ensure WPF assemblies are in <code>keepSeparate</code> whitelist</li>
<li>Verify DLLs are deployed next to <code>DBTools.Loader.dll</code></li>
<li>Check <code>EmbeddedAssemblyResolver</code> file fallback paths</li>
</ol>
<h3 id="issue-ilrepack-crash-or-corrupted-il">Issue: ILRepack crash or corrupted IL</h3>
<p><strong>Cause:</strong> Some assemblies have IL that ILRepack can't process.</p>
<p><strong>Solutions:</strong></p>
<ol>
<li>Add to <code>keepSeparatePrefixes</code> to exclude from merge</li>
<li>Embed as resource instead of merging</li>
<li>Check ILRepack version compatibility</li>
</ol>
<h3 id="issue-duplicate-type-definitions-after-merge">Issue: Duplicate type definitions after merge</h3>
<p><strong>Cause:</strong> Multiple assemblies define the same polyfill type.</p>
<p><strong>Solution:</strong> ILRepack <code>/allowdup</code> flag handles this:</p>
<pre><code class="lang-csharp">args.Append(&quot;/allowdup &quot;);  // Handle duplicate polyfill types
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/BuildMerging.cs:131</code></p>
</blockquote>
<hr>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="overview.html">Architecture Overview</a> - High-level system architecture</li>
<li><a href="project-references.html">Project References</a> - How projects reference each other</li>
<li><a href="build-pipeline.html">Build Pipeline</a> - Build system details</li>
<li><a href="../projects/loader.html">DBTools.Loader</a> - Assembly loading at runtime</li>
</ul>
<hr>
<h2 id="verification-status">Verification Status</h2>
<table>
<thead>
<tr>
<th>Check</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source anchors for all claims</td>
<td>Yes</td>
</tr>
<tr>
<td>UNVERIFIED markers where needed</td>
<td>No (all verified)</td>
</tr>
<tr>
<td>Cross-references added</td>
<td>Yes</td>
</tr>
<tr>
<td>Examples tested</td>
<td>N/A</td>
</tr>
<tr>
<td>No assumptions without evidence</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Verified by:</strong> docs-run-20260124-020412<br>
<strong>Date:</strong> 2026-01-24</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/architecture/ilrepack-embedding.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
