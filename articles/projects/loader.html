<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>DBTools.Loader | DBTools Developer Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="DBTools.Loader | DBTools Developer Documentation ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/projects/loader.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="conceptual" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../images/logo.png" alt="DBTools">
            DBTools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="dbtoolsloader">DBTools.Loader</h1>

<!-- STATUS: draft -->
<!-- Last Updated: 2026-01-24 -->
<!-- Verified By: docs-run-20260124-020412 -->
<p><strong>Purpose:</strong> Revit entry point assembly that bootstraps DBTools.<br>
<strong>Output:</strong> <code>DBTools.Loader.dll</code><br>
<strong>Target Frameworks:</strong> <code>net48</code>, <code>net8.0-windows</code></p>
<hr>
<h2 id="overview">Overview</h2>
<p><code>DBTools.Loader</code> is the critical bootstrap component that Revit loads directly via the <code>.addin</code> manifest. Its sole responsibility is to load <code>DBTools.dll</code> (the main application assembly) and install the assembly resolver infrastructure that handles embedded dependencies.</p>
<p>This project is intentionally minimal to reduce startup failure risk. All application logic lives in <code>DBTools.App</code>; the loader exists only to:</p>
<ol>
<li>Find and load <code>DBTools.dll</code></li>
<li>Install the <code>EmbeddedAssemblyResolver</code></li>
<li>Forward Revit lifecycle calls to <code>DBTools.App.AddinEntry</code></li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:13-47</code></p>
</blockquote>
<hr>
<h2 id="responsibilities">Responsibilities</h2>
<table>
<thead>
<tr>
<th>Responsibility</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Revit entry point</td>
<td><code>IExternalApplication</code> implementation with <code>[AppLoader]</code> attribute</td>
</tr>
<tr>
<td>Load main assembly</td>
<td><code>LoadMainAssembly()</code> loads <code>DBTools.dll</code> from deployed directory</td>
</tr>
<tr>
<td>Install assembly resolver</td>
<td><code>EmbeddedAssemblyResolver.Install()</code> handles runtime resolution</td>
</tr>
<tr>
<td>Pre-load critical assemblies</td>
<td>net48 only: Configuration and Serilog assemblies pre-loaded to beat GAC</td>
</tr>
<tr>
<td>Forward lifecycle</td>
<td><code>OnStartup</code>/<code>OnShutdown</code> delegated to inner <code>DBTools.App.AddinEntry</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:17-47</code></p>
</blockquote>
<hr>
<h2 id="key-components">Key Components</h2>
<h3 id="addinentry-revit-entry-point">AddinEntry (Revit Entry Point)</h3>
<p>The <code>AddinEntry</code> class is the Revit-facing entry point. It implements <code>IExternalApplication</code> and is decorated with <code>[AppLoader]</code> from ricaun.Revit.UI for enhanced loading behavior.</p>
<pre><code class="lang-csharp">[AppLoader]
public sealed class AddinEntry : IExternalApplication
{
    private IExternalApplication? _inner;

    public Result OnStartup(UIControlledApplication application)
    {
        // Bootstrap sequence here...
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:12-14</code></p>
</blockquote>
<p><strong>Key Fields:</strong></p>
<ul>
<li><code>_inner</code>: Stores the instantiated <code>DBTools.App.AddinEntry</code> for forwarding lifecycle calls</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:15</code></p>
</blockquote>
<h3 id="embeddedassemblyresolver">EmbeddedAssemblyResolver</h3>
<p>Static class that installs hooks into the CLR's assembly resolution mechanism. Handles loading dependencies from embedded resources within <code>DBTools.dll</code>.</p>
<pre><code class="lang-csharp">internal static class EmbeddedAssemblyResolver
{
    private const string ResourcePrefix = &quot;DBTools.EmbeddedAssemblies.&quot;;
    private static int _installed;
    private static string? _deployedDir;

    public static void Install(Assembly mainAssembly, string? deployedDir = null)
    {
        // Installs AssemblyResolve (net48) or ALC.Resolving (net8) handler
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:14-38</code></p>
</blockquote>
<h3 id="loadercompat">LoaderCompat</h3>
<p>Provides cross-TFM compatibility utilities for the loader. Abstracts differences between .NET Framework and .NET 8.</p>
<pre><code class="lang-csharp">internal static class LoaderCompat
{
    internal static string VendorTfm =&gt;
#if NET8_0_OR_GREATER
        &quot;net8.0-windows&quot;;
#else
        &quot;net48&quot;;
#endif

    internal static Assembly LoadAssemblyFromPath(string path)
    {
#if NET8_0_OR_GREATER
        return AssemblyLoadContext.Default.LoadFromAssemblyPath(path);
#else
        return Assembly.LoadFrom(path);
#endif
    }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Compat/LoaderCompat.cs:10-35</code></p>
</blockquote>
<hr>
<h2 id="bootstrap-sequence">Bootstrap Sequence</h2>
<h3 id="onstartup-flow">OnStartup Flow</h3>
<p>The complete startup sequence with line numbers:</p>
<pre><code>1. Validate application parameter
   &gt; Source: AddinEntry.cs:19

2. Get deployed directory (where DBTools.Loader.dll lives)
   &gt; Source: AddinEntry.cs:21

3. Load DBTools.dll from deployed directory
   &gt; Source: AddinEntry.cs:22

4. Verify embedded payload is present
   &gt; Source: AddinEntry.cs:23

5. Install EmbeddedAssemblyResolver
   &gt; Source: AddinEntry.cs:24

6. [net48 only] Pre-load Configuration assemblies
   &gt; Source: AddinEntry.cs:26

7. [net48 only] Pre-load Serilog assemblies
   &gt; Source: AddinEntry.cs:27

8. Resolve DBTools.App.AddinEntry type via reflection
   &gt; Source: AddinEntry.cs:30-31

9. Create instance of DBTools.App.AddinEntry
   &gt; Source: AddinEntry.cs:33-34

10. Store instance and forward OnStartup call
    &gt; Source: AddinEntry.cs:36-37
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:17-38</code></p>
</blockquote>
<h3 id="sequence-diagram">Sequence Diagram</h3>
<pre><code>Revit                    DBTools.Loader           DBTools.dll (DBTools.App)
  |                            |                           |
  |--OnStartup(app)-----------&gt;|                           |
  |                            |                           |
  |                      GetDeployedDirectory()            |
  |                      LoadMainAssembly()                |
  |                            |--------load--------------&gt;|
  |                            |                           |
  |                      EnsureEmbeddedPayloadPresent()    |
  |                      EmbeddedAssemblyResolver.Install()|
  |                            |                           |
  |                      [net48: PreloadEmbedded*()]       |
  |                            |                           |
  |                      Activator.CreateInstance()-------&gt;|
  |                            |                           |
  |                            |------OnStartup(app)------&gt;|
  |                            |                           |
  |&lt;-------Result.Succeeded----|&lt;-------Result-------------|
</code></pre>
<hr>
<h2 id="assembly-loading-strategy">Assembly Loading Strategy</h2>
<h3 id="net48-strategy-ilrepack--embedded">net48 Strategy (ILRepack + Embedded)</h3>
<p>On .NET Framework 4.8, dependencies are handled via two mechanisms:</p>
<p><strong>1. ILRepack (Merged into DBTools.dll):</strong></p>
<ul>
<li>DBTools.Core</li>
<li>Serilog, Microsoft.Extensions.<em>, YamlDotNet, System.</em> polyfills</li>
<li>These types exist directly in DBTools.dll; no resolution needed</li>
</ul>
<p><strong>2. Embedded Resources (for ricaun.Revit.*):</strong></p>
<ul>
<li>Stored as <code>DBTools.EmbeddedAssemblies.&lt;name&gt;.dll</code></li>
<li>Loaded via <code>Assembly.Load(byte[])</code> at runtime</li>
<li>ILRepack corrupts some IL, so these stay as resources</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:223-263</code></p>
</blockquote>
<p><strong>3. Pre-loaded Assemblies:</strong></p>
<p>Configuration assemblies are pre-loaded before any code uses them to ensure DBTools' versions load before GAC/Revit's conflicting versions:</p>
<pre><code class="lang-csharp">var configAssemblies = new[]
{
    &quot;Microsoft.Extensions.Primitives&quot;,
    &quot;Microsoft.Extensions.FileProviders.Abstractions&quot;,
    &quot;Microsoft.Extensions.FileProviders.Physical&quot;,
    &quot;Microsoft.Extensions.Configuration.Abstractions&quot;,
    &quot;Microsoft.Extensions.Configuration&quot;,
    &quot;Microsoft.Extensions.Configuration.FileExtensions&quot;,
    &quot;Microsoft.Extensions.Configuration.Json&quot;,
    &quot;Microsoft.Extensions.Configuration.Binder&quot;
};
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:111-121</code></p>
</blockquote>
<p>Serilog assemblies are also pre-loaded in dependency order:</p>
<pre><code class="lang-csharp">var serilogAssemblies = new[]
{
    &quot;Microsoft.Extensions.Logging.Abstractions&quot;,
    &quot;Microsoft.Extensions.DependencyInjection.Abstractions&quot;,
    &quot;Microsoft.Extensions.Logging&quot;,
    &quot;Serilog&quot;,
    &quot;Serilog.Extensions.Logging&quot;,
    &quot;Serilog.Enrichers.Thread&quot;,
    &quot;Serilog.Sinks.File&quot;
};
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:154-170</code></p>
</blockquote>
<p><strong>Why Pre-load?</strong></p>
<p>On net48, <code>AssemblyResolve</code> only fires when an assembly <em>cannot</em> be found. If the GAC or another add-in already loaded a different version, our resolver never runs. Pre-loading ensures our versions are loaded first.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:104-108</code></p>
</blockquote>
<h3 id="net80-windows-strategy-all-embedded">net8.0-windows Strategy (All Embedded)</h3>
<p>On .NET 8, all dependencies are embedded as resources and loaded via <code>AssemblyLoadContext</code>:</p>
<pre><code class="lang-csharp">alc.Resolving += (context, name) =&gt; ResolveNet8(context, mainAssembly, name);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:33-34</code></p>
</blockquote>
<p>Resolution loads from embedded resources via stream:</p>
<pre><code class="lang-csharp">using var stream = mainAssembly.GetManifestResourceStream(resourceName);
if (stream != null)
{
    using var ms = new MemoryStream();
    stream.CopyTo(ms);
    ms.Position = 0;
    return alc.LoadFromStream(ms);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:168-176</code></p>
</blockquote>
<h3 id="wpf-assembly-fallback">WPF Assembly Fallback</h3>
<p>WPF assemblies (Fluent.Ribbon, ControlzEx, HandyControl) cannot be embedded because they require <code>Assembly.Location</code> for <code>pack://</code> URI resolution. These are loaded from files:</p>
<p><strong>Search Order:</strong></p>
<ol>
<li><code>%APPDATA%/DBTools/vendor/&lt;type&gt;/&lt;tfm&gt;/</code> (traditional install)</li>
<li>Deployed directory (next to DBTools.Loader.dll)</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:101-129</code></p>
</blockquote>
<p><strong>Vendor Type Detection:</strong></p>
<pre><code class="lang-csharp">private static string? GetVendorTypeForAssembly(string requestedName)
{
    if (requestedName.StartsWith(&quot;DBTools.Fluent.Ribbon&quot;, ...))
        return &quot;fluentribbon&quot;;
    if (requestedName.Equals(&quot;DBTools.ControlzEx&quot;, ...))
        return &quot;controlzex&quot;;
    if (requestedName.Equals(&quot;DBTools.HandyControl&quot;, ...))
        return &quot;handycontrol&quot;;
    return null;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:134-143</code></p>
</blockquote>
<h3 id="duplicate-load-prevention">Duplicate Load Prevention</h3>
<p>Both resolution paths check for already-loaded assemblies first to prevent type identity mismatches:</p>
<pre><code class="lang-csharp">// Critical for ricaun.Revit.* which AppLoader may have already loaded
var alreadyLoaded = AppDomain.CurrentDomain.GetAssemblies()
    .FirstOrDefault(a =&gt; string.Equals(a.GetName().Name, requestedName, ...));
if (alreadyLoaded != null)
    return alreadyLoaded;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:50-61</code></p>
</blockquote>
<hr>
<h2 id="dependencies">Dependencies</h2>
<h3 id="nuget-packages">NuGet Packages</h3>
<table>
<thead>
<tr>
<th>Package</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ricaun.Revit.UI</td>
<td>Provides <code>[AppLoader]</code> attribute for enhanced Revit loading</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:20</code></p>
</blockquote>
<p><strong>Note:</strong> ricaun.Revit.UI is a compile-time dependency that ensures ricaun is loaded EARLY when Revit loads DBTools.Loader.dll. This is required for RevitTaskService to work correctly in DBTools.App.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:16-18</code></p>
</blockquote>
<h3 id="revit-api-references">Revit API References</h3>
<p>Conditional based on target framework:</p>
<p><strong>net48:</strong></p>
<pre><code class="lang-xml">&lt;Reference Include=&quot;RevitAPI&quot;&gt;
  &lt;HintPath&gt;$(REVIT2024_DIR)\RevitAPI.dll&lt;/HintPath&gt;
  &lt;Private&gt;false&lt;/Private&gt;
&lt;/Reference&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:23-34</code></p>
</blockquote>
<p><strong>net8.0-windows:</strong></p>
<pre><code class="lang-xml">&lt;Reference Include=&quot;RevitAPI&quot; Condition=&quot;'$(REVIT_NET8_DIR)'!=''&quot;&gt;
  &lt;HintPath&gt;$(REVIT_NET8_DIR)\RevitAPI.dll&lt;/HintPath&gt;
  &lt;Private&gt;false&lt;/Private&gt;
&lt;/Reference&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:36-47</code></p>
</blockquote>
<h3 id="runtime-dependencies">Runtime Dependencies</h3>
<ul>
<li><strong>DBTools.dll</strong> - Must be present in same directory as DBTools.Loader.dll</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:67-69</code></p>
</blockquote>
<hr>
<h2 id="error-handling">Error Handling</h2>
<h3 id="startup-errors">Startup Errors</h3>
<p>The loader has minimal error handling - it must either succeed or fail fast:</p>
<p><strong>Missing DBTools.dll:</strong></p>
<pre><code class="lang-csharp">if (!File.Exists(mainPath))
    throw new FileNotFoundException(&quot;DBTools.dll not found next to DBTools.Loader.dll.&quot;, mainPath);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:68-69</code></p>
</blockquote>
<p><strong>Missing Embedded Payload (net8 only):</strong></p>
<pre><code class="lang-csharp">var hasCore = Array.Exists(resources, r =&gt; 
    string.Equals(r, &quot;DBTools.EmbeddedAssemblies.DBTools.Core.dll&quot;, ...));
if (!hasCore)
{
    throw new InvalidOperationException(
        &quot;DBTools.dll is missing embedded dependencies...&quot;);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:89-96</code></p>
</blockquote>
<p><strong>Type Resolution Failure:</strong></p>
<pre><code class="lang-csharp">var type = assembly.GetType(&quot;DBTools.App.AddinEntry&quot;, throwOnError: true)
           ?? throw new InvalidOperationException(&quot;DBTools.App.AddinEntry type not found.&quot;);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:30-31</code></p>
</blockquote>
<h3 id="silent-failures-intentional">Silent Failures (Intentional)</h3>
<p>Pre-load failures during net48 startup are logged to Debug output but don't fail startup:</p>
<pre><code class="lang-csharp">catch (Exception ex)
{
    // Silent continue - the EmbeddedAssemblyResolver will handle on-demand loading
    System.Diagnostics.Debug.WriteLine($&quot;[DBTools.Loader] Preload failed for {name}: {ex.Message}&quot;);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:192-196</code></p>
</blockquote>
<p>This is acceptable because the EmbeddedAssemblyResolver can still load these assemblies on-demand if pre-loading fails.</p>
<hr>
<h2 id="build-configuration">Build Configuration</h2>
<h3 id="project-properties">Project Properties</h3>
<pre><code class="lang-xml">&lt;TargetFrameworks&gt;$(DBT_RevitTargetFrameworks)&lt;/TargetFrameworks&gt;
&lt;AssemblyName&gt;DBTools.Loader&lt;/AssemblyName&gt;
&lt;RootNamespace&gt;DBTools.Loader&lt;/RootNamespace&gt;
&lt;CopyLocalLockFileAssemblies&gt;true&lt;/CopyLocalLockFileAssemblies&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:3-13</code></p>
</blockquote>
<p><strong>CopyLocalLockFileAssemblies:</strong> Set to <code>true</code> to copy NuGet dependencies (ricaun) to output for AppLoader/Debug scenarios.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:13</code></p>
</blockquote>
<h3 id="suppressed-warnings">Suppressed Warnings</h3>
<pre><code class="lang-xml">&lt;NoWarn&gt;$(NoWarn);MSB3277&lt;/NoWarn&gt;
</code></pre>
<p>MSB3277 (assembly version conflicts) is suppressed because Revit host references surface unavoidable conflicts.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/DBTools.Loader.csproj:10-11</code></p>
</blockquote>
<hr>
<h2 id="file-structure">File Structure</h2>
<pre><code>csharp/src/DBTools.Loader/
+-- DBTools.Loader.csproj
+-- Addin/
|   +-- AddinEntry.cs          # IExternalApplication entry point
+-- AssemblyResolution/
|   +-- EmbeddedAssemblyResolver.cs  # Runtime assembly loading
+-- Compat/
    +-- LoaderCompat.cs        # Cross-TFM utilities
</code></pre>
<hr>
<h2 id="integration-with-apploader">Integration with AppLoader</h2>
<p>DBTools.Loader uses ricaun's <code>[AppLoader]</code> attribute which provides:</p>
<ul>
<li>Automatic Revit version detection</li>
<li>Enhanced error reporting</li>
<li>Integration with ricaun.RevitTest for automated testing</li>
</ul>
<p>The AppLoader may have already loaded shared assemblies (like ricaun.Revit.*). The resolver explicitly checks for already-loaded assemblies to prevent duplicate loading which would cause type identity mismatches.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:51-53</code></p>
</blockquote>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="dbtoolsdll-not-found-error">&quot;DBTools.dll not found&quot; Error</h3>
<p><strong>Cause:</strong> DBTools.dll is not in the same directory as DBTools.Loader.dll.</p>
<p><strong>Solution:</strong> Ensure the deployment copies both files together.</p>
<h3 id="missing-embedded-dependencies-error-net8">&quot;Missing embedded dependencies&quot; Error (net8)</h3>
<p><strong>Cause:</strong> DBTools.dll was built without the embedded assembly step.</p>
<p><strong>Solution:</strong> Rebuild using <code>bash csharp/build.sh BuildAll</code>.</p>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:93-96</code></p>
</blockquote>
<h3 id="assembly-resolution-failures">Assembly Resolution Failures</h3>
<p><strong>Symptoms:</strong> <code>FileNotFoundException</code> or <code>TypeLoadException</code> for dependency types.</p>
<p><strong>Diagnosis:</strong></p>
<ol>
<li>Check if the assembly is in embedded resources (<code>DBTools.EmbeddedAssemblies.&lt;name&gt;.dll</code>)</li>
<li>For WPF assemblies, check <code>%APPDATA%/DBTools/vendor/</code> or deployed directory</li>
<li>Enable assembly binding logging (<code>FUSLOGVW.exe</code>) on net48</li>
</ol>
<hr>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../architecture/overview.html">Architecture Overview</a> - High-level system architecture</li>
<li><a href="../architecture/project-references.html">Project References</a> - How projects relate</li>
<li><a href="core.html">DBTools.Core</a> - Core library documentation</li>
</ul>
<!-- UNVERIFIED: No .addin manifest file found in repository. The manifest is likely generated during deployment or stored elsewhere. -->
<hr>
<h2 id="verification-status">Verification Status</h2>
<table>
<thead>
<tr>
<th>Check</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source anchors for all claims</td>
<td>Yes</td>
</tr>
<tr>
<td>UNVERIFIED markers where needed</td>
<td>Yes (addin manifest)</td>
</tr>
<tr>
<td>Cross-references added</td>
<td>Yes</td>
</tr>
<tr>
<td>Examples tested</td>
<td>N/A</td>
</tr>
<tr>
<td>No assumptions without evidence</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Verified by:</strong> docs-run-20260124-020412<br>
<strong>Date:</strong> 2026-01-24</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/articles/projects/loader.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DBTools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
