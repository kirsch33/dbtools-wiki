<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Super Girt Tool (SGT) — Comprehensive Specification | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Super Girt Tool (SGT) — Comprehensive Specification | DB Tools ">
      
      
      <link rel="icon" href="../../../images/favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../../toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/tools/structural/sgt-spec.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../../public/main.js" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" src="../../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="super-girt-tool-sgt--comprehensive-specification">Super Girt Tool (SGT) — Comprehensive Specification</h1>

<blockquote>
<p><strong>Version</strong>: 1.0 (Merged)
<strong>Date</strong>: 2025-11-25
<strong>Supersedes</strong>: SGT Spec-Lock v13, SGT_Specification_2025-11-9_v6
<strong>Status</strong>: Normative</p>
</blockquote>
<p>This document consolidates all historical guidance, current specifications, and implementation requirements into a single, authoritative Super Girt Tool specification. It merges content from 15 historical documents and 4 current spec files.</p>
<hr>
<h2 id="part-1-core-principles">Part 1: Core Principles</h2>
<h3 id="11-single-strict-path">1.1 Single Strict Path</h3>
<ul>
<li><strong>Pipeline</strong>: Analyze → Configure (UI) → Preview → Plan → Write</li>
<li>No fallbacks, no silent failures, no vague heuristics</li>
<li>Fail fast and loud with typed exceptions and overlays</li>
<li>Catch only typed, expected errors at narrow boundaries; otherwise surface errors and stop</li>
</ul>
<h3 id="12-preview-purity">1.2 Preview Purity</h3>
<ul>
<li>Preview never mutates the document</li>
<li>Temporary instances for analysis/diagnostics are allowed</li>
<li>Preview reflects actual placement parameters</li>
</ul>
<h3 id="13-transactional-commit">1.3 Transactional Commit</h3>
<ul>
<li>Batch writes, isolate per-girt failures</li>
<li>Emit precise summary</li>
<li>Single metadata write at commit</li>
</ul>
<h3 id="14-spec-lock-supremacy">1.4 Spec-Lock Supremacy</h3>
<ul>
<li>Orientation, rotation, offsets, joins, end-gaps, tolerance gates, and view contracts are judged by the Spec-Lock rules</li>
<li>When in doubt, enforce the Spec-Lock constraints</li>
</ul>
<h3 id="15-agentsmd-compliance">1.5 AGENTS.md Compliance</h3>
<ul>
<li>No fallback routes</li>
<li>No silent failures</li>
<li>No stubs/placeholders in production paths</li>
<li>Delete dead code</li>
<li>Centralized error handling</li>
</ul>
<hr>
<h2 id="part-2-wall-anchored-frame">Part 2: Wall-Anchored Frame</h2>
<h3 id="21-right-handed-coordinate-system">2.1 Right-Handed Coordinate System</h3>
<p>The tool uses a <strong>single, unified right-handed wall frame</strong> throughout all services. No service may define its own coordinate system.</p>
<p><strong>Frame Definition (matches WallFrame.cs):</strong></p>
<ul>
<li><strong>Origin</strong>: Location curve start point − (bottom offset × BasisZ)</li>
<li><strong>BasisX</strong>: Along wall (tangent to location curve, typically horizontal)</li>
<li><strong>BasisY</strong>: Exterior normal (perpendicular to wall, pointing outward from interior, from <code>Wall.Orientation</code>)</li>
<li><strong>BasisZ</strong>: Vertical (building up, parallel to Revit world Z-axis)</li>
</ul>
<p><strong>Right-Hand Verification:</strong></p>
<ul>
<li>BasisZ = BasisX × BasisY</li>
</ul>
<p><strong>Orthonormality Checks:</strong></p>
<ul>
<li>|dot(X,Y)|, |dot(X,Z)|, |dot(Y,Z)| ≤ 1e-6</li>
<li>(BasisX × BasisY) · BasisZ ≥ 0.9999</li>
</ul>
<p><strong>NO OTHER coordinate systems should exist in SGT codebase.</strong> This frame is used for:</p>
<ul>
<li>Family calibration (face classification)</li>
<li>Orientation analysis (placement, seating checks)</li>
<li>Preview generation (geometry transforms)</li>
<li>All wall-relative computations</li>
</ul>
<h3 id="22-linked-wall-handling">2.2 Linked Wall Handling</h3>
<p>For linked walls:</p>
<ol>
<li>Read the linked wall's <code>Orientation</code> property and location curve endpoints</li>
<li>Apply <code>RevitLinkInstance.GetTotalTransform()</code> to transform into host-document coordinate space</li>
<li>The transformed orientation is guaranteed to be the normal vector from the target exterior plane</li>
<li>Store the transformation in the wall's domain object</li>
</ol>
<h3 id="23-single-frame-enforcement">2.3 Single Frame Enforcement</h3>
<p><strong>CRITICAL</strong>: The right-handed wall frame computed in §2.1 is the <strong>only</strong> transformation used throughout the entire tool. Any code that previously used a different coordinate system frame must be refactored to use this single transformation.</p>
<hr>
<h2 id="part-3-services-architecture">Part 3: Services Architecture</h2>
<h3 id="31-coordinate-system-service">3.1 Coordinate System Service</h3>
<p><strong>Single Source of Truth</strong> for wall coordinate system.</p>
<p><strong>Responsibilities:</strong></p>
<ol>
<li>Accept linked or host foundation wall element ID (from user selection or test function)</li>
<li>Read wall's <code>Orientation</code> property and location curve endpoints</li>
<li>Transform into host-document coordinate space</li>
<li>Compute and store the right-handed wall frame (Origin + BasisX/Y/Z)</li>
<li>Provide the Revit <code>Transform</code> object for use by all other services</li>
</ol>
<h3 id="32-wall-layer-service">3.2 Wall Layer Service</h3>
<p><strong>Responsibilities:</strong></p>
<ol>
<li>Examine target wall for compound structure</li>
<li>Select target layer using fallback logic:
<ul>
<li><strong>Primary</strong>: Most-exterior core layer with &quot;Structural&quot; checkbox enabled</li>
<li><strong>Fallback 1</strong>: Thickest layer</li>
<li><strong>Fallback 2</strong>: If multiple layers have same thickness, use most-exterior</li>
</ul>
</li>
<li>Store selected layer in wall domain object</li>
<li>Compute &quot;target layer offset&quot; — the offset from wall center (location curve) to exterior side of target layer</li>
<li>Populate UI layer dropdown with all layers, defaulting to selected layer</li>
</ol>
<h3 id="33-target-exterior-plane-service">3.3 Target Exterior Plane Service</h3>
<p><strong>Responsibilities:</strong></p>
<ol>
<li>Create Revit <code>Plane</code> object representing the <strong>Final Target Exterior Plane</strong></li>
<li>Construct <code>Frame()</code> object with:
<ul>
<li><strong>Origin</strong>: Wall frame origin + target layer offset + UI layer offset value (defaults to 0)</li>
<li><strong>Basis Vectors</strong>: From Coordinate System Service</li>
</ul>
</li>
<li>Keep plane updated when:
<ul>
<li>UI target layer combobox changes</li>
<li>UI layer offset textbox changes</li>
</ul>
</li>
<li>Create new / delete old plane as needed</li>
</ol>
<h3 id="34-calibration-service">3.4 Calibration Service</h3>
<p><strong>Single Source of Truth</strong> for identifying web and flange faces per family.</p>
<p><strong>High-Level Process:</strong></p>
<ol>
<li>Place temporary instance on target plane (arbitrary length/direction)</li>
<li>Extract geometry using <code>GetInstanceGeometry()</code> with Medium detail level</li>
<li>Strip end cap faces (faces perpendicular to member length)</li>
<li>Group remaining faces by area into bins:
<ul>
<li>Larger area bin → &quot;likely web faces&quot;</li>
<li>Smaller area bin → &quot;likely flange faces&quot;</li>
</ul>
</li>
<li>Within each bin, filter by normal vector orientation:
<ul>
<li>Discard faces whose normals aren't multiples of 90° from wall frame</li>
<li>Select largest area face per orientation bin</li>
</ul>
</li>
<li>Store face IDs in family domain object</li>
<li>Delete temp instance and rollback transaction</li>
</ol>
<p><strong>Notes:</strong></p>
<ul>
<li>Calibration runs <strong>once per family</strong> (not per type)</li>
<li>Type selection: prefer &quot;middle&quot; type if multiple exist</li>
<li>Face IDs are stable across instances of the same family</li>
</ul>
<h3 id="35-orientation-analysis-service">3.5 Orientation Analysis Service</h3>
<p><strong>Single Source of Truth</strong> for determining placement settings per family per role.</p>
<p><strong>Process (per family, per role):</strong></p>
<ol>
<li>Place temp instance on target plane with role-appropriate direction:
<ul>
<li>Girts/Heads/Sills: horizontal</li>
<li>Jambs: vertical</li>
</ul>
</li>
<li>Retrieve calibrated faces from Calibration Service</li>
<li>Find correct rotation by testing web face normal against expected direction</li>
<li>Identify correct flange face by checking normal matches exterior plane normal</li>
<li>Test Y justification options against <strong>flange gate</strong> OR <strong>web gate</strong>:
<ul>
<li><strong>Flange gate</strong>: BasisY distance from flange face point to target exterior plane ≈ 0</li>
<li><strong>Web gate (horizontal)</strong>: BasisZ distance from web face point to location curve ≈ 0</li>
<li><strong>Web gate (jambs)</strong>: BasisX distance from web face point to location curve ≈ 0</li>
</ul>
</li>
<li>Test Z justification for remaining gate</li>
<li>Store solved settings (rotation, Y-just, Z-just) in family domain object</li>
</ol>
<p><strong>Constraints:</strong></p>
<ul>
<li>Z-shapes: Only analyze for Girt role (hard block for opening roles)</li>
<li>Analysis runs per-family, per-role, but only one type per family</li>
</ul>
<hr>
<h2 id="part-4-role-contracts">Part 4: Role Contracts</h2>
<h3 id="41-role-axis-alignment">4.1 Role Axis Alignment</h3>
<table>
<thead>
<tr>
<th>Role</th>
<th>Length (L)</th>
<th>Depth (d)</th>
<th>Width/Flange (bf)</th>
<th>Flange Direction</th>
</tr>
</thead>
<tbody>
<tr>
<td>Girt</td>
<td>+BasisX</td>
<td>±BasisY</td>
<td>+BasisZ</td>
<td>Up</td>
</tr>
<tr>
<td>Head</td>
<td>+BasisX</td>
<td>±BasisY</td>
<td>+BasisZ</td>
<td>Up (away from opening)</td>
</tr>
<tr>
<td>Sill</td>
<td>+BasisX</td>
<td>±BasisY</td>
<td>−BasisZ</td>
<td>Down (away from opening)</td>
</tr>
<tr>
<td>Jamb_Left</td>
<td>+BasisZ</td>
<td>±BasisY</td>
<td>−BasisX</td>
<td>Away from opening</td>
</tr>
<tr>
<td>Jamb_Right</td>
<td>+BasisZ</td>
<td>±BasisY</td>
<td>+BasisX</td>
<td>Away from opening</td>
</tr>
</tbody>
</table>
<h3 id="42-seating-requirements-all-roles">4.2 Seating Requirements (All Roles)</h3>
<ul>
<li><strong>Exterior flange</strong>: Seats on the exterior wall plane (BasisY direction)</li>
<li><strong>Web seating by role</strong>:
<ul>
<li>Girt: Web on assigned elevation plane (horizontal)</li>
<li>Head: Web on opening top plane (horizontal)</li>
<li>Sill: Web on opening bottom plane (horizontal)</li>
<li>Jambs: Web on opening side planes (vertical left/right)</li>
</ul>
</li>
</ul>
<h3 id="43-corner-alignment">4.3 Corner Alignment</h3>
<ul>
<li>Corner = intersection of correct flange face and correct web face</li>
<li>Achieved automatically when both flange gate and web gate pass</li>
<li>No separate corner gate implementation needed</li>
</ul>
<h3 id="44-pointing-requirements">4.4 Pointing Requirements</h3>
<ul>
<li><strong>Girts/Heads</strong>: Point UP (web face normal points down)</li>
<li><strong>Sills</strong>: Point DOWN (web face normal points up)</li>
<li><strong>Jambs</strong>: Point AWAY from opening center (web face normal points toward opening)</li>
</ul>
<h3 id="45-special-shape-handling">4.5 Special Shape Handling</h3>
<p><strong>Z-Shapes:</strong></p>
<ul>
<li>Valid only for Girt role</li>
<li>Exterior flange down, interior side flange up</li>
<li><strong>Hard block</strong> for opening roles (heads/sills/jambs)</li>
</ul>
<p><strong>HSS Squares:</strong></p>
<ul>
<li>Width == depth degeneracy allowed</li>
<li>Alignment accepts symmetric case</li>
<li>Seating/pointing gates still apply</li>
</ul>
<h3 id="46-solid-geometry-placement">4.6 Solid Geometry Placement</h3>
<p>ALL elements must have their solid geometry placed on the <strong>interior side</strong> of the target exterior wall plane.</p>
<hr>
<h2 id="part-5-rotation--justification">Part 5: Rotation &amp; Justification</h2>
<h3 id="51-cross-section-rotation">5.1 Cross-Section Rotation</h3>
<ul>
<li>Also known as &quot;Structural Bend Dir Angle&quot;</li>
<li>Angle about member length axis (L)</li>
<li><strong>Constrained to k×90°</strong> within tolerance (mod 90° ≤ 1e-6°)</li>
<li>Non-multiple-of-90° rotations fail immediately</li>
</ul>
<h3 id="52-yz-justification">5.2 Y/Z Justification</h3>
<ul>
<li><strong>Y Justification</strong>: Controls lateral positioning (Left, Center, Right, Origin)</li>
<li><strong>Z Justification</strong>: Controls vertical positioning (Top, Middle, Bottom, Origin)</li>
<li>Family-dependent labels; validity determined by seating/corner gate outcomes</li>
<li>Labels are for UI display; actual values are numeric</li>
</ul>
<h3 id="53-zero-offsets-policy">5.3 Zero Offsets Policy</h3>
<p><strong>Hard Gate</strong>: Y/Z justification offset values = 0.000 ft</p>
<ul>
<li>Any non-zero offset fails with <code>[SpecFail/Offsets/NonZero]</code></li>
<li><strong>Clarification</strong>: &quot;Wall Offset&quot; (depth plane choice in UI) is independent and allowed</li>
<li>Wall Offset translates the placement plane along wall depth direction</li>
<li>Instance Y/Z justification offsets must remain exactly 0.0</li>
</ul>
<h3 id="54-parameter-update-ordering">5.4 Parameter Update Ordering</h3>
<p><strong>Per element, in order:</strong></p>
<ol>
<li>Place instance</li>
<li>Set Disallow Join at both ends</li>
<li>Apply negative Start/End Extensions for gaps</li>
<li>Validate spans (&gt; 6&quot;)</li>
<li>Commit</li>
</ol>
<hr>
<h2 id="part-6-uiux-flow">Part 6: UI/UX Flow</h2>
<h3 id="61-entry-points">6.1 Entry Points</h3>
<ul>
<li><strong>New Flow</strong>: &quot;Super Girt Tool&quot; ribbon button in DB Tools tab</li>
<li><strong>Edit Flow</strong>: Contextual button in &quot;Modify — Structural Framing&quot; tab when SGT metadata detected</li>
</ul>
<h3 id="62-new-flow-single-basis-wall">6.2 New Flow (Single Basis Wall)</h3>
<p><strong>Basis wall is singular.</strong> All analysis, seeding, previews, openings, and placement are anchored to one basis wall.</p>
<p><strong>Launch &amp; Prompt:</strong></p>
<ol>
<li>Yellow warning banner appears on launch</li>
<li>Prompt user to select <strong>either</strong> a linked model wall <strong>or</strong> a host foundation wall</li>
<li>Enforce single selection; reject multiple selections and non-wall types</li>
</ol>
<p><strong>Progress Overlay (4 Steps):</strong></p>
<ol>
<li><strong>Step 1: Calibration</strong> (0% → 100%)
<ul>
<li>Calibrate all structural framing families</li>
<li>Identify web faces and flange faces</li>
</ul>
</li>
<li><strong>Step 2: Orientation Analysis</strong> (0% → 100%)
<ul>
<li>Analyze each family for each role</li>
<li>Z-shapes only for Girt role</li>
</ul>
</li>
<li><strong>Step 3: 2D Profile Loop Extraction</strong> (0% → 100%)
<ul>
<li>Extract Medium-detail geometry loops</li>
<li>Sanitize (ordering, closure, tolerance-clean)</li>
</ul>
</li>
<li><strong>Step 4: Initial UI Seeding</strong> (0% → 100%)
<ul>
<li><strong>Default family</strong>: &quot;C Shapes&quot; / &quot;C10X15.3&quot;</li>
<li>Seed girt rows at ≤ 5'-0&quot; spacing</li>
<li>Seed opening rows from detected openings (Linked) or empty (Foundation)</li>
</ul>
</li>
</ol>
<p><strong>Auto-Seeding:</strong></p>
<ul>
<li><strong>Girts</strong>: ≤ 5'-0&quot; spacing with orientation-analyzed defaults</li>
<li><strong>Openings (Linked)</strong>: One row per detected opening; default enabled roles are computed from opening bounds vs wall bounds (no fixed &quot;Sill off&quot; default)</li>
<li><strong>Manual Openings</strong>: Available via &quot;Add Opening&quot; action</li>
</ul>
<p><strong>Plan Validity:</strong></p>
<ul>
<li>Plans may be <strong>openings-only</strong> (0 girts but ≥1 enabled opening role)</li>
<li>Place/Update are disabled only when the plan would place nothing</li>
</ul>
<p><strong>Reveal:</strong>
When analysis and seeding complete, overlay closes to reveal pre-populated grids and live previews.</p>
<h3 id="63-edit-flow-selection-aware">6.3 Edit Flow (Selection-Aware)</h3>
<p><strong>SelectionChanged Observer:</strong></p>
<ul>
<li>Monitor Revit selection for Structural Framing with SGT schema</li>
<li>Show &quot;Edit SGT Wall&quot; button on contextual tab when detected</li>
</ul>
<p><strong>Launch:</strong></p>
<ul>
<li>If multiple SystemIds present, open picker</li>
<li>Otherwise use single system</li>
</ul>
<p><strong>Rehydrate:</strong></p>
<ul>
<li>Run auto-analysis at open</li>
<li>Rehydrate UI from existing SGT System</li>
<li>Initial seeding rules do NOT apply in Edit</li>
</ul>
<h3 id="64-foundation-mode">6.4 Foundation Mode</h3>
<p><strong>Seeding Window:</strong></p>
<ul>
<li>From TOP of basis foundation wall upward 20'-0&quot;</li>
<li>Standard ≤ 5'-0&quot; spacing within this band</li>
</ul>
<p><strong>Openings:</strong></p>
<ul>
<li>NOT auto-seeded in Foundation Mode</li>
<li>Manual rows preview and place with full contracts</li>
</ul>
<p><strong>Height Above Top:</strong></p>
<ul>
<li>Acts as vertical reference when enabled</li>
</ul>
<h3 id="65-window-structure">6.5 Window Structure</h3>
<p><strong>Left Pane — Scope &amp; Config:</strong></p>
<ul>
<li>Exterior Plane &amp; Compound Layers (Linked Mode)</li>
<li>Wall Offset (depth-plane selection)</li>
<li>Foundation Mode + Height Above Top</li>
</ul>
<p><strong>Visibility by Flow:</strong></p>
<ul>
<li><strong>New</strong>: Place visible; Update/Remove hidden</li>
<li><strong>Edit</strong>: Place hidden; Update/Remove visible</li>
</ul>
<hr>
<h2 id="part-7-preview-system">Part 7: Preview System</h2>
<h3 id="71-common-contracts">7.1 Common Contracts</h3>
<ul>
<li>All three previews (Elevation, Section, 3D) derive from the same canonical, Revit-accurate element data</li>
<li>Elevation and Section are projections of the canonical data used by 3D</li>
<li>Previews stay synchronized with grids and UI state at all times</li>
</ul>
<h3 id="72-elevation-preview">7.2 Elevation Preview</h3>
<p><strong>Coordinate System:</strong></p>
<ul>
<li>u = +BasisX (along wall)</li>
<li>v = +BasisZ (vertical)</li>
</ul>
<p><strong>Rendering:</strong></p>
<ul>
<li>Draw bf-thickness bands from loop v-extents along L</li>
<li>Use trimmed L-span (grids/openings)</li>
<li>Enforce end gaps via negative extensions after Disallow Join</li>
<li>Horizontals must not intrude into jamb bf</li>
<li>Show grid extents overlay</li>
</ul>
<p><strong>Acceptance Gates:</strong></p>
<ul>
<li>bf-thickness bands correct</li>
<li>Horizontals segmented at openings</li>
<li>1/2&quot; end gaps at jamb interfaces</li>
<li>Disallow Join at both ends</li>
<li>Zero offsets</li>
</ul>
<h3 id="73-section-preview">7.3 Section Preview</h3>
<p><strong>Coordinate System:</strong></p>
<ul>
<li>u = +BasisY (depth / exterior normal)</li>
<li>v = +BasisZ (vertical)</li>
</ul>
<p><strong>Rendering:</strong></p>
<ul>
<li>Render Medium loops with EvenOdd fill</li>
<li>Anchor at L-axis ∩ section plane (or closest point if parallel)</li>
<li>No L-extrusion</li>
<li>Stroke presentation is guidance</li>
</ul>
<p><strong>Acceptance Gates:</strong></p>
<ul>
<li>Medium-detail loops rendered with EvenOdd</li>
<li>Oriented per (d, bf)</li>
<li>No L-extrusion</li>
<li>Strict axis-alignment by role</li>
</ul>
<h3 id="74-3d-preview">7.4 3D Preview</h3>
<p><strong>Rendering:</strong></p>
<ul>
<li>Mesh from canonical 3D element data</li>
<li>Two directional lights + ambient</li>
<li>Fixed 6&quot; (0.5 ft) floor plane</li>
<li>Role palette visible</li>
<li>Overlay legend</li>
<li>Interactive orbit/pan/zoom</li>
</ul>
<p><strong>Acceptance Gates:</strong></p>
<ul>
<li>No extra gates; 3D renders exactly the snapshot data</li>
<li>Issues are visually obvious</li>
</ul>
<hr>
<h2 id="part-8-endpoint-association-system">Part 8: Endpoint Association System</h2>
<h3 id="81-endpointassociation-value-object">8.1 EndpointAssociation Value Object</h3>
<p>Every segment endpoint must have an association that tracks what it connects to.</p>
<p><strong>Association Types:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Required Fields</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WallStart</code></td>
<td>Wall start (t=0)</td>
<td>None</td>
</tr>
<tr>
<td><code>WallEnd</code></td>
<td>Wall end (t=1)</td>
<td>None</td>
</tr>
<tr>
<td><code>Grid</code></td>
<td>Grid intersection</td>
<td>GridName, GridOffset</td>
</tr>
<tr>
<td><code>OpeningEdge</code></td>
<td>Opening edge</td>
<td>OpeningId, EdgeSide, EdgeOffset</td>
</tr>
<tr>
<td><code>FreeAlong</code></td>
<td>Free distance from wall start</td>
<td>AlongDistance</td>
</tr>
</tbody>
</table>
<p><strong>OpeningEdgeSide Values:</strong></p>
<ul>
<li>Left</li>
<li>Right</li>
<li>Top</li>
<li>Bottom</li>
</ul>
<h3 id="82-association-rules">8.2 Association Rules</h3>
<ul>
<li>All girt segments must have start and end associations defined</li>
<li>All opening elements must have endpoint associations</li>
<li>Associations drive:
<ul>
<li>Segment trimming calculations</li>
<li>Preview rendering coordinates</li>
<li>Placement coordinate determination</li>
</ul>
</li>
</ul>
<hr>
<h2 id="part-9-elevation-preview-snapping">Part 9: Elevation Preview Snapping</h2>
<h3 id="91-elevationsnapindex">9.1 ElevationSnapIndex</h3>
<p>Spatial index for O(log n) nearest-neighbor queries on snap targets.</p>
<p><strong>Indexed Targets:</strong></p>
<ul>
<li>Grids (sorted by t-parameter)</li>
<li>Opening edges (left/right, sorted by t-parameter)</li>
</ul>
<p><strong>Rebuild:</strong></p>
<ul>
<li>Called once per preview refresh</li>
<li>Before drag operations</li>
</ul>
<h3 id="92-ielevationsnapservice">9.2 IElevationSnapService</h3>
<p>Service for computing snap targets during drag operations.</p>
<p><strong>SnapInput Parameters:</strong></p>
<ul>
<li>Target t-parameter (0.0 to 1.0)</li>
<li>Pixels per unit t</li>
<li>Cursor position (X, Y in pixels)</li>
<li>DPI scale factor</li>
<li>Wall length in feet</li>
<li>Available grids and edges</li>
<li>AllowFreeAlong flag</li>
<li>ShiftStep flag (fine quantization)</li>
</ul>
<p><strong>SnapResult:</strong></p>
<ul>
<li>Snapped (bool): True if snapped to grid/edge</li>
<li>Kind: &quot;Grid&quot;, &quot;Edge&quot;, or &quot;Along&quot;</li>
<li>Name: Grid name or opening key</li>
<li>Side: Edge side (Left/Right)</li>
<li>T: Snapped t-parameter</li>
<li>DxPx: Pixel distance to snap target</li>
<li>AlongLabel: Label for free-along mode</li>
</ul>
<h3 id="93-snapping-behavior">9.3 Snapping Behavior</h3>
<p><strong>Priority:</strong></p>
<ol>
<li>Grid snapping (highest priority on ties)</li>
<li>Edge snapping</li>
<li>FreeAlong quantized snapping (fallback)</li>
</ol>
<p><strong>Thresholds:</strong></p>
<ul>
<li>Hit radius: 10px at 96 DPI baseline (DPI-scaled)</li>
<li>Snap threshold: 12px to commit to anchor</li>
<li>Epsilon for t-value comparisons: 1e-9</li>
</ul>
<p><strong>Quantization (FreeAlong mode):</strong></p>
<ul>
<li>Default step: 1/4&quot; (0.25/12 ft)</li>
<li>Fine step (Shift held): 1/8&quot; (0.125/12 ft)</li>
</ul>
<p><strong>Tie-Breakers:</strong></p>
<ul>
<li>Prefer grids over edges</li>
<li>Prefer smaller t on exact ties</li>
</ul>
<hr>
<h2 id="part-10-placement-system">Part 10: Placement System</h2>
<h3 id="101-disallow-join">10.1 Disallow Join</h3>
<ul>
<li>Must be set at <strong>both ends</strong> for <strong>all members</strong> (all roles)</li>
<li>Set <strong>before</strong> applying end extensions</li>
</ul>
<h3 id="102-end-extensions">10.2 End Extensions</h3>
<ul>
<li>Along-L edits are via Start/End Extensions only</li>
<li>Use <strong>negative values</strong> to shorten (not cutbacks)</li>
<li>Required 1/2&quot; end gaps at horizontal–jamb interfaces</li>
<li>Order: Set Disallow Join → Apply −1/2&quot; extensions</li>
</ul>
<h3 id="103-minimum-segment-length">10.3 Minimum Segment Length</h3>
<ul>
<li>Girt segments must be &gt; 6&quot; (0.5 ft)</li>
<li>Otherwise fail with <code>[SpecFail/Extents/TooShort]</code></li>
</ul>
<h3 id="104-opening-segmentation">10.4 Opening Segmentation</h3>
<ul>
<li>Horizontal members segment at openings</li>
<li>Compute intervals by subtracting opening spans from row extent</li>
<li>Gate by vertical intersection (row elevation vs opening height window)</li>
<li>Apply 1/2&quot; gaps at opening edges</li>
</ul>
<h3 id="105-placement-order">10.5 Placement Order</h3>
<p><strong>Per element:</strong></p>
<ol>
<li>Place instance(s)</li>
<li>Disallow Join at both ends</li>
<li>Apply negative Start/End Extensions for 1/2&quot; gaps at true intersections only</li>
<li>Validate minimum segment length</li>
<li>Commit</li>
</ol>
<h3 id="106-zero-offsets-enforcement">10.6 Zero Offsets Enforcement</h3>
<ul>
<li>Location curve represents logical L-span</li>
<li>Shortening via negative extensions only</li>
<li>No cutbacks</li>
<li>Hand/Face flips allowed if seating/axis outcomes remain valid</li>
</ul>
<hr>
<h2 id="part-11-metadata--storage">Part 11: Metadata &amp; Storage</h2>
<h3 id="111-extensible-storage-schema">11.1 Extensible Storage Schema</h3>
<p>All SGT instances carry schema fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Tag</code></td>
<td>&quot;SGT&quot;</td>
</tr>
<tr>
<td><code>SystemId</code></td>
<td>GUID string</td>
</tr>
<tr>
<td><code>ConfigJson</code></td>
<td>Role, vertical location, along-wall location, depth plane, etc.</td>
</tr>
<tr>
<td><code>WallCurveHash</code></td>
<td>Robust matching (1e-5 ft rounding, includes wall ID)</td>
</tr>
<tr>
<td><code>WallOffset</code></td>
<td>Depth offset value</td>
</tr>
<tr>
<td><code>Timestamp</code></td>
<td>Creation/modification time</td>
</tr>
<tr>
<td><code>Version</code></td>
<td>Schema version (&quot;13&quot;)</td>
</tr>
</tbody>
</table>
<h3 id="112-edit-round-trip">11.2 Edit Round-Trip</h3>
<p>Metadata enables:</p>
<ul>
<li>Selection-based detection</li>
<li>Edit launch</li>
<li>Reconciliation when host or openings change</li>
</ul>
<p><strong>Note</strong>: Initial seeding does NOT apply in Edit; system rehydrates from stored configuration.</p>
<p><strong>Openings-only</strong>:</p>
<ul>
<li>A stored system may have <code>0</code> girt rows as long as it has ≥1 enabled opening role; Edit/Update must still work end-to-end.</li>
</ul>
<h3 id="113-remove-system-flow">11.3 Remove System Flow</h3>
<p><strong>VM Command</strong>: <code>RemoveSystemCommand</code></p>
<p><strong>Implementation:</strong></p>
<ol>
<li>Show overlay &quot;Removing…&quot;</li>
<li>Call writer API to delete only elements tagged with current SystemId</li>
<li>Delete girts and all opening roles</li>
<li>Remove stored config from SgtConfigStore (host) and SgtLinkedConfigStore (linked)</li>
<li>Update overlay with result</li>
<li>Close window on success</li>
</ol>
<p><strong>Constraint</strong>: Does NOT affect other SGT systems; scoped deletion only.</p>
<hr>
<h2 id="part-12-error-handling">Part 12: Error Handling</h2>
<h3 id="121-specfail-tags">12.1 SpecFail Tags</h3>
<p>Recommended for logs/exceptions:</p>
<table>
<thead>
<tr>
<th>Tag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[SpecFail/RoleAxes/Mapping]</code></td>
<td>Axis alignment failure</td>
</tr>
<tr>
<td><code>[SpecFail/Offsets/NonZero]</code></td>
<td>Non-zero Y/Z offset detected</td>
</tr>
<tr>
<td><code>[SpecFail/Extents/TooShort]</code></td>
<td>Segment &lt; 6&quot;</td>
</tr>
<tr>
<td><code>[SpecFail/Writer/Acceptance]</code></td>
<td>No valid rotation/justification combination</td>
</tr>
<tr>
<td><code>[SpecFail/Writer/Basis]</code></td>
<td>Cannot determine flange face</td>
</tr>
<tr>
<td><code>[SpecFail/RightHand]</code></td>
<td>Non-right-handed rotation delta</td>
</tr>
</tbody>
</table>
<h3 id="122-tolerances">12.2 Tolerances</h3>
<table>
<thead>
<tr>
<th>Check</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alignment (dot product)</td>
<td>≥ 0.9999</td>
</tr>
<tr>
<td>Seating</td>
<td>≤ 1e-3 ft</td>
</tr>
<tr>
<td>Corner</td>
<td>≤ 1e-4 ft</td>
</tr>
<tr>
<td>Rotation</td>
<td>k×90° within 1e-6°</td>
</tr>
<tr>
<td>Minimum girt length</td>
<td>&gt; 6&quot; (0.5 ft)</td>
</tr>
<tr>
<td>T-parameter epsilon</td>
<td>1e-9</td>
</tr>
<tr>
<td>Distance epsilon (feet)</td>
<td>1e-6</td>
</tr>
</tbody>
</table>
<h3 id="123-logging-requirements">12.3 Logging Requirements</h3>
<ul>
<li>No silent failures</li>
<li>All errors surface via banner/overlay</li>
<li>Centralized error boundaries</li>
<li>No broad <code>catch(Exception)</code> unless at narrow per-element boundary with explicit message propagation</li>
</ul>
<hr>
<h2 id="part-13-window-initialization--progress-overlay">Part 13: Window Initialization &amp; Progress Overlay</h2>
<h3 id="131-overlay-display">13.1 Overlay Display</h3>
<p>On each window paint, display a <strong>4-step progress overlay</strong> that shows completion percentage for each step.</p>
<h3 id="132-step-1-calibration-0--100">13.2 Step 1: Calibration (0% → 100%)</h3>
<ul>
<li>Enumerate all structural framing families in document</li>
<li>For each family:
<ul>
<li>Place temporary instance</li>
<li>Extract geometry and identify web/flange faces</li>
<li>Store face IDs in family domain object</li>
<li>Delete temp instance</li>
</ul>
</li>
<li>Progress: <code>(completed families / total families) × 100%</code></li>
</ul>
<h3 id="133-step-2-orientation-analysis-0--100">13.3 Step 2: Orientation Analysis (0% → 100%)</h3>
<ul>
<li>For each calibrated family:
<ul>
<li>For each applicable role (Girt, Head, Sill, JambLeft, JambRight):
<ul>
<li>Skip opening roles for Z-shapes</li>
<li>Place temp instance with role-appropriate direction</li>
<li>Test rotation/justification combinations</li>
<li>Store solved settings</li>
</ul>
</li>
</ul>
</li>
<li>Progress: <code>(completed family-role pairs / total pairs) × 100%</code></li>
</ul>
<h3 id="134-step-3-2d-profile-loop-extraction-0--100">13.4 Step 3: 2D Profile Loop Extraction (0% → 100%)</h3>
<ul>
<li>For each calibrated family:
<ul>
<li>Extract Medium-detail geometry loops</li>
<li>Sanitize loops (ordering, closure, tolerance)</li>
<li>Cache for preview rendering</li>
</ul>
</li>
<li>Progress: <code>(completed families / total families) × 100%</code></li>
</ul>
<h3 id="135-step-4-initial-ui-seeding-0--100">13.5 Step 4: Initial UI Seeding (0% → 100%)</h3>
<p><strong>Default Family/Type:</strong></p>
<ul>
<li>Family: &quot;C Shapes&quot;</li>
<li>Type: &quot;C10X15.3&quot;</li>
<li>(Hardcoded for initial implementation)</li>
</ul>
<p><strong>Girt Seeding:</strong></p>
<ul>
<li>Calculate wall vertical extent</li>
<li>Seed rows at ≤ 5'-0&quot; spacing</li>
<li>Apply orientation analysis results for default family</li>
</ul>
<p><strong>Opening Seeding:</strong></p>
<ul>
<li>Linked Mode: One row per detected opening, with default enabled roles computed from opening bounds vs wall bounds:
<ul>
<li>Left/Right jambs enabled when the opening is not at the wall ends (tolerance-gated)</li>
<li>Header enabled when the opening top is below the vertical max (tolerance-gated)</li>
<li>Sill enabled when the opening bottom is above the base reference (tolerance-gated)</li>
</ul>
</li>
<li>Foundation Mode: Empty (manual add only)</li>
</ul>
<p><strong>Progress</strong>: Based on seeding completion</p>
<hr>
<h2 id="part-14-smart-family-change-updates">Part 14: Smart Family Change Updates</h2>
<h3 id="141-trigger-condition">14.1 Trigger Condition</h3>
<p>When a UI element (girt OR opening element) changes its <strong>family selection</strong> to a different family.</p>
<h3 id="142-update-behavior">14.2 Update Behavior</h3>
<ol>
<li>Look up orientation analysis results for:
<ul>
<li>New family ID</li>
<li>Current role (Girt, Head, Sill, JambLeft, JambRight)</li>
</ul>
</li>
<li>Auto-populate UI fields:
<ul>
<li>Rotation</li>
<li>Y Justification</li>
<li>Z Justification</li>
<li>(HandFlip defaults to false)</li>
</ul>
</li>
<li>UI controls update in lock-step with domain object</li>
</ol>
<h3 id="143-user-override">14.3 User Override</h3>
<ul>
<li>User can manually change rotation/justification after auto-population</li>
<li>Manual changes are preserved until next family change</li>
<li>On placement, use <strong>currently configured UI settings</strong> (not analysis defaults)</li>
</ul>
<h3 id="144-service-implementation">14.4 Service Implementation</h3>
<p><strong>SgtSmartDefaultsService:</strong></p>
<pre><code>ApplySmartDefaultsForGirt(row, symbolId)
  → Sets rotation, Y-just, Z-just from orientation analysis

TryApplySmartDefaultsForOpeningRole(row, role)
  → Handles LeftJamb, RightJamb, Header, Sill
</code></pre>
<h3 id="145-justification-display">14.5 Justification Display</h3>
<ul>
<li>UI displays human-readable labels: &quot;Left&quot;, &quot;Center&quot;, &quot;Right&quot;, &quot;Top&quot;, &quot;Bottom&quot;, etc.</li>
<li>Values convert to/from Revit API integers via <code>JustificationConverter</code></li>
<li>Rotation displays as degrees (0/90/180/270) but may be stored as radians for API</li>
</ul>
<hr>
<h2 id="part-15-grid-extents-ui">Part 15: Grid Extents UI</h2>
<h3 id="151-detection">15.1 Detection</h3>
<p>Find host and link grid lines intersecting the basis wall; show as Elevation overlay.</p>
<h3 id="152-per-row-ui">15.2 Per-Row UI</h3>
<p>Two comboboxes per girt row:</p>
<ul>
<li>Left Extent</li>
<li>Right Extent</li>
</ul>
<p><strong>Default</strong>: &quot;Full Length&quot; (bounded by wall edges)</p>
<h3 id="153-rules">15.3 Rules</h3>
<table>
<thead>
<tr>
<th>Grid Count</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 grids</td>
<td>Both comboboxes disabled</td>
</tr>
<tr>
<td>1 grid</td>
<td>Picking it on one side disables the other (remains &quot;Full Length&quot;)</td>
</tr>
<tr>
<td>2+ grids</td>
<td>Both enabled; forbid same-grid at both ends; forbid inversions (Right &lt; Left)</td>
</tr>
</tbody>
</table>
<h3 id="154-endpoint-computation">15.4 Endpoint Computation</h3>
<ol>
<li>Snap to selected grid planes ∩ wall plane</li>
<li>Set Disallow Join at both ends</li>
<li>Apply −1/2&quot; Start/End Extensions</li>
<li>Enforce &gt; 6&quot; minimum length</li>
</ol>
<hr>
<h2 id="part-16-combination-freedom">Part 16: Combination Freedom</h2>
<p>Any parameter combination (rotation/flip hand/face/Y-just/Z-just) is <strong>valid if and only if</strong> all acceptance gates are satisfied:</p>
<ul>
<li>k×90° rotation</li>
<li>Strict axis alignment</li>
<li>Exterior flange seating + role web seating</li>
<li>Zero offsets</li>
<li>Required 1/2&quot; end gaps via negative extensions</li>
<li>Disallow Join at both ends</li>
<li>Minimum length &gt; 6&quot;</li>
<li>Grid ordering rules</li>
<li>Hybrid axes asserts pass</li>
</ul>
<p>The spec prescribes <strong>outcomes</strong>, not a single parameter recipe. No heuristic search is required if the outcome is known.</p>
<hr>
<h2 id="part-17-future-considerations">Part 17: Future Considerations</h2>
<h3 id="171-sgtmember-role-agnostic-approach">17.1 SgtMember Role-Agnostic Approach</h3>
<p>Current implementation uses &quot;SgtGirt&quot; with separate handling for opening components. Future intent is to consolidate to a unified &quot;SgtMember&quot; class that is role-agnostic:</p>
<ul>
<li>Single class handles all roles: Girt, Head, Sill, JambLeft, JambRight</li>
<li>Role property determines behavior and validation rules</li>
<li>No axis-specific restrictions</li>
</ul>
<h3 id="172-z-shape-opening-role-relaxation">17.2 Z-Shape Opening Role Relaxation</h3>
<p>Currently Z-shapes are hard-blocked for opening roles. If user demand exists, this could be relaxed to a warning with override capability.</p>
<hr>
<h2 id="appendix-a-file-references">Appendix A: File References</h2>
<h3 id="core-domain">Core Domain</h3>
<ul>
<li><code>DBTools.Core/Domain/SGT/ValueObjects/EndpointAssociation.cs</code></li>
<li><code>DBTools.Core/Domain/SGT/ValueObjects/GirtSegment.cs</code></li>
<li><code>DBTools.Core/Domain/SGT/Rules/MemberRules.cs</code></li>
</ul>
<h3 id="services">Services</h3>
<ul>
<li><code>DBTools.UI/Services/Snapping/IElevationSnapService.cs</code></li>
<li><code>DBTools.UI/Services/Snapping/ElevationSnapIndex.cs</code></li>
<li><code>DBTools.UI/Services/Snapping/SnappingConstants.cs</code></li>
<li><code>DBTools.UI/Services/Defaults/SgtSmartDefaultsService.cs</code></li>
</ul>
<h3 id="adapters">Adapters</h3>
<ul>
<li><code>DBTools.RevitAdapter/SGT/Analysis/SgtOrientationAnalyzer.cs</code></li>
<li><code>DBTools.RevitAdapter/SGT/Analysis/SgtSymbolCalibrationService.cs</code></li>
<li><code>DBTools.RevitAdapter/SGT/Analysis/SgtFaceSelectors.cs</code></li>
<li><code>DBTools.RevitAdapter/SGT/Analysis/SgtFrameBuilder.cs</code></li>
<li><code>DBTools.RevitAdapter/SGT/Services/SgtDomainWriter.cs</code></li>
</ul>
<h3 id="ui">UI</h3>
<ul>
<li><code>DBTools.UI/ViewModels/SGT/SgtWindowViewModel.*.cs</code></li>
<li><code>DBTools.UI/Views/SGT/SgtWindow.xaml</code></li>
</ul>
<hr>
<h2 id="appendix-b-change-log">Appendix B: Change Log</h2>
<h3 id="version-10-2025-11-25">Version 1.0 (2025-11-25)</h3>
<ul>
<li>Initial merged specification</li>
<li>Consolidated 15 historical documents + 4 current specs</li>
<li>Added endpoint association system (Part 8)</li>
<li>Added elevation snapping specification (Part 9)</li>
<li>Added 4-step progress overlay specification (Part 13)</li>
<li>Added smart family change updates (Part 14)</li>
<li>Adopted strict single wall frame mandate</li>
<li>Specified Z-shape hard block for opening roles</li>
<li>Added future considerations for SgtMember consolidation</li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/tools/structural/sgt-spec.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
