<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>SGT (Super Girt Tool) | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="SGT (Super Girt Tool) | DB Tools ">
      
      
      <link rel="icon" href="../../../images/favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css?v=20260125">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/dev/wiki/developer-guide/tools/structural/sgt.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../../public/main.js?v=20260125" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" src="../../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="sgt-super-girt-tool">SGT (Super Girt Tool)</h1>

<h2 id="overview">Overview</h2>
<p>The Super Girt Tool (SGT) is a Revit add-in for placing and managing structural steel girts and opening framing members (jambs, headers, sills) on foundation walls. It supports both host document walls and walls in linked Revit models.</p>
<p>See also: <a href="sgt-spec.html">Specification (Internal)</a></p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/manifest.yml:7-8</code></p>
</blockquote>
<p><strong>Location</strong>: <code>src/Tools/Structural/SGT/</code></p>
<p><strong>Tool ID</strong>: <code>DBTools.SGT</code></p>
<p><strong>Ribbon Location</strong>: Structural group, order 40</p>
<h2 id="features">Features</h2>
<h3 id="core-functionality">Core Functionality</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Wall Selection</strong></td>
<td>Select linked walls or host foundation walls for girt placement</td>
</tr>
<tr>
<td><strong>Girt Placement</strong></td>
<td>Auto-seed girts at configurable elevations with smart spacing</td>
</tr>
<tr>
<td><strong>Opening Framing</strong></td>
<td>Automatic detection and framing of openings (jambs, headers, sills)</td>
</tr>
<tr>
<td><strong>Live Preview</strong></td>
<td>Real-time 2D elevation and 3D preview of proposed framing</td>
</tr>
<tr>
<td><strong>Extent Control</strong></td>
<td>Configure girt extents by wall length, grids, openings, or manual distances</td>
</tr>
<tr>
<td><strong>Edit Mode</strong></td>
<td>Modify previously placed SGT systems with host-change reconciliation</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Commands/SgtNewCommand.cs:36-39</code></p>
</blockquote>
<h3 id="contextual-edit-launch">Contextual Edit Launch</h3>
<p>The contextual <code>Edit SGT Wall</code> flow pre-creates its <code>ExternalEvent</code> during API-safe injector lifecycle work (<code>InitializeAsync</code> / <code>RefreshAsync</code>) and only calls <code>Raise()</code> from the ribbon click handler. This avoids Revit invalid-context failures when ribbon callbacks run outside standard API execution.</p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/Commands/ContextualRibbonInjector.cs:59</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/Commands/ContextualRibbonInjector.cs:106</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/Commands/ContextualRibbonInjector.cs:424</code></p>
</blockquote>
<h3 id="supported-wall-types">Supported Wall Types</h3>
<ul>
<li><strong>Linked Walls</strong>: Walls from Revit link instances (any function)</li>
<li><strong>Host Foundation Walls</strong>: Foundation walls in the host document (WallFunction.Foundation)</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Commands/SgtNewCommand.cs:96-99</code></p>
</blockquote>
<h3 id="supported-framing-types">Supported Framing Types</h3>
<p>The tool supports structural framing families filtered by shape:</p>
<table>
<thead>
<tr>
<th>Shape Category</th>
<th>Girts</th>
<th>Opening Members</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>C Shapes</td>
<td>Yes</td>
<td>Yes</td>
<td>Default: C10X15.3</td>
</tr>
<tr>
<td>MC Shapes</td>
<td>Yes</td>
<td>Yes</td>
<td>Miscellaneous channels</td>
</tr>
<tr>
<td>Z Shapes</td>
<td>Yes</td>
<td><strong>No</strong></td>
<td>Intentionally excluded for openings</td>
</tr>
<tr>
<td>Angle Shapes</td>
<td>Yes</td>
<td><strong>No</strong></td>
<td>Girt-only; short leg seats elevation and long leg seats exterior plane</td>
</tr>
<tr>
<td>HSS (Tube)</td>
<td>Yes</td>
<td>Yes</td>
<td>Square + rectangular role-aware seating/orientation mapping</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/FamilySymbolClassifier.cs:158</code></p>
</blockquote>
<h2 id="architecture">Architecture</h2>
<p>SGT follows a domain-driven MVVM architecture with clear separation between UI, domain logic, and Revit API interactions.</p>
<pre><code>src/Tools/Structural/SGT/
+-- Features/            # Feature-specific code
|   +-- AnalyzeWall/     # Wall analysis services
|   +-- Commands/        # Revit external commands
|   +-- Girts/           # Girt management services
|   +-- Openings/        # Opening detection
|   +-- Orientation/     # Family orientation analysis
|   +-- Place/           # Placement orchestration
|   +-- Preview/         # 2D/3D preview rendering
|   +-- Reconcile/       # Host-change reconciliation
+-- Shell/               # UI layer
|   +-- Composition/     # DI registration
|   +-- DesignTime/      # Design-time ViewModels
|   +-- UI/              # Views and ViewModels
+-- Shared/              # Cross-feature services
    +-- Contracts/       # Interfaces and DTOs
    +-- Extents/         # Extent resolution
    +-- Hydration/       # Domain hydration
    +-- Kernel/          # Core domain
    |   +-- Domain/      # Domain entities (SgtPlan, SgtWall, etc.)
    |   +-- Geometry/    # Geometry utilities
    |   +-- State/       # State management
    |   +-- Units/       # Unit conversion service
    +-- PreviewModels/   # Preview data models
    +-- Revit/           # Revit adapters
    +-- UiModels/        # UI-bound row items (SgtGirtRowItem, etc.)
</code></pre>
<h3 id="key-design-patterns">Key Design Patterns</h3>
<h4 id="single-source-of-truth-ssot">Single Source of Truth (SSOT)</h4>
<p>The <code>SgtPlan</code> object serves as the single source of truth for all SGT operations. It contains:</p>
<ul>
<li>Wall geometry and context (host/linked)</li>
<li>Girt row configurations</li>
<li>Opening row configurations</li>
<li>Eligible framing types</li>
<li>Pre-computed orientation data</li>
<li>Grid positions</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shared/Kernel/Domain/SgtPlan.cs:10-14</code></p>
</blockquote>
<h4 id="plan-store-pattern">Plan Store Pattern</h4>
<p>The <code>ISgtPlanStore</code> interface provides centralized plan state management with change notifications:</p>
<pre><code class="lang-csharp">public interface ISgtPlanStore
{
    SgtPlan? Plan { get; }
    event EventHandler&lt;PlanChangedEventArgs&gt;? PlanChanged;
    void SetPlan(SgtPlan plan);
    void Clear();
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shared/Contracts/ISgtPlanStore.cs</code></p>
</blockquote>
<h4 id="orchestrator-pattern">Orchestrator Pattern</h4>
<p>The <code>SgtOrchestrator</code> coordinates validation, domain object creation, and placement/update operations:</p>
<ol>
<li><strong>Validate</strong> - Check plan integrity and extent resolution</li>
<li><strong>Build Domain</strong> - Create <code>SgtWall</code> with <code>SgtMember</code> and <code>SgtOpening</code> aggregates</li>
<li><strong>Hydrate</strong> - Resolve segments and connectivity</li>
<li><strong>Persist</strong> - Write to Revit document via <code>ISgtDomainWriter</code></li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Place/Logic/SgtOrchestrator.cs:17-40</code></p>
</blockquote>
<h2 id="ui-components">UI Components</h2>
<h3 id="main-window">Main Window</h3>
<p><strong>Class</strong>: <code>SgtWindow</code> (WPF Window)<br>
<strong>ViewModel</strong>: <code>SgtWindowViewModel</code></p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Views/SgtWindow.xaml:2</code></p>
</blockquote>
<p>The main window is a 1600x850 modal dialog with three main regions:</p>
<ol>
<li><p><strong>Left Panel</strong>: Configuration</p>
<ul>
<li>Scope controls (wall offset, layer selection)</li>
<li>Girts expander with DataGrid</li>
<li>Openings expander with DataGrid</li>
<li>Bulk edit flyout</li>
</ul>
</li>
<li><p><strong>Center Splitter</strong>: Resizable divider</p>
</li>
<li><p><strong>Right Panel</strong>: Preview</p>
<ul>
<li>2D elevation view</li>
<li>3D view (using HelixToolkit)</li>
<li>Preview mode toggle</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Views/SgtWindow.xaml:243-255</code></p>
</blockquote>
<h3 id="girt-grid-columns">Girt Grid Columns</h3>
<table>
<thead>
<tr>
<th>Column</th>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Elevation</td>
<td><code>ElevationText</code></td>
<td>Vertical position (feet-inches format)</td>
</tr>
<tr>
<td>Girt Type</td>
<td><code>GirtTypeId</code></td>
<td>Family type selection</td>
</tr>
<tr>
<td>Rotation</td>
<td><code>Rotation</code></td>
<td>Cross-section rotation (0/90/180/270)</td>
</tr>
<tr>
<td>Y Justification</td>
<td><code>YJustification</code></td>
<td>Lateral positioning</td>
</tr>
<tr>
<td>Z Justification</td>
<td><code>ZJustification</code></td>
<td>Vertical positioning</td>
</tr>
<tr>
<td>Flip</td>
<td><code>FlipHand</code></td>
<td>Mirror orientation</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Views/SgtWindow.xaml:402-517</code></p>
</blockquote>
<h3 id="opening-grid-columns">Opening Grid Columns</h3>
<p>Each opening row supports four framing roles with independent configuration:</p>
<ul>
<li><strong>Left Jamb</strong>: Vertical member at opening left edge</li>
<li><strong>Right Jamb</strong>: Vertical member at opening right edge</li>
<li><strong>Header</strong>: Horizontal member at opening top</li>
<li><strong>Sill</strong>: Horizontal member at opening bottom (optional)</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shared/Kernel/Domain/OpeningRoleRules.cs</code></p>
</blockquote>
<h3 id="preview-modes">Preview Modes</h3>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Elevation</td>
<td>2D front elevation view with girts and openings</td>
</tr>
<tr>
<td>3D</td>
<td>Interactive 3D view with wall layers and framing</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Logic/Models/PreviewMode.cs:4-9</code></p>
</blockquote>
<h2 id="services">Services</h2>
<h3 id="dependency-injection">Dependency Injection</h3>
<p>All SGT services are registered via <code>SgtServiceCollectionExtensions.AddSgt()</code>:</p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/Composition/SgtServiceCollectionExtensions.cs:29-83</code></p>
</blockquote>
<h4 id="core-services">Core Services</h4>
<table>
<thead>
<tr>
<th>Service</th>
<th>Lifetime</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ISgtPlanStore</code></td>
<td>Singleton</td>
<td>Plan state management</td>
</tr>
<tr>
<td><code>IUnitService</code></td>
<td>Singleton</td>
<td>Unit conversion</td>
</tr>
<tr>
<td><code>SgtValidationService</code></td>
<td>Singleton</td>
<td>Plan validation</td>
</tr>
<tr>
<td><code>ISgtSystemRepository</code></td>
<td>Scoped</td>
<td>Extensible storage access</td>
</tr>
<tr>
<td><code>SgtPersistenceService</code></td>
<td>Scoped</td>
<td>Plan persistence</td>
</tr>
</tbody>
</table>
<h4 id="feature-services">Feature Services</h4>
<table>
<thead>
<tr>
<th>Service</th>
<th>Lifetime</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RevitOpeningQuery</code></td>
<td>Scoped</td>
<td>Opening detection from walls</td>
</tr>
<tr>
<td><code>FamilyCalibrationService</code></td>
<td>Scoped</td>
<td>Family profile extraction</td>
</tr>
<tr>
<td><code>WallGeometryService</code></td>
<td>Scoped</td>
<td>Wall geometry analysis</td>
</tr>
<tr>
<td><code>SgtOrientationAdapter</code></td>
<td>Scoped</td>
<td>Family orientation computation</td>
</tr>
<tr>
<td><code>IExtentResolver</code></td>
<td>Singleton</td>
<td>Extent position resolution</td>
</tr>
<tr>
<td><code>SegmentResolutionService</code></td>
<td>Singleton</td>
<td>Girt segment computation</td>
</tr>
<tr>
<td><code>SgtAutoSeedingService</code></td>
<td>Singleton</td>
<td>Initial girt elevation seeding</td>
</tr>
</tbody>
</table>
<h4 id="placement-services">Placement Services</h4>
<table>
<thead>
<tr>
<th>Service</th>
<th>Lifetime</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ISgtPlanBuilder</code></td>
<td>Transient</td>
<td>Build plan from wall context</td>
</tr>
<tr>
<td><code>ISgtDomainWriter</code></td>
<td>Transient</td>
<td>Write domain objects to Revit</td>
</tr>
<tr>
<td><code>SgtOrchestrator</code></td>
<td>Transient</td>
<td>Coordinate placement flow</td>
</tr>
</tbody>
</table>
<h3 id="smart-defaults-service">Smart Defaults Service</h3>
<p>The <code>SgtSmartDefaultsService</code> applies automatic orientation defaults based on family analysis:</p>
<pre><code class="lang-csharp">// For girts
SgtSmartDefaultsService.ApplySmartDefaultsForGirt(row, plan);

// For opening roles
SgtSmartDefaultsService.TryApplySmartDefaultsForOpeningRole(row, role, plan);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Girts/Services/SgtSmartDefaultsService.cs:43-70</code></p>
</blockquote>
<h3 id="host-change-reconciliation">Host Change Reconciliation</h3>
<p>When editing an existing SGT system, the tool detects changes to the host wall:</p>
<ol>
<li><strong>Diff Detection</strong>: Compare stored vs current wall geometry</li>
<li><strong>Missing Wall Handling</strong>: Options for re-link or delete</li>
<li><strong>Opening Actions</strong>: Sync/Move decisions now read current detected openings (manual <code>M:</code> openings still read editable plan rows)</li>
<li><strong>Manual-to-Real Mapping</strong>: Force-sync maps manual openings to <code>DetectedOpenings</code>, not stored opening snapshots</li>
<li><strong>Update Move Policy</strong>: Update runs move-first; move failures can be surfaced to UI and retried as delete/recreate</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/Services/HostChangeReconciliationService.cs:398</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Domain/WriteContext.cs:1</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/DomainWriter.Updates.cs:369</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.CommandsAndBulk.cs:440</code></p>
</blockquote>
<h3 id="elevation-drag-undoredo-coverage-2026-02-07">Elevation Drag Undo/Redo Coverage (2026-02-07)</h3>
<p>Elevation preview drag/snap edits now record real do/undo command actions (not no-op redo stubs), and all snap edit paths share command-stack behavior:</p>
<ol>
<li><strong>Girt extents</strong> (left/right) now execute as command-driven <code>do/undo</code> mutations so redo re-applies snapped extents.</li>
<li><strong>Opening edges</strong> (left/right opening geometry drags) now push undo/redo commands with full <code>T0/T1</code> restore.</li>
<li><strong>Opening member extents</strong> (jamb/header/sill endpoint snaps) now push undo/redo commands by cloning/restoring role config state.</li>
</ol>
<h3 id="snap-association-lock-rule-2026-02-07">Snap Association Lock Rule (2026-02-07)</h3>
<p>Elevation preview drag interactions are now documented and enforced as association-locked operations:</p>
<ol>
<li><strong>No arbitrary drag targets</strong> are produced by snapping (<code>FreeAlong</code> quantized fallback is not used in drag/snap flow).</li>
<li><strong>Nearest valid association is always resolved</strong> (grid, wall edge, opening edge, or enabled vertical target like girt/wall top/wall bottom).</li>
<li><strong>Threshold only affects <code>Snapped</code> UI state</strong>, not whether a valid association is returned.</li>
<li><strong>Manual Along extents remain explicit form input behavior</strong>, not drag/snap output.</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Snapping/ElevationSnapService.cs:46</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Snapping/ElevationSnapIndex.cs:216</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:89</code></p>
</blockquote>
<h3 id="preview-horizontal-transformprojection--segment-endpoint-ownership-2026-02-07">Preview Horizontal Transform/Projection + Segment Endpoint Ownership (2026-02-07)</h3>
<p>Two WW/WS preview parity defects were hardened:</p>
<ol>
<li><strong>Horizontal preview transform/projection semantics</strong> now split responsibilities to match placement-facing semantics: profile transform always preserves analyzer-resolved <code>yTargetsFlange</code> for every role, while horizontal members (<code>Girt</code>, <code>Head</code>, <code>Sill</code>) project with a role-stable view contract (<code>depth=U,secondary=V</code>). Jamb roles continue to project by resolved <code>Y-&gt;Flange</code> / <code>Y-&gt;Web</code> mapping.</li>
<li><strong>Segment interior endpoint snapping</strong> now resolves endpoint ownership from explicit opening-edge side metadata (<code>Left</code>/<code>Right</code>) first, with endpoint-side fallback only when metadata is unavailable. This prevents WS cases where dragging one bisected endpoint updated the opposite wall-side extent.</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/OrientationSemanticsHelper.cs:95</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Models/PreviewScene3DBuilder.cs:260</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Rendering/PreviewRenderer.cs:729</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:561</code></p>
</blockquote>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:39</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:89</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:195</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.DomainIntegration.cs:293</code></p>
</blockquote>
<h3 id="elevation-grid-marker-bubble-contrast-2026-02-07">Elevation Grid Marker Bubble Contrast (2026-02-07)</h3>
<p>Grid markers in elevation preview now render as a white-filled circle with black stroke and centered black text to preserve readability on dark themes.</p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Rendering/PreviewRenderer.cs:577</code></p>
</blockquote>
<h3 id="previewplacement-coordinate-parity-2026-02-06">Preview/Placement Coordinate Parity (2026-02-06)</h3>
<p>To remove mismatch between preview and placed members (especially for linked walls and opening jambs), SGT now shares the same direction/orientation semantics across analysis, preview, and placement:</p>
<ol>
<li><strong>Opening T mapping now respects linked frame inversion</strong><br>
Step 2 compares host-space wall curve direction against <code>WallGeometry.Direction</code> and flips opening <code>T0/T1</code> when the frames are reversed.</li>
<li><strong>3D preview now uses the shared depth-plane helper</strong><br>
Preview layer offset and wall offset now resolve with the same helper used by placement.</li>
<li><strong>3D section basis now uses canonical orientation rules</strong><br>
Jamb/horizontal role transforms are built from exterior normal + axis cross products with consistent sign behavior.</li>
<li><strong>Opening role orientation now honors per-role Flip setting in placement path</strong></li>
<li><strong>Opening-edge cutbacks now use gap-only trimming (no jamb face inset)</strong><br>
Placement and preview segmentation both apply the same opening-edge gap value, eliminating oversized girt-to-jamb trims.</li>
<li><strong>Preview justification axis mapping now uses analyzer metadata</strong><br>
<code>OrientationResult.YTargetsFlange</code> now propagates into preview rendering so Y/Z justifications target the same flange/web axes as placement behavior.</li>
<li><strong>Elevation/Section/3D now consume one shared preview semantics helper</strong><br>
Justification deltas and orientation-map lookup are centralized and reused by all preview modes.</li>
<li><strong>Preview profile transform ordering now matches placement math</strong><br>
Preview now applies profile transforms as <code>rotation</code> → <code>FlipHand</code> → Y/Z justification (matching placement parameter application order), reducing jamb rotation/depth drift on linked walls.</li>
<li><strong>Opening orientation precedence is role-first, then type-level, then girt fallback</strong><br>
Preview now resolves <code>YTargetsFlange</code> from role-specific opening metadata first, which fixes role drift for head/sill/jamb members that share a type.</li>
<li><strong>3D/Elevation/Section profile transform + projection now use one shared preview semantics helper with explicit role contracts</strong><br>
Transform semantics are analyzer-driven for all roles (<code>yTargetsFlange</code> preserved); projection is role-aware: horizontal roles (<code>Girt</code>, <code>Head</code>, <code>Sill</code>) render as <code>depth=U,secondary=V</code>, while jamb roles keep analyzer-driven mapping (<code>Y-&gt;Flange</code> =&gt; <code>depth=U,secondary=V</code>, <code>Y-&gt;Web</code> =&gt; <code>depth=V,secondary=U</code>).</li>
<li><strong>3D opening diagnostics now include projection mapping for all opening roles</strong><br>
Left/Right jamb, Header, and Sill debug entries now log the resolved projection mapping and anchor geometry for faster root-cause triage.</li>
<li><strong>Orientation analyzer probing is role-aware for rotated links</strong><br>
Step 2 keeps canonical probes (<code>0/90/180/270</code>) for horizontal roles, and applies wall-azimuth residual compensation only for jamb roles during temporary orientation probing. Stored orientation outputs remain canonical quarter-turn values.</li>
<li><strong>Linked opening T mapping now follows frame-swap direction only</strong><br>
Opening T mapping now uses the wall frame swap outcome directly (<code>dirDot &lt; 0</code>) and no longer applies an additional mirrored-link XOR branch. This prevents mirrored+rotated linked walls from inverting opening side placement.</li>
<li><strong>Step 2 orientation seating is reflection-aware for mirrored links</strong><br>
Analyzer Y/Z seating now applies a mirrored-aware flange-side rule when evaluating structural-plane seating: non-mirrored links require positive signed side, mirrored links require negative signed side, and web seating remains side-agnostic. This prevents mirrored-link runs from rejecting all girt types during orientation analysis.</li>
<li><strong>HSS role mapping is now explicit in Step 2</strong><br>
Square HSS uses symmetric seating candidates (all non-endcap faces, no mirrored-side bias). Rectangular HSS now persists deep/shallow calibrated face-id sets and uses role-aware set assignment: horizontal roles seat deep faces at the exterior plane and shallow faces at the elevation/opening plane, while jamb roles invert that mapping so deep faces stay opening-edge-seated.</li>
<li><strong>ANGLE/Z shape contracts are now hard-enforced during analysis</strong><br>
ANGLE calibration stores short-leg and long-leg face IDs (short=web-like, long=flange-like) and girt Y/Z solving filters to those faces. Z-shape girt validation now resolves flange pairs from aligned section faces and enforces exterior flange-down + interior flange-up ordering.</li>
<li><strong>Web seating mode is now explicit and deterministic in Step 2</strong><br>
Analyzer resolves web-seat distance mode through a shape/role policy hook: open-section horizontals (<code>Channel</code> girt/head/sill, <code>Z</code> girt, <code>Angle</code> girt) use edge-contact web seating, while HSS profiles and jamb roles use face-coplanar web seating. This restores girt orientation pass behavior without relaxing closed-section seating gates.</li>
<li><strong>Non-HSS mapping no longer carries inferred HSS kind</strong><br>
Step 2 now forces <code>hssKind=Unknown</code> for non-HSS shapes before role mapping, preventing non-HSS branch contamination from type-name fallback parsing.</li>
<li><strong>Step 2 rejects non-finite Y/Z metrics before ranking</strong><br>
Candidate and pair evaluations now drop <code>NaN</code>/<code>Infinity</code> metrics, emit explicit rejection diagnostics, and include <code>candidates</code>, <code>finiteCandidates</code>, and <code>rejectedNonFinite</code> counts in fail-fast reasons for deterministic fatal-step triage.</li>
<li><strong>Opening-role web seating planes now anchor to wall-frame origin</strong><br>
Head/Sill/Jamb web seating planes are created from wall-frame origin for deterministic opening-role Y/Z seating, eliminating origin-induced role drift across rotated/mirrored linked walls.</li>
<li><strong>Temp probe transactions now emit structured failure metadata and deterministic probe outcomes</strong><br>
Temp probe transactions (<code>Calibration</code>, <code>Orientation Probe</code>, <code>Warm Member Profile</code>) remain rollback-only with independent work/rollback exception capture, but transaction-mode probes now capture failure-preprocessor metadata (<code>blocking</code>, <code>warnings</code>, <code>lastResult</code>, <code>forbidden</code>) through <code>RunWithMetadata(...)</code>. Step 1/2/3 consumers now convert blocking metadata into explicit symbol/type failures (forbidden vs generic temp failure), preventing silent probe success when Revit reports blocking failures only through failure processing.</li>
<li><strong>Post-analyze preview refresh uses deterministic two-pass dispatch</strong><br>
After successful plan hydration (<code>_planStore.Initialize</code> + <code>RefreshFromPlan</code> + <code>AnalysisComplete</code>), overlay teardown schedules one <code>Loaded</code> refresh and one <code>Background</code> safety refresh with a lightweight in-flight latch. Failed/canceled analyzes skip this refresh burst.</li>
<li><strong>Face traversal now resolves one geometry source per pass</strong><br>
Face traversal prefers instance geometry and falls back to symbol geometry only when instance geometry is unavailable, preventing mixed stale/fresh candidate sets from double traversal.</li>
<li><strong>Square-HSS Y/Z probing now re-fetches candidate faces per iteration</strong><br>
The Y/Z solver no longer reuses a pre-loop <code>hssFaces</code> snapshot. Symmetric HSS candidates are reloaded after each justification update/regenerate pass.</li>
<li><strong>Y/Z solver diagnostics and face-selection guards are now stronger</strong><br>
Step 2 now emits per-pair <code>[SGT.Orientation.YZ.PairProbe]</code> diagnostics, deduplicates <code>GetFacesByIds</code> results by persistent face id, and uses <code>Acceptance.SeatingTol</code> (not <code>1e-6</code>) for signed-side filtering.</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/Steps/PlanBuilder.Step2Analyze.cs:200</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/Steps/PlanBuilder.Step2Analyze.cs:446</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/WallGeometryContext.cs</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/WallGeometryService.cs</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAdapter.cs:423</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:170</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:539</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Models/PreviewScene3DBuilder.cs:42</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Models/PreviewScene3DBuilder.cs:516</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/Orchestrator.cs:296</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/Writers/DomainWriter.MemberPlacement.cs:398</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.CoreAndEditing.cs:1801</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Domain/ValueObjects/OrientationResult.cs:17</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/OrientationSemanticsHelper.cs:36</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/OrientationSemanticsHelper.cs:101</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Rendering/PreviewRenderer.cs:743</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Rendering/PreviewRenderer.cs:1358</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/SymbolCalibrationService.cs:446</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/FamilyCalibrationData.cs:68</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:583</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:1035</code><br>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:1406</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:885</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:292</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:309</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:415</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/TempTransaction.cs</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/TempTransaction.cs:38</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/TempTransaction.cs:123</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/TempTransaction.cs:279</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/SymbolCalibrationService.cs:243</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Placement/Steps/PlanBuilder.Step3Warm.cs:176</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:408</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/FaceSelectors.cs:20</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/FaceSelectors.cs:88</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/WallAnalysis/SymbolCalibrationService.cs:356</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:832</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:902</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:1369</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:1384</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Orientation/OrientationAnalyzer.cs:1426</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.AnalysisAndHydration.cs:115</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/ViewModels/ShellWindowViewModel.AnalysisAndHydration.cs:226</code></p>
</blockquote>
<h2 id="configuration">Configuration</h2>
<h3 id="manifest">Manifest</h3>
<pre><code class="lang-yaml">id: DBTools.SGT
assembly: DBTools
moduleType: DBTools.SGT.SgtToolModule
order: 0
sandboxWindows:
  - id: DBTools.SGT.Main
    displayName: &quot;Super Girt Tool&quot;
    group: &quot;Structural&quot;
    windowType: &quot;DBTools.SGT.Shell.UI.Views.SgtWindow&quot;
    designTimeViewModelType: &quot;DBTools.SGT.Shell.DesignTime.SgtWindowDesignTimeViewModel&quot;
tool:
  ribbonTools:
    - internalName: DBTools.SGT
      commandType: DBTools.SGT.Features.Commands.SgtNewCommand
      availabilityType: DBTools.App.Tools.Availability.DbtDocumentAvailability
      runProfile: InlineUi
      displayText: &quot;Super Girt Tool&quot;
      iconBaseKey: sgt
      tooltip: &quot;Launch Super Girt Tool&quot;
      controlKind: PushButton
      order: 40
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/manifest.yml:1-21</code></p>
</blockquote>
<h3 id="ui-state-persistence">UI State Persistence</h3>
<p>The <code>ISgtUiStateStore</code> persists user preferences:</p>
<ul>
<li>Expander states (Girts, Openings)</li>
<li>Preview mode selection</li>
<li>Column visibility</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Settings/ISgtUiStateStore.cs</code></p>
</blockquote>
<h2 id="domain-model">Domain Model</h2>
<h3 id="key-domain-entities">Key Domain Entities</h3>
<h4 id="sgtplan">SgtPlan</h4>
<p>The central data structure containing all configuration:</p>
<pre><code class="lang-csharp">public sealed class SgtPlan
{
    // Wall context
    public int? HostWallId { get; init; }
    public int? LinkedWallId { get; init; }
    public int? LinkInstanceId { get; init; }
    public WallGeometry? WallGeometry { get; set; }
    
    // Girt configuration
    public List&lt;SgtGirtRow&gt; GirtRows { get; init; }
    public int SelectedGirtTypeId { get; set; }
    
    // Opening configuration
    public List&lt;SgtOpeningRow&gt; OpeningRows { get; set; }
    public IReadOnlyList&lt;OpeningDetectionData&gt; DetectedOpenings { get; set; }
    
    // Options
    public int DepthPlaneLayerIndex { get; set; }
    public double WallOffsetFeet { get; set; }
    public bool FoundationMode { get; set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shared/Kernel/Domain/SgtPlan.cs:15-811</code></p>
</blockquote>
<h4 id="extent-types">Extent Types</h4>
<p>Girts support multiple extent modes:</p>
<table>
<thead>
<tr>
<th>Extent Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FullLengthExtent</code></td>
<td>Wall start to wall end</td>
</tr>
<tr>
<td><code>AlongExtent</code></td>
<td>Fixed distances from wall start</td>
</tr>
<tr>
<td><code>GridExtent</code></td>
<td>Between named grid lines with offsets</td>
</tr>
<tr>
<td><code>OpeningEdgeExtent</code></td>
<td>Relative to opening edges</td>
</tr>
<tr>
<td><code>DualOpeningEdgeExtent</code></td>
<td>Between two opening edges</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Shared/Kernel/Domain/</code> (multiple files)</p>
</blockquote>
<h2 id="integration-points">Integration Points</h2>
<h3 id="revit-api-integration">Revit API Integration</h3>
<p>SGT interacts with Revit through adapter services:</p>
<ul>
<li><strong>WallGeometryService</strong>: Extract wall curves, layers, dimensions</li>
<li><strong>RevitOpeningQuery</strong>: Detect doors, windows, and openings in walls</li>
<li><strong>SgtDomainWriter</strong>: Create structural framing instances</li>
<li><strong>SgtSystemRepository</strong>: Store/retrieve SGT configurations in extensible storage</li>
</ul>
<h3 id="related-documentation">Related Documentation</h3>
<ul>
<li><a href="../../architecture/overview.html">System Architecture</a> - Overall system design</li>
<li><a href="../../projects/app.html">Application Host</a> - How tools are loaded and hosted</li>
<li><a href="../../development/manifests.md">Tool Manifest Format</a> - Manifest schema reference</li>
</ul>
<h2 id="testing">Testing</h2>
<p>SGT includes comprehensive tests:</p>
<pre><code>src/Tools/Structural/SGT/Tests/
+-- SgtAdapterTests.cs
+-- SgtFrameBuilderTests.cs
+-- SgtConfigHydratorTests.cs
+-- SgtValidationServiceTests.cs
+-- SgtOrchestratorExtentTests.cs
+-- SgtHostChangeDiffServiceTests.cs
+-- ... (additional test files)
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Tests/DBTools.SGT.Tests.csproj</code></p>
</blockquote>
<p>Run tests via the Revit test runner:</p>
<pre><code class="lang-bash">bash invoke-revit-tests.sh --smart --tool SGT
</code></pre>
<h2 id="preview-rotation-parity-2026-02-07">Preview Rotation Parity (2026-02-07)</h2>
<p>Preview profile transforms use the established section-space rotation direction used by SGT preview/inset geometry math.</p>
<ul>
<li>WW/WS orientation parity is now addressed in preview by secondary-axis normalization when transform/projection semantics differ.</li>
<li>Rotation direction is unchanged from baseline behavior; parity correction is isolated to preview secondary-axis projection.</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/OrientationSemanticsHelper.cs</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Domain/MemberProfileInsetCalculator.cs</code></p>
</blockquote>
<h2 id="preview-secondary-axis-parity-2026-02-07">Preview Secondary-Axis Parity (2026-02-07)</h2>
<p>Preview now applies a secondary-axis sign correction when transform semantics and projection semantics intentionally differ.</p>
<ul>
<li>Transform remains analyzer-driven for all roles (<code>yTargetsFlange</code> preserved).</li>
<li>Horizontal projection remains role-stable (<code>depth=U, secondary=V</code>).</li>
<li>When those two semantics differ (typical WW horizontal case), preview secondary coordinates/bounds are sign-corrected before elevation/section banding and before 3D extrusion offsets.</li>
<li>This keeps WW and WS preview orientation parity for girts/headers/sills without changing placement behavior.</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/OrientationSemanticsHelper.cs</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Shell/UI/Rendering/PreviewRenderer.cs</code>
<strong>Source:</strong> <code>src/Tools/Structural/SGT/Features/Preview/Models/PreviewScene3DBuilder.cs</code></p>
</blockquote>
<hr>
<blockquote>
<p><strong>Documentation Status</strong>: Complete</p>
<p><strong>Last Updated</strong>: 2026-02-07</p>
<p><strong>Source Review</strong>: Verified against source files in <code>src/Tools/Structural/SGT/</code></p>
</blockquote>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/dev/wiki/developer-guide/tools/structural/sgt.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
