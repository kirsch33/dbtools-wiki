<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Global Mapper (GM) | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Global Mapper (GM) | DB Tools ">
      
      
      <link rel="icon" href="../../../images/favicon.ico">
      <link rel="stylesheet" href="../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../public/main.css?v=20260125">
      <meta name="docfx:navrel" content="../../../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/dev/wiki/developer-guide/tools/common/gm.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../../public/main.js?v=20260125" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../index.html">
            <img id="logo" src="../../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="global-mapper-gm">Global Mapper (GM)</h1>

<!-- STATUS: verified -->
<!-- Last Updated: 2026-02-09 -->
<!-- Verified By: audit-cleanup-execution-20260209; gm-kernel-usage-hydration-20260209 -->
<p><strong>Global Mapper</strong> is a comprehensive Revit type-mapping tool that enables users to detect, plan, review, and commit bulk element replacements across families, types, materials, line styles, object styles, and shared parameters.</p>
<p>See also: <a href="gm-spec.html">Specification (Internal)</a></p>
<h2 id="overview">Overview</h2>
<p>Global Mapper provides a unified interface for:</p>
<ul>
<li><strong>Family/Type Mapping</strong>: Replace family instances with equivalent types from other families</li>
<li><strong>Duplicate Detection</strong>: Identify potential duplicate elements using similarity analysis</li>
<li><strong>Usage Analysis</strong>: Understand material, line style, and object style usage across families</li>
<li><strong>Deep Scan</strong>: Analyze family document contents to extract parameter names, style refs, and material refs</li>
<li><strong>Shared Parameter Authoring</strong>: Bind and embed shared parameters to families/categories</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/manifest.yml:1-26</code></p>
</blockquote>
<h2 id="features">Features</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duplicates Tab</strong></td>
<td>Detects potential duplicate families, materials, styles, and shared parameters using weighted similarity scoring</td>
</tr>
<tr>
<td><strong>Families Tab</strong></td>
<td>Browse families by category, select target mappings, and configure type replacements</td>
</tr>
<tr>
<td><strong>Line Styles Tab</strong></td>
<td>View and map line style usage with visual preview</td>
</tr>
<tr>
<td><strong>Object Styles Tab</strong></td>
<td>View and map object style usage with visual preview</td>
</tr>
<tr>
<td><strong>Materials Tab</strong></td>
<td>View and map material usage with color preview</td>
</tr>
<tr>
<td><strong>Shared Parameters Tab</strong></td>
<td>Manage shared parameter bindings across categories and families</td>
</tr>
<tr>
<td><strong>Cross-View Instance Navigation</strong></td>
<td>Families/SP instance cyclers zoom across views and activate/show the sampled instance</td>
</tr>
<tr>
<td><strong>Plan + Commit Review Workflow</strong></td>
<td>Main window stages mappings, then Commit Review performs one explicit commit pass</td>
</tr>
<tr>
<td><strong>Usage-Linked Family Apply Badges</strong></td>
<td>Families rows show <code>OS</code>, <code>MAT</code>, or <code>OS+MAT</code> when Apply is linked from Object Styles/Materials</td>
</tr>
<tr>
<td><strong>Nested Usage-Link Indicators</strong></td>
<td>Expanded family Object Styles/Materials rows show <code>LK</code> badges (<code>OS</code>/<code>MAT</code>) for rows actively driving linkage</td>
</tr>
<tr>
<td><strong>Usage-Link Planning Guardrail</strong></td>
<td>Usage-linked family Apply is impact-only; family-owned ops require explicit user ownership of the family row</td>
</tr>
<tr>
<td><strong>Commit-Continue Refresh Pipeline</strong></td>
<td>Commit and Continue evicts stale family cache for active category, re-scans, refreshes usage data, and restores expanded detail context</td>
</tr>
<tr>
<td><strong>Dual-Segment Status Bar</strong></td>
<td>Bottom-left status line renders <code>Global</code> + <code>Active</code> segments and updates live on tab/load/filter/mapping state changes</td>
</tr>
<tr>
<td><strong>Load-Aware Empty States</strong></td>
<td>All GM tab empty placeholders use load-vs-empty messaging with high-contrast theme brushes</td>
</tr>
<tr>
<td><strong>Deep Scan</strong></td>
<td>Analyze family documents to extract embedded parameter names, style references, and material references</td>
</tr>
<tr>
<td><strong>Mapping Persistence</strong></td>
<td>Save and restore mapping targets per-project; restored rows keep <code>Apply=false</code> until user action</td>
</tr>
<tr>
<td><strong>Conflict Detection</strong></td>
<td>Identify conflicting mappings before applying changes</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/FamiliesPaneViewModel.cs:305</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/SharedParametersPaneViewModel.cs:455</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:1358</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MappingReportViewModel.cs:489</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MatchingModels.cs:190</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.UsageAndFamilies.cs:165</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml:1249</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/PlanBuildingService.cs:86</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:867</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml:495</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/UsagePaneViewModel.cs:676</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.MappingInitAndInfrastructure.cs:487</code></p>
</blockquote>
<h2 id="commit-review-lifecycle-guarantees">Commit Review Lifecycle Guarantees</h2>
<ul>
<li>Commit executes the normalized plan directly through <code>IMappingService.ApplyPlanAsync(...)</code>, then runs verification in the same flow.</li>
<li>Overlay Cancel and Commit Review titlebar close both request cancellation and run graceful shutdown cleanup.</li>
<li>Overlay cancel wiring is direct (<code>CancelButton.Click</code>) and sets <code>OverlayState.CancelRequested</code> without throwing on transient DataContext swaps.</li>
<li>Commit cleanup waits for in-flight commit work to drain before allowing shutdown.</li>
<li>Finalize actions emit explicit post-commit banners:
<ul>
<li>success banner with Applied/Failed/Skipped counts for Commit and Continue/Close</li>
<li>failure banner prefixed with <code>Commit failed.</code></li>
</ul>
</li>
<li>Failed commit attempts keep the Commit Review window open so operation errors remain visible.</li>
<li>Plan building drops style pairs outside the active Line/Object style scopes and surfaces a warning banner instead of sending unsupported style operations to commit.</li>
<li>Style mappings are normalized to projection <code>GraphicsStyle</code> IDs before planning/commit so category-ID and style-ID variants resolve to the same operation target.</li>
<li>Object-style scope is explicitly constrained to Detail Items subcategories in both usage indexing and style-plan scope resolution.</li>
<li>Usage index hydration drops out-of-universe keys so tabs never render stale style/material IDs that are not in the current preview universes.</li>
<li>Style scope/normalization now uses a shared resolver in both plan and writer paths so accepted style mappings are classified identically during commit.</li>
<li>Style writer resolution now acquires the active host document through <code>IRevitCallGate</code> before classifying source/target style scope, removing ambient-context dependency during commit.</li>
<li>Scope-mismatch handling logs resolver reasons and explicit fallback acceptance details (line/object usage-backed) to make style commit failures root-cause traceable.</li>
<li>Material mappings are validated against host-document material existence during plan build; unresolved material pairs are dropped before commit with warning feedback.</li>
<li>Family reload phases for style/material/nesting/shared-parameter embed now execute through <code>IRevitCallGate</code> without opening a host-document transaction; <code>LoadFamily</code> is guarded to fail fast if the host document is modifiable.</li>
<li>Shared-parameter host/embed writers now require <code>ISharedParameterAuthoringService</code> from DI, eliminating silent no-op behavior when authoring dependencies are missing.</li>
<li>Shared-parameter plan building validates symbol-to-family ownership before emitting embed operations, rejecting stale/mismatched SP selections pre-commit.</li>
<li>Commit and Continue runs a post-finalize refresh pipeline:
<ul>
<li>removes the current category families snapshot from session cache</li>
<li>re-scans families and refreshes usage data</li>
<li>restores expanded family row-details context so instance cyclers remain available after refresh</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MappingReportViewModel.cs:267</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MappingReportViewModel.cs:286</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MappingReportViewModel.cs:548</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/MappingReportWindow.xaml.cs:44</code><br>
<strong>Source:</strong> <code>src/DBTools.Core/Progress/Shell/ProgressOverlayControl.xaml.cs:10</code><br>
<strong>Source:</strong> <code>src/DBTools.Core/Progress/Shell/ProgressOverlayService.cs:173</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/MappingReportViewModel.cs:747</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/ReportWindowService.cs:24</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/FamiliesCategoryCacheService.cs:33</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/PlanBuildingService.cs:148</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/PlanBuildingService.cs:286</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/UsagePaneViewModel.cs:298</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Previews/StyleService.cs:83</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Usage/UsageIndexService.cs:184</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/StyleScopeResolver.cs:1</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/StyleChangeService.cs:49</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/MaterialChangeServiceWriter.cs:353</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/StyleChangeService.cs:502</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/MaterialChangeServiceWriter.cs:300</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/NestingChangeService.cs:290</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/SharedParameters/SharedParameterAuthoringService.cs:318</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/SharedParameterHostWriter.cs:15</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/SharedParameterEmbedWriter.cs:15</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Startup.cs:48</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Services/PlanBuildingService.cs:489</code></p>
</blockquote>
<h2 id="user-interface">User Interface</h2>
<p>The GM window uses a Fluent Ribbon with six main tabs:</p>
<ol>
<li><strong>Duplicates</strong> (Index 0) - Duplicate detection and resolution</li>
<li><strong>Families</strong> (Index 1) - Family/type mapping with category filtering</li>
<li><strong>Line Styles</strong> (Index 2) - Line style replacement with preview</li>
<li><strong>Object Styles</strong> (Index 3) - Object style replacement with preview</li>
<li><strong>Materials</strong> (Index 4) - Material replacement with color preview</li>
<li><strong>Shared Parameters</strong> (Index 5) - Parameter binding and authoring</li>
</ol>
<p>Each tab provides:</p>
<ul>
<li>A main DataGrid with source items and target selection dropdowns</li>
<li>Row expansion for nested details (types within families, pairs within duplicate groups)</li>
<li>Nested row-details target columns that mirror top-level target rendering (read-only display + edit-time combobox)</li>
<li>Nested target default selection logic bound to global Sort Mode + Threshold</li>
<li>Parent family target changes trigger nested target-list repopulation for expanded rows (manual/saved/externally-originated selections remain sticky)</li>
<li>Open target dropdowns own mouse-wheel scrolling while hovered; wheel input does not fall through to the host DataGrid</li>
<li>Dropdown open/close without a logical selection change does not mark rows as user-edited; non-manual rows remain eligible for threshold/sort auto-selection recompute</li>
<li>Expanded family row usage tabs (Object Styles/Materials) hydrate after usage indices load and auto-refresh in-place for currently expanded/restored rows</li>
<li>Applied-only filtering keeps externally-originated rows and usage-linked family rows visible</li>
<li>Usage-pane &quot;Families Using This...&quot; apply indicators for Object Styles and Materials read canonical usage-link state, so indicator badges stay correct even when a referenced family is outside the current Families-tab row scope.</li>
<li>Empty placeholders are routed through shell-level load-aware message properties (loading vs zero-result copy per tab).</li>
<li>Visual previews where applicable (color swatches, style weights)</li>
<li>Action buttons for staging mappings and opening Commit Review</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml:430</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.UsageAndFamilies.cs:385</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:1403</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.MappingInitAndInfrastructure.cs:255</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml.cs:424</code>
<strong>Source:</strong> <code>src/DBTools.Themes/Behaviors/MouseWheelForwarder.cs:53</code>
<strong>Source:</strong> <code>src/DBTools.Core/UI/Behaviors/ComboBoxCommitCommandBehavior.cs:16</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:1035</code></p>
</blockquote>
<h3 id="global-header-controls">Global Header Controls</h3>
<p>The header bar provides cross-tab controls:</p>
<ul>
<li><strong>Search</strong>: Filter visible items by name</li>
<li><strong>Threshold Slider</strong>: Adjust similarity scoring threshold (0-100%)</li>
<li><strong>Sort Mode</strong>: Toggle between Similarity and Alphabetical ordering</li>
<li><strong>Filters</strong>: Hide Unused, Hide Unscanned, Applied Only</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml:431</code></p>
</blockquote>
<h3 id="bottom-status-bar">Bottom Status Bar</h3>
<ul>
<li>Left status cell is a single-line composite string:
<ul>
<li><code>Global</code>: family/usage/shared-parameter readiness snapshot</li>
<li><code>Active</code>: current tab state (loading, visible rows, and apply-selected counts where applicable)</li>
</ul>
</li>
<li>Status updates on tab changes, load transitions, collection changes, and row-level mapping changes.</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:867</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/ViewModels/ShellViewModel.CoreAndCommands.cs:922</code><br>
<strong>Source:</strong> <code>src/Tools/Common/GM/Shell/Views/GmShellWindow.xaml:2756</code></p>
</blockquote>
<h2 id="architecture">Architecture</h2>
<h3 id="module-structure">Module Structure</h3>
<pre><code>src/Tools/Common/GM/
+-- GmToolModule.cs            # DI registration entry point
+-- Bootstrap/
|   +-- GmServiceExtensions.cs # Services.AddGmServices() wrapper
+-- Features/
|   +-- GmCommand.cs           # Ribbon command entry point
|   +-- Duplicates/            # Duplicate detection feature
|   +-- Families/              # Family/type mapping feature
|   +-- Mapping/               # Apply/verify mapping logic
|   +-- SavedMappings/         # Persistence layer
|   +-- SharedParameters/      # SP authoring feature
|   +-- Similarity/            # Name and parameter similarity
|   +-- Usage/                 # Usage index building
|   +-- DeepScan/              # Family document analysis
+-- Shell/
|   +-- GmShellLauncher.cs     # Window construction
|   +-- DI/Services.cs         # Full DI registration
|   +-- UI/Views/              # WPF windows and XAML
|   +-- UI/ViewModels/         # MVVM view models
|   +-- DesignTime/            # Design-time view models
+-- Shared/
|   +-- Kernel/                # Domain state (GmProjectState)
|   +-- Planning/              # Mapping plan generation
|   +-- Contracts/             # Service interfaces
|   +-- Caching/               # Cache strategies
|   +-- Context/               # Planning context
|   +-- Project/               # Project lifecycle
+-- Tests/                     # Unit and integration tests
</code></pre>
<blockquote>
<p><strong>Source:</strong> Directory structure of <code>src/Tools/Common/GM/</code></p>
</blockquote>
<h3 id="data-flow">Data Flow</h3>
<pre><code>                        +------------------+
                        |    GmCommand     |
                        +--------+---------+
                                 | Resolves services via DI
                                 v
                        +------------------+
                        | GmShellLauncher  |
                        +--------+---------+
                                 | Creates window + ViewModel
                                 v
                       +-------------------+
                       | GmShellViewModel  |
                       +--------+----------+
                                |
      +------------+------------+------------+------------+
      |            |            |            |            |
      v            v            v            v            v
+----------+ +----------+ +---------+ +----------+ +---------+
| Families | | Usage    | | Mapping | | Planning | | Kernel  |
| Pane VM  | | Pane VM  | | Service | | Service  | | State   |
+----------+ +----------+ +---------+ +----------+ +---------+
</code></pre>
<h3 id="kernel-architecture">Kernel Architecture</h3>
<p>The <code>GmProjectState</code> is the <strong>Single Source of Truth (SSOT)</strong> for GM domain state. It holds IDs only - no Revit types leak into the kernel.</p>
<pre><code class="lang-csharp">public sealed class GmProjectState
{
    public long Version { get; set; }
    public GmSourceSnapshot? SourceSnapshot { get; set; }
    public Dictionary&lt;int, GmFamilyRecord&gt; Families { get; set; }
    public GmUsageIndex Usage { get; set; }
    public GmSharedParameterLedger SharedParameters { get; set; }
    public GmTabStateSet Tabs { get; set; }
    public Dictionary&lt;int, string&gt; FamilyNames { get; set; }
    public Dictionary&lt;int, string&gt; SymbolNames { get; set; }
    public Dictionary&lt;int, IReadOnlyCollection&lt;(string, string, int)&gt;&gt; NestedOwnerNameIndex { get; set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shared/Kernel/State/GmProjectState.cs:1-32</code></p>
</blockquote>
<p>The <code>KernelMapper</code> provides read-only projections of kernel data for UI consumption. All projections are version-aware and use a generic <code>GetOrCompute&lt;T&gt;</code> caching pattern:</p>
<ul>
<li><code>GetLineStyleFamilyCounts()</code> / <code>GetObjectStyleFamilyCounts()</code> / <code>GetMaterialFamilyCounts()</code> — Usage counts per style/material</li>
<li><code>GetObjectStylesByFamilyIndex()</code> / <code>GetMaterialsByFamilyIndex()</code> — Reverse lookup: family → styles/materials</li>
<li><code>GetDeepScanStyleRefsByFamily()</code> / <code>GetDeepScanMaterialRefsByFamily()</code> — DS references by family</li>
<li><code>GetDeepScanParamNamesByFamily()</code> — DS parameter names by family</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Domain/KernelMapper.cs:54-221</code></p>
</blockquote>
<h2 id="key-classes">Key Classes</h2>
<h3 id="entry-points">Entry Points</h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GmToolModule</code></td>
<td><code>GmToolModule.cs:10-18</code></td>
<td>Tool module registration; calls <code>AddGmServices()</code></td>
</tr>
<tr>
<td><code>GmCommand</code></td>
<td><code>Features/GmCommand.cs:31-145</code></td>
<td>Ribbon command entry point; resolves all services and launches UI</td>
</tr>
<tr>
<td><code>GmShellLauncher</code></td>
<td><code>Shell/GmShellLauncher.cs:35-117</code></td>
<td>Static launcher creating <code>GmWindow</code> and <code>GmShellViewModel</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/GmToolModule.cs:10-18</code></p>
</blockquote>
<h3 id="view-models">View Models</h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GmShellViewModel</code></td>
<td><code>Shell/UI/ViewModels/GmShellViewModel.*.cs</code></td>
<td>Main shell view model (split across partials)</td>
</tr>
<tr>
<td><code>FamiliesPaneViewModel</code></td>
<td><code>Features/Families/FamiliesPaneViewModel.cs</code></td>
<td>Families tab bindings + commands</td>
</tr>
<tr>
<td><code>UsagePaneViewModel</code></td>
<td><code>Features/Usage/UsagePaneViewModel.cs</code></td>
<td>Usage mapping workflows (matches, options, commands)</td>
</tr>
<tr>
<td><code>DuplicatesPaneViewModel</code></td>
<td><code>Features/Duplicates/DuplicatesPaneViewModel.cs</code></td>
<td>Duplicates tab state</td>
</tr>
<tr>
<td><code>SharedParametersPaneViewModel</code></td>
<td><code>Features/SharedParameters/SharedParametersPaneViewModel.cs</code></td>
<td>SP tab state</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Features/Families/FamiliesPaneViewModel.cs:1</code></p>
</blockquote>
<h3 id="core-services">Core Services</h3>
<table>
<thead>
<tr>
<th>Interface</th>
<th>Implementation</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IProjectLifecycleService</code></td>
<td><code>ProjectLifecycleService</code></td>
<td>Build kernel from Revit document</td>
</tr>
<tr>
<td><code>IGmPlanningService</code></td>
<td><code>GmPlanningService</code></td>
<td>Generate normalized mapping plans</td>
</tr>
<tr>
<td><code>IGmMappingService</code></td>
<td><code>GmMappingService</code></td>
<td>Apply plans to Revit document</td>
</tr>
<tr>
<td><code>IDuplicateDetectionService</code></td>
<td><code>DuplicateDetectionService</code></td>
<td>Detect duplicate elements</td>
</tr>
<tr>
<td><code>INamingSimilarityService</code></td>
<td><code>NamingSimilarityService</code></td>
<td>Name-based similarity scoring</td>
</tr>
<tr>
<td><code>IParameterSimilarityService</code></td>
<td><code>ParameterSimilarityService</code></td>
<td>Parameter overlap scoring</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/DI/Services.cs:33-106</code></p>
</blockquote>
<h3 id="revit-adapters-change-writers">Revit Adapters (Change Writers)</h3>
<p>All change writers implement <code>IChangeWriter</code> and are dispatched by <code>ChangeApplyEngine</code> via <code>ChangeKind</code>. Individual per-writer interfaces have been removed.</p>
<table>
<thead>
<tr>
<th>Implementation</th>
<th>ChangeKind</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TypeChangeService</code></td>
<td><code>Type</code></td>
<td>Replace type on instances</td>
</tr>
<tr>
<td><code>StyleChangeService</code></td>
<td><code>Style</code></td>
<td>Replace line styles on host curves and rewrite Detail Items object-style references in affected family documents; creates missing target subcategories in family docs and syncs core appearance before rewrites/reload</td>
</tr>
<tr>
<td><code>MaterialChangeServiceWriter</code></td>
<td><code>Material</code></td>
<td>Replace host material parameters and rewrite family-document material parameters in affected families; creates/syncs missing family target materials before replacement</td>
</tr>
<tr>
<td><code>ParameterChangeService</code></td>
<td><code>Parameter</code></td>
<td>Copy type parameters</td>
</tr>
<tr>
<td><code>HostChangeService</code></td>
<td><code>Host</code></td>
<td>Handle host/placement changes</td>
</tr>
<tr>
<td><code>NestingChangeService</code></td>
<td><code>Nesting</code></td>
<td>Replace nested families by name</td>
</tr>
<tr>
<td><code>TypeCreationService</code></td>
<td><code>TypeCreation</code></td>
<td>Create new type symbols</td>
</tr>
<tr>
<td><code>DeepScanServiceAdapter</code></td>
<td>—</td>
<td>Deep scan family documents (not a change writer)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/IChangeWriter.cs</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/ChangeApplyEngine.cs</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/StyleChangeService.cs</code>
<strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/Writers/MaterialChangeServiceWriter.cs</code></p>
</blockquote>
<h2 id="configuration">Configuration</h2>
<h3 id="manifest">Manifest</h3>
<pre><code class="lang-yaml">id: DBTools.GM
assembly: DBTools
moduleType: DBTools.GM.GmToolModule
order: 0
sandboxWindows:
  - id: DBTools.GM.Main
    displayName: &quot;Global Mapper&quot;
    group: &quot;Common&quot;
    windowType: &quot;DBTools.GM.Shell.Views.GmShellWindow&quot;
    designTimeViewModelType: &quot;DBTools.GM.Shell.DesignTime.ShellDesignTimeViewModel&quot;
  - id: DBTools.GM.MappingReport
    displayName: &quot;Global Mapper - Commit Review&quot;
    group: &quot;Common&quot;
    windowType: &quot;DBTools.GM.Shell.Views.MappingReportWindow&quot;
    designTimeViewModelType: &quot;DBTools.GM.Shell.DesignTime.MappingReportDesignTimeViewModel&quot;
tool:
  ribbonTools:
    - internalName: DBTools.GM
      commandType: DBTools.GM.Shell.GmCommand
      availabilityType: DBTools.App.Availability.DocumentAvailability
      runProfile: QueuedModeless
      displayText: &quot;Global Mapper&quot;
      iconBaseKey: gm
      tooltip: &quot;Open Global Mapper&quot;
      controlKind: PushButton
      order: 30
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/manifest.yml:1-26</code></p>
</blockquote>
<h3 id="caching">Caching</h3>
<p>GM uses project-scoped caching strategies:</p>
<table>
<thead>
<tr>
<th>Cache</th>
<th>Strategy</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deep Scan</td>
<td><code>DeepScanCacheStrategy</code></td>
<td>Cache family document scan results</td>
</tr>
<tr>
<td>UI State</td>
<td><code>UiStateStrategy</code></td>
<td>Persist UI selections between sessions</td>
</tr>
<tr>
<td>Saved Mappings</td>
<td><code>SavedMappingService</code></td>
<td>Store user mapping preferences</td>
</tr>
</tbody>
</table>
<p>Cache files are stored under <code>%LocalAppData%/DBTools/GM/</code>.</p>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/DI/Services.cs:97-105</code></p>
</blockquote>
<h2 id="api-reference">API Reference</h2>
<h3 id="planning-service">Planning Service</h3>
<p>The <code>IGmPlanningService</code> generates normalized mapping plans:</p>
<pre><code class="lang-csharp">public interface IGmPlanningService
{
    Task&lt;GmPlanningResult&gt; BuildPlanAsync(
        IReadOnlyDictionary&lt;int, int&gt; typeMappings,
        IReadOnlyDictionary&lt;int, int&gt; materialMappings,
        IReadOnlyDictionary&lt;int, int&gt; styleMappings,
        CancellationToken ct = default);

    Task&lt;GmPlanningResult&gt; BuildPlanAsync(
        IReadOnlyDictionary&lt;int, int&gt; typeMappings,
        IReadOnlyDictionary&lt;int, int&gt; materialMappings,
        IReadOnlyDictionary&lt;int, int&gt; styleMappings,
        IReadOnlyDictionary&lt;int, int&gt; paramMappings,
        IReadOnlyCollection&lt;(int sourceId, string? newName)&gt; createType,
        IGmContext? context,
        CancellationToken ct = default);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shared/Planning/IGmPlanningService.cs:8-28</code></p>
</blockquote>
<h3 id="operation-kinds">Operation Kinds</h3>
<p>Plans contain operations of these types:</p>
<pre><code class="lang-csharp">public enum GmOperationKind
{
    ReplaceType,          // Replace type on family instances
    ReplaceMaterial,      // Replace material parameters
    ReplaceStyle,         // Replace line/object styles
    MapParameter,         // Copy parameter values between types
    AddNestedFamily,      // Add nested family replacement (by name)
    ReplaceHost,          // Handle host/placement mismatches
    CreateType,           // Create new type symbol
    BindSharedParameter,  // Bind SP at host level
    EmbedSharedParameter  // Embed SP in family document
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shared/Planning/GmOperationKind.cs:3-14</code></p>
</blockquote>
<h3 id="mapping-service">Mapping Service</h3>
<p>The <code>IGmMappingService</code> applies plans to the Revit document:</p>
<pre><code class="lang-csharp">public interface IGmMappingService
{
    Task ImportAsync(string path, CancellationToken ct = default);
    Task ExportAsync(string path, CancellationToken ct = default);
    Task ImportSimpleAsync(string path, CancellationToken ct = default);
    Task ExportSimpleAsync(string path, CancellationToken ct = default);
    Task&lt;GmMappingValidationResult&gt; ValidateAsync(CancellationToken ct = default);
    Task&lt;GmMappingApplyResult&gt; ApplyAsync(CancellationToken ct = default);
    Task&lt;GmMappingApplyResult&gt; ApplyPlanAsync(GmPlanningResult plan, IProgress&lt;string&gt;? progress = null,
        CancellationToken ct = default);
    Task&lt;GmMappingVerifyResult&gt; VerifyAsync(GmPlanningResult plan, CancellationToken ct = default);
    Task AddDuplicateMappingsAsync(GmDuplicateApplyBatch batch, CancellationToken ct = default);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Features/Mapping/IGmMappingService.cs:12-27</code></p>
</blockquote>
<h3 id="duplicate-detection">Duplicate Detection</h3>
<p>The <code>IDuplicateDetectionService</code> analyzes the kernel for potential duplicates:</p>
<pre><code class="lang-csharp">public interface IDuplicateDetectionService
{
    Task&lt;DuplicateDetectionResult&gt; DetectAsync(GmProjectState kernel, CancellationToken ct = default);
}
</code></pre>
<p>Detection uses:</p>
<ul>
<li><strong>Families</strong>: 70% name similarity + 30% parameter overlap (when DS data available)</li>
<li><strong>Styles</strong>: Preview signature matching (color, weight, pattern)</li>
<li><strong>Materials</strong>: Preview + name similarity</li>
<li><strong>Shared Parameters</strong>: Type display + normalized name</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Features/Duplicates/Logic/DuplicateDetectionService.cs:43-98</code></p>
</blockquote>
<h2 id="testing">Testing</h2>
<p>GM tests use a shared fixture that opens a dedicated test model:</p>
<pre><code class="lang-csharp">[NonParallelizable]
public abstract class GmTestFixture
{
    protected const string GmModelFileName = &quot;gm_test_model.rvt&quot;;
    protected UIApplication UiApp { get; private set; }
    protected Document? Doc { get; private set; }
    protected IRevitCallGate? Gate { get; private set; }
    protected ITransactionRunner? TxRunner { get; private set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Tests/GMTestFixture.cs:20-53</code></p>
</blockquote>
<h3 id="test-categories">Test Categories</h3>
<table>
<thead>
<tr>
<th>Test Class</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GM_PlanningServiceTests</code></td>
<td>Planning result validation</td>
</tr>
<tr>
<td><code>GM_MappingServiceTests</code></td>
<td>Apply/verify cycle testing</td>
</tr>
<tr>
<td><code>GM_MappingApplyPlanTests</code></td>
<td>End-to-end plan application</td>
</tr>
<tr>
<td><code>DuplicateDetectionServiceTests</code></td>
<td>Duplicate detection accuracy</td>
</tr>
<tr>
<td><code>GmKernelMapperTests</code></td>
<td>Kernel projection correctness</td>
</tr>
<tr>
<td><code>GmWindowViewModel_*Tests</code></td>
<td>ViewModel behavior tests</td>
</tr>
</tbody>
</table>
<h3 id="running-tests">Running Tests</h3>
<pre><code class="lang-bash"># Build test assemblies
bash build.sh BuildTests

# Run via Revit test runner
bash invoke-revit-tests.sh --smart --tool GM -y 2025
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="common-issues">Common Issues</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>&quot;No families found&quot;</td>
<td>Category filter too restrictive</td>
<td>Select a different category or clear filters</td>
</tr>
<tr>
<td>Empty duplicate groups</td>
<td>Similarity threshold too high</td>
<td>Lower the threshold slider</td>
</tr>
<tr>
<td>Deep scan incomplete</td>
<td>Family document errors</td>
<td>Check Revit error log; try manual deep scan</td>
</tr>
<tr>
<td>Mapping not applied</td>
<td>Target type not available</td>
<td>Verify target family is loaded in project</td>
</tr>
<tr>
<td>Conflict panel showing</td>
<td>Multiple sources map to same target</td>
<td>Resolve conflicts in conflict panel</td>
</tr>
</tbody>
</table>
<h3 id="logging">Logging</h3>
<p>GM logs diagnostic information via <code>ILogger</code>. Enable debug logging to see:</p>
<ul>
<li>Kernel build timing</li>
<li>Cache hit/miss statistics</li>
<li>Plan operation details</li>
<li>Apply stage progress</li>
</ul>
<pre><code class="lang-csharp">_logger.LogDebug(&quot;GM: scanned {Count} families for categoryId={CategoryId}&quot;, 
    families.Count, SelectedCategory?.Id);
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>src/Tools/Common/GM/Shell/UI/ViewModels/GmShellViewModel.CoreAndCommands.cs:1043-1045</code></p>
</blockquote>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../../architecture/overview.html">Architecture Overview</a> - DBTools architecture</li>
<li><a href="../../projects/core.html">DBTools.Core</a> - Core infrastructure</li>
<li><a href="../../architecture/test-pipeline.html">Test Pipeline</a> - Test infrastructure</li>
</ul>
<hr>
<h2 id="verification-status">Verification Status</h2>
<table>
<thead>
<tr>
<th>Check</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source anchors for all claims</td>
<td>Yes</td>
</tr>
<tr>
<td>UNVERIFIED markers where needed</td>
<td>No (all verified)</td>
</tr>
<tr>
<td>Cross-references added</td>
<td>Yes</td>
</tr>
<tr>
<td>Examples tested</td>
<td>N/A</td>
</tr>
<tr>
<td>No assumptions without evidence</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Verified by:</strong> docs-run-20260124-020412<br>
<strong>Date:</strong> 2026-01-24</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/dev/wiki/developer-guide/tools/common/gm.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
