<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>DBTools.Core | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="DBTools.Core | DB Tools ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css?v=20260125">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/projects/core.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../public/main.js?v=20260125" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" src="../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="dbtoolscore">DBTools.Core</h1>

<!-- STATUS: draft -->
<!-- Last Updated: 2026-01-24 -->
<!-- Verified By: docs-run-20260124-020412 -->
<p>DBTools.Core is the foundational library providing shared infrastructure for all DBTools components. It contains Revit execution abstractions, transaction management, safe execution patterns, logging infrastructure, settings management, tool module system, and shared UI components.</p>
<h2 id="overview">Overview</h2>
<p>DBTools.Core serves as the central infrastructure layer, abstracting away Revit API complexities while providing consistent patterns for error handling, logging, and dependency injection across all tools.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Assembly Name</strong></td>
<td><code>DBTools.Core.dll</code></td>
</tr>
<tr>
<td><strong>Target Frameworks</strong></td>
<td><code>net48</code>, <code>net8.0-windows</code></td>
</tr>
<tr>
<td><strong>WPF Support</strong></td>
<td>Yes (<code>UseWPF=true</code>)</td>
</tr>
<tr>
<td><strong>Nullable</strong></td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:1-10</code></p>
</blockquote>
<h2 id="responsibilities">Responsibilities</h2>
<ol>
<li><strong>Revit Execution Abstraction</strong> - Thread-safe API access via call gates and run scopes</li>
<li><strong>Transaction Management</strong> - Unified transaction/subtransaction handling with automatic rollback</li>
<li><strong>Safe Execution</strong> - Centralized error handling with user notification and logging</li>
<li><strong>Logging Infrastructure</strong> - Serilog-based structured logging with UI sink</li>
<li><strong>Settings System</strong> - Type-safe options pattern with persistence and validation</li>
<li><strong>Tool Module System</strong> - Discovery, registration, and lifecycle management for tools</li>
<li><strong>Shared UI Components</strong> - Window bases, alert dialogs, progress overlays, and behaviors</li>
</ol>
<h2 id="key-components">Key Components</h2>
<h3 id="revit-execution-layer">Revit Execution Layer</h3>
<h4 id="irevitcallgate">IRevitCallGate</h4>
<p>The unified entry point for executing Revit API callbacks, supporting both inline (modal) and queued (modeless) execution modes.</p>
<pre><code class="lang-csharp">public interface IRevitCallGate
{
    bool InGate { get; }
    Task&lt;T&gt; RunAsync&lt;T&gt;(Func&lt;UIApplication, T&gt; work, CancellationToken ct = default,
        RevitCallMode mode = RevitCallMode.Auto);
    Task RunAsync(Action&lt;UIApplication&gt; work, CancellationToken ct = default,
        RevitCallMode mode = RevitCallMode.Auto);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/IRevitCallGate.cs:8-28</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Auto</code></td>
<td>Execute inline if valid context exists; otherwise queue</td>
</tr>
<tr>
<td><code>InlineOnly</code></td>
<td>Execute inline only; throw if context unavailable</td>
</tr>
<tr>
<td><code>ForceQueue</code></td>
<td>Always queue via ExternalEvent/RevitTask</td>
</tr>
<tr>
<td><code>RequiresActiveView</code></td>
<td>Require an active UIDocument before executing</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/IRevitCallGate.cs:30-51</code></p>
</blockquote>
<h4 id="irevitrunscope">IRevitRunScope</h4>
<p>Represents a single Revit run scope (command, modeless session, or test). Owns UI/document context plus call gate and transaction services.</p>
<pre><code class="lang-csharp">public interface IRevitRunScope
{
    UIApplication UIApplication { get; }
    IRevitCallGate CallGate { get; }
    ITransactionRunner TransactionRunner { get; }
    ITransactionGroupService TransactionGroupService { get; }
    UIDocument GetActiveUiDocument();
    Document GetActiveDocument();
    Document GetLockedDocument(Document expectedDocument, string? context = null);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/IRevitRunScope.cs:11-20</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>Profile</th>
<th>Use Case</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>InlineUi</code></td>
<td>Modal commands and RevitTest</td>
<td><code>ModalInlineCallGate</code> + <code>CallGateTransactionRunner</code></td>
</tr>
<tr>
<td><code>QueuedModeless</code></td>
<td>Long-running/modeless tools</td>
<td><code>ModelessQueuedCallGate</code> + RevitTaskService</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/IRevitRunScope.cs:22-36</code></p>
</blockquote>
<h4 id="modalinlinecallgate">ModalInlineCallGate</h4>
<p>Call-gate implementation that executes delegates inline on the Revit UI thread using a supplied UIApplication. Used for modal command execution.</p>
<pre><code class="lang-csharp">public sealed class ModalInlineCallGate : IRevitCallGate
{
    public ModalInlineCallGate(UIApplication uiapp) { ... }
    public bool InGate =&gt; _inGate.Value;
    public Task&lt;T&gt; RunAsync&lt;T&gt;(Func&lt;UIApplication, T&gt; work, ...) { ... }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/ModalInlineCallGate.cs:10-74</code></p>
</blockquote>
<h3 id="transaction-management">Transaction Management</h3>
<h4 id="itransactionrunner">ITransactionRunner</h4>
<p>Provides a unified API for executing Revit model modifications with automatic transaction management.</p>
<pre><code class="lang-csharp">public interface ITransactionRunner
{
    Task RunAsync(string name, Action action, CancellationToken ct = default);
    Task&lt;T&gt; RunAsync&lt;T&gt;(string name, Func&lt;T&gt; action, CancellationToken ct = default);
    Task RunAsync(string name, Action&lt;Document&gt; action, CancellationToken ct = default);
    Task&lt;T&gt; RunAsync&lt;T&gt;(string name, Func&lt;Document, T&gt; action, CancellationToken ct = default);
    // Additional overloads with UIApplication access and explicit Document
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Transactions/ITransactionRunner.cs:6-53</code></p>
</blockquote>
<h4 id="callgatetransactionrunner">CallGateTransactionRunner</h4>
<p>The primary implementation that wraps all Revit API calls in properly managed transactions:</p>
<ul>
<li><strong>Auto-selects transaction type</strong>: Uses <code>SubTransaction</code> if <code>doc.IsModifiable</code> (already in transaction), otherwise creates new <code>Transaction</code></li>
<li><strong>Cross-document protection</strong>: Prevents starting transactions on Document B while Document A is modifiable</li>
<li><strong>Failure handling</strong>: Attaches <code>SilentFailuresPreprocessor</code> to suppress non-critical Revit warnings</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Transactions/CallGateTransactionRunner.cs:9-390</code></p>
</blockquote>
<p><strong>Usage Example:</strong></p>
<pre><code class="lang-csharp">// Basic modification with automatic transaction
await _transactionRunner.RunAsync(&quot;Create Wall&quot;, doc =&gt;
{
    Wall.Create(doc, curve, levelId, false);
});

// Get a result from a transaction
var wallId = await _transactionRunner.RunAsync(&quot;Create Wall&quot;, doc =&gt;
{
    var wall = Wall.Create(doc, curve, levelId, false);
    return wall.Id;
});
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Transactions/CallGateTransactionRunner.cs:64-79</code></p>
</blockquote>
<h4 id="itransactiongroupservice">ITransactionGroupService</h4>
<p>Manages transaction groups for operations requiring multiple undoable transactions to appear as a single undo item.</p>
<pre><code class="lang-csharp">public interface ITransactionGroupService
{
    bool IsActive { get; }
    Task BeginAsync(string name, CancellationToken ct = default);
    Task FinalizeAsync(bool commit, CancellationToken ct = default);
    Task RunAsync(string name, bool commit, Func&lt;Task&gt; work, CancellationToken ct = default);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Transactions/ITransactionGroupService.cs:1-14</code></p>
</blockquote>
<h3 id="safe-execution">Safe Execution</h3>
<h4 id="isafeexecutor">ISafeExecutor</h4>
<p>The central error handling service. All tool entrypoints must execute within <code>ISafeExecutor</code>.</p>
<pre><code class="lang-csharp">public interface ISafeExecutor
{
    Task RunAsync(Func&lt;Task&gt; action, ILogger logger, IErrorNotifier? notifier = null,
        CancellationToken ct = default);
    Task RunAsync(Func&lt;Task&gt; action, ILogger logger, IErrorNotifier? notifier,
        SafeExecutor.SafeExecuteOptions? opts, CancellationToken ct = default);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Execution/ISafeExecutor.cs:6-16</code></p>
</blockquote>
<h4 id="safeexecutor-implementation">SafeExecutor Implementation</h4>
<p>Provides comprehensive error handling:</p>
<ul>
<li><strong>Correlation IDs</strong>: Each execution gets a unique GUID for log correlation</li>
<li><strong>Timing</strong>: Tracks elapsed milliseconds for performance analysis</li>
<li><strong>Exception logging</strong>: Logs full exception details including inner exceptions and XAML parse context</li>
<li><strong>User notification</strong>: Shows error banners via <code>IErrorNotifier</code></li>
<li><strong>Debug mode</strong>: Automatically enables debug mode and shows logger window on fatal errors</li>
<li><strong>Lifecycle hooks</strong>: Optional <code>OnSuccessAsync</code>, <code>OnCancelAsync</code>, <code>OnErrorAsync</code> callbacks</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Execution/SafeExecutor.cs:12-467</code></p>
</blockquote>
<p><strong>SafeExecuteOptions:</strong></p>
<pre><code class="lang-csharp">public sealed class SafeExecuteOptions
{
    public string? Name { get; set; }
    public bool LogStart { get; set; } = true;
    public bool ShowCompletionToUser { get; set; }
    public Guid? CorrelationId { get; set; }
    public Func&lt;Task&gt;? OnSuccessAsync { get; set; }
    public Func&lt;Task&gt;? OnCancelAsync { get; set; }
    public Func&lt;Exception, Task&gt;? OnErrorAsync { get; set; }
    public NotifyKindKind NotifyKind { get; set; } = NotifyKindKind.Success;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Execution/SafeExecutor.cs:451-466</code></p>
</blockquote>
<h3 id="dbttoolcommand-base-class">DbtToolCommand Base Class</h3>
<p>Abstract base class for Revit commands that enforces <code>ISafeExecutor</code> usage, run-scope creation, and centralized error notification.</p>
<pre><code class="lang-csharp">public abstract class DbtToolCommand : IExternalCommand
{
    public Result Execute(ExternalCommandData commandData, ref string message, ElementSet elements)
    {
        // Wraps execution in ISafeExecutor, creates run scope
    }
    
    protected abstract Task RunAsync(IDbtToolContext context);
    
    // Convenience methods
    protected static T GetService&lt;T&gt;(IDbtToolContext context) where T : notnull;
    protected static Task&lt;T&gt; RunInRevitAsync&lt;T&gt;(IDbtToolContext context, Func&lt;UIApplication, T&gt; work, ...);
    protected static bool? ShowToolWindow&lt;TWindow&gt;(Func&lt;TWindow&gt; windowFactory) where TWindow : Window;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/DbtToolCommand.cs:35-238</code></p>
</blockquote>
<h3 id="tool-context">Tool Context</h3>
<h4 id="idbttoolcontext">IDbtToolContext</h4>
<p>Ambient context provided to DBT tool commands, wrapping the current Revit run scope, DI scope, and shared services.</p>
<pre><code class="lang-csharp">public interface IDbtToolContext
{
    ExternalCommandData CommandData { get; }
    UIApplication UIApplication { get; }
    UIDocument UIDocument { get; }
    Document Document { get; }
    IAppRunScope RunScope { get; }
    IRevitRunScope RevitRunScope { get; }
    ILogger Logger { get; }
    IErrorNotifier ErrorNotifier { get; }
    RevitRunScopeProfile RunProfile { get; }
    T Resolve&lt;T&gt;() where T : notnull;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Revit/Execution/IDbtToolContext.cs:14-27</code></p>
</blockquote>
<h3 id="runtime">Runtime</h3>
<h4 id="appruntime">AppRuntime</h4>
<p>Static accessor for the application runtime. Provides global access to services when DI is not available (e.g., Revit's parameterless constructor requirement).</p>
<pre><code class="lang-csharp">public static class AppRuntime
{
    public static bool IsInitialized { get; }
    public static void Initialize(IAppRuntime runtime);
    public static void InitializeIfNeeded(Func&lt;IAppRuntime&gt; factory);
    public static ILogger Logger { get; }
    public static ISettingsProvider Settings { get; }
    public static IAppRunScope CreateRunScope(UIApplication uiapp, RevitRunScopeProfile profile);
    public static T Resolve&lt;T&gt;() where T : notnull;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Runtime/AppRuntime.cs:8-155</code></p>
</blockquote>
<h4 id="iappruntime">IAppRuntime</h4>
<p>Interface for the application runtime container.</p>
<pre><code class="lang-csharp">public interface IAppRuntime
{
    ILogger Logger { get; }
    ISettingsProvider Settings { get; }
    IAppRunScope CreateRunScope(UIApplication uiapp, RevitRunScopeProfile profile);
    T Resolve&lt;T&gt;() where T : notnull;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Runtime/IAppRuntime.cs:8-16</code></p>
</blockquote>
<h4 id="iapprunscope">IAppRunScope</h4>
<p>Scoped DI container for per-command lifetimes.</p>
<pre><code class="lang-csharp">public interface IAppRunScope : IDisposable
{
    T Resolve&lt;T&gt;() where T : notnull;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Runtime/IAppRunScope.cs:5-8</code></p>
</blockquote>
<h3 id="logging-infrastructure">Logging Infrastructure</h3>
<h4 id="idbtlogginghost">IDbtLoggingHost</h4>
<p>Central logging host that implements <code>ILoggerFactory</code> directly.</p>
<pre><code class="lang-csharp">public interface IDbtLoggingHost : ILoggerFactory, IDisposable
{
    SerilogUiSink UiSink { get; }
    bool IsDebugMode { get; }
    void SetDebugMode(bool enabled);
    ILoggerFactory LoggerFactory { get; }
    string InstanceId { get; }
    int? RevitYear { get; }
    string? LogFilePath { get; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Logging/DbtLoggingHost.cs:21-33</code></p>
</blockquote>
<h4 id="dbtlogginghost-implementation">DbtLoggingHost Implementation</h4>
<p>Features:</p>
<ul>
<li><strong>Serilog integration</strong>: Uses Serilog with structured logging</li>
<li><strong>UI sink</strong>: Feeds log entries to the Logger Window</li>
<li><strong>File sink</strong>: Custom <code>DbtTextFileSink</code> avoids version conflicts with Serilog.Sinks.File</li>
<li><strong>Thread enrichment</strong>: Adds thread ID to all log entries</li>
<li><strong>Instance identification</strong>: Unique instance ID per Revit process</li>
<li><strong>Log rotation</strong>: Automatic cleanup of old log files by age, count, and total size</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Logging/DbtLoggingHost.cs:35-226</code></p>
</blockquote>
<p><strong>Log File Naming:</strong></p>
<pre><code>dbtools-{revitYear}-{instanceId}-{timestamp}-{nonce}.log
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Logging/DbtLoggingHost.cs:88-100</code></p>
</blockquote>
<h3 id="settings-system">Settings System</h3>
<h4 id="isettingsprovider">ISettingsProvider</h4>
<p>Interface for reading and persisting settings.</p>
<pre><code class="lang-csharp">public interface ISettingsProvider
{
    TSettings Get&lt;TSettings&gt;() where TSettings : class, new();
    Task SaveAsync&lt;TSettings&gt;(string section, TSettings settings, CancellationToken ct = default)
        where TSettings : class;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Settings/ISettingsProvider.cs:1-8</code></p>
</blockquote>
<h4 id="dbtsettingsregistry">DbtSettingsRegistry</h4>
<p>Registry for settings pack definitions, enabling the Settings Window to discover and display tool-specific settings.</p>
<pre><code class="lang-csharp">public sealed class DbtSettingsRegistry
{
    public IReadOnlyCollection&lt;IDbtSettingsPackDefinition&gt; Definitions { get; }
    public void Register(IDbtSettingsPackDefinition definition);
    public bool Unregister(string key);
    public IEnumerable&lt;IDbtSettingsPackDefinition&gt; ForPanel(string ribbonPanel);
    public IEnumerable&lt;IDbtSettingsWarningDefinition&gt; WarningDefinitions();
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Settings/DbtSettingsRegistry.cs:8-62</code></p>
</blockquote>
<h4 id="dbttoolsettingspack">DbtToolSettingsPack</h4>
<p>Generic container for tool settings with validation support.</p>
<pre><code class="lang-csharp">public sealed class DbtToolSettingsPack&lt;TOptions&gt; : IDbtToolSettingsPack
{
    public string Key { get; }
    public string Title { get; }
    public string RibbonPanel { get; }
    public Type OptionsType { get; }
    public object Context { get; }
    public object CreateDefaultOptions();
    public object BuildOptionsSnapshot();
    public Task&lt;DbtSettingsValidationResult&gt; ValidateAsync(CancellationToken ct = default);
    public FrameworkElement View { get; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Settings/DbtToolSettingsPack.cs:37-85</code></p>
</blockquote>
<h3 id="tool-module-system">Tool Module System</h3>
<h4 id="dbttoolmodule">DbtToolModule</h4>
<p>Base class for tool modules to contribute DI services and tool registrations.</p>
<pre><code class="lang-csharp">public abstract class DbtToolModule
{
    public virtual void RegisterSettings(IServiceCollection services, IConfiguration configuration,
        DbtToolManifest manifest) { }
    public virtual void RegisterServices(IServiceCollection services, DbtToolManifest manifest) { }
    public virtual void RegisterSettingsPacks(IServiceCollection services, DbtToolManifest manifest) { }
    public virtual void RegisterHooks(DbtToolRegistry registry, DbtToolManifest manifest) { }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolModule.cs:9-49</code></p>
</blockquote>
<h4 id="dbttoolregistry">DbtToolRegistry</h4>
<p>Central registry for tool registrations and hook handlers.</p>
<pre><code class="lang-csharp">public sealed class DbtToolRegistry
{
    public ReadOnlyCollection&lt;DbtToolRegistration&gt; Tools { get; }
    public IReadOnlyDictionary&lt;Type, IReadOnlyCollection&lt;Type&gt;&gt; HookRegistrations { get; }
    public void RegisterTool(DbtToolRegistration registration);
    public void RegisterHook&lt;THook, TImplementation&gt;() where THook : class where TImplementation : class, THook;
    public Type[] GetHookImplementations&lt;THook&gt;() where THook : class;
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolRegistry.cs:9-83</code></p>
</blockquote>
<h4 id="dbttoolregistration">DbtToolRegistration</h4>
<p>Encapsulates a tool command registration with ribbon configuration.</p>
<pre><code class="lang-csharp">public sealed class DbtToolRegistration
{
    public Type CommandType { get; }
    public Type? AvailabilityType { get; }
    public RevitRunScopeProfile RunProfile { get; }
    public DbtToolRibbonSpec Ribbon { get; }
    public Func&lt;Flags, bool&gt;? AvailabilityPredicate { get; init; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolRegistration.cs:8-38</code></p>
</blockquote>
<h4 id="dbttoolmanifest">DbtToolManifest</h4>
<p>YAML manifest structure for tool discovery.</p>
<pre><code class="lang-csharp">public sealed class DbtToolManifest
{
    public string Id { get; set; }
    public string Assembly { get; set; }
    public string ModuleType { get; set; }
    public int? Order { get; set; }
    public List&lt;DbtSandboxWindowManifest&gt;? SandboxWindows { get; set; }
    public DbtToolMetadataManifest? Tool { get; set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolManifest.cs:5-13</code></p>
</blockquote>
<h4 id="dbthookhost">DbtHookHost</h4>
<p>Coordinates application-level hooks, dispatching events to registered handlers.</p>
<p><strong>Supported Hook Interfaces:</strong></p>
<ul>
<li><code>IViewActivatedHookHandler</code> - Called when views are activated</li>
<li><code>IContextualRibbonInjector</code> - For contextual ribbon panel initialization</li>
</ul>
<pre><code class="lang-csharp">public sealed class DbtHookHost
{
    public void Attach(UIControlledApplication application);
    public Task AttachAsync(UIControlledApplication application, CancellationToken ct);
    public void Detach(UIControlledApplication application);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtHookHost.cs:28-244</code></p>
</blockquote>
<h3 id="ui-components">UI Components</h3>
<h4 id="dbtwindowbase">DbtWindowBase</h4>
<p>Modal-first base window for DBT. Hosts the progress overlay and central UI error boundary.</p>
<pre><code class="lang-csharp">public class DbtWindowBase : Window, IWindowWithOwnerProvider, IThemeOptOut
{
    public IWindowOwnerProvider? OwnerProvider { get; set; }
    public bool UseDefaultTheme { get; set; }
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Windows/DbtWindowBase.cs:27-47</code></p>
</blockquote>
<h4 id="ialertservice">IAlertService</h4>
<p>Service for showing alert dialogs with various body types.</p>
<pre><code class="lang-csharp">public interface IAlertService
{
    AlertResult Show(AlertRequest request);
    bool Confirm(string message, string title = &quot;DB Tools&quot;);
    T? SelectSingle&lt;T&gt;(IEnumerable&lt;T&gt; items, Func&lt;T, string&gt; displayFunc, ...);
    IReadOnlyList&lt;T&gt; SelectMultiple&lt;T&gt;(IEnumerable&lt;T&gt; items, Func&lt;T, string&gt; displayFunc, ...);
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/UI/Alerts/Services/IAlertService.cs:5-26</code></p>
</blockquote>
<h4 id="ierrornotifier">IErrorNotifier</h4>
<p>Interface for displaying error/success banners to users.</p>
<pre><code class="lang-csharp">public interface IErrorNotifier
{
    void ShowBanner(string title, string message);      // Error (red)
    void ShowSuccessBanner(string title, string message); // Success (green)
}
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Execution/IErrorNotifier.cs:1-10</code></p>
</blockquote>
<h2 id="dependencies">Dependencies</h2>
<h3 id="nuget-packages">NuGet Packages</h3>
<table>
<thead>
<tr>
<th>Package</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Newtonsoft.Json</code></td>
<td>JSON serialization</td>
</tr>
<tr>
<td><code>CSharpFunctionalExtensions</code></td>
<td>Result types and functional patterns</td>
</tr>
<tr>
<td><code>Ardalis.GuardClauses</code></td>
<td>Argument validation</td>
</tr>
<tr>
<td><code>AutoMapper</code></td>
<td>Object mapping</td>
</tr>
<tr>
<td><code>UnitsNet</code></td>
<td>Units and measurements</td>
</tr>
<tr>
<td><code>Serilog</code> + extensions</td>
<td>Structured logging</td>
</tr>
<tr>
<td><code>Microsoft.Extensions.DependencyInjection</code></td>
<td>Dependency injection</td>
</tr>
<tr>
<td><code>Microsoft.Extensions.Configuration.*</code></td>
<td>Configuration binding</td>
</tr>
<tr>
<td><code>CommunityToolkit.Mvvm</code></td>
<td>MVVM base classes</td>
</tr>
<tr>
<td><code>DynamicData</code></td>
<td>Reactive collections</td>
</tr>
<tr>
<td><code>System.Reactive</code></td>
<td>Reactive extensions</td>
</tr>
<tr>
<td><code>Ookii.Dialogs.Wpf</code></td>
<td>Native file dialogs</td>
</tr>
<tr>
<td><code>ricaun.Revit.UI.Tasks</code></td>
<td>Revit async task support</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:102-161</code></p>
</blockquote>
<h3 id="vendored-assemblies">Vendored Assemblies</h3>
<table>
<thead>
<tr>
<th>Assembly</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DBTools.Fluent.Ribbon</code></td>
<td>Ribbon UI for tool windows</td>
</tr>
<tr>
<td><code>DBTools.ControlzEx</code></td>
<td>Window chrome and behaviors</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:144-152</code></p>
</blockquote>
<h3 id="project-references">Project References</h3>
<table>
<thead>
<tr>
<th>Project</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DBTools.Themes</code></td>
<td>WPF theme resources</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:165</code></p>
</blockquote>
<h2 id="directory-structure">Directory Structure</h2>
<pre><code>DBTools.Core/
+-- Assets/           # Shared resources (icons)
+-- Compat/           # Cross-framework compatibility utilities
+-- Constants/        # Application-wide constants
+-- Execution/        # Safe execution, error handling
+-- Hosting/          # Service hosting infrastructure
+-- IO/               # File system utilities
+-- Logging/          # Serilog infrastructure, UI sink
+-- Notifications/    # Banner notifications
+-- Revit/
|   +-- Context/      # Revit context accessors
|   +-- Execution/    # Call gates, run scopes, tool context
|   +-- Transactions/ # Transaction runners and groups
|   +-- Utilities/    # Revit helpers (RevitId, Failures, etc.)
+-- Runtime/          # AppRuntime, IAppRunScope
+-- Sandbox/          # Sandbox mode stubs
+-- Settings/         # Settings infrastructure
+-- Tools/            # Tool module system
+-- UI/
    +-- Alerts/       # Alert dialog system
    +-- Behaviors/    # WPF attached behaviors
    +-- Converters/   # Value converters
    +-- Icons/        # Icon loading
    +-- Progress/     # Progress overlay
    +-- Theming/      # Theme validation
    +-- Windows/      # Window base classes
</code></pre>
<h2 id="public-api-summary">Public API Summary</h2>
<h3 id="revit-execution">Revit Execution</h3>
<ul>
<li><code>IRevitCallGate</code> - Thread-safe Revit API execution</li>
<li><code>IRevitRunScope</code> - Command execution scope</li>
<li><code>IRevitRunScopeFactory</code> - Factory for run scopes</li>
<li><code>DbtToolCommand</code> - Base class for Revit commands</li>
<li><code>IDbtToolContext</code> - Command context interface</li>
</ul>
<h3 id="transaction-management-1">Transaction Management</h3>
<ul>
<li><code>ITransactionRunner</code> - Transaction execution</li>
<li><code>ITransactionGroupService</code> - Transaction grouping</li>
</ul>
<h3 id="safe-execution-1">Safe Execution</h3>
<ul>
<li><code>ISafeExecutor</code> - Centralized error handling</li>
<li><code>IErrorNotifier</code> - User notification</li>
</ul>
<h3 id="logging">Logging</h3>
<ul>
<li><code>IDbtLoggingHost</code> - Logging host interface</li>
<li><code>ILogSink</code> - Custom sink interface</li>
</ul>
<h3 id="settings">Settings</h3>
<ul>
<li><code>ISettingsProvider</code> - Settings access</li>
<li><code>DbtSettingsRegistry</code> - Settings pack registry</li>
<li><code>IDbtToolSettingsPack</code> - Settings pack interface</li>
</ul>
<h3 id="tool-system">Tool System</h3>
<ul>
<li><code>DbtToolModule</code> - Tool module base class</li>
<li><code>DbtToolRegistry</code> - Tool registration</li>
<li><code>DbtToolManifest</code> - Manifest structure</li>
<li><code>DbtHookHost</code> - Hook coordination</li>
</ul>
<h3 id="ui">UI</h3>
<ul>
<li><code>DbtWindowBase</code> - Window base class</li>
<li><code>IAlertService</code> - Alert dialogs</li>
<li><code>IWindowOwnerProvider</code> - Window ownership</li>
</ul>
<h2 id="usage-examples">Usage Examples</h2>
<h3 id="creating-a-tool-command">Creating a Tool Command</h3>
<pre><code class="lang-csharp">public class MyToolCommand : DbtToolCommand
{
    protected override async Task RunAsync(IDbtToolContext context)
    {
        var myService = context.Resolve&lt;IMyService&gt;();
        
        // Execute Revit API work
        await context.RevitRunScope.TransactionRunner.RunAsync(&quot;My Operation&quot;, doc =&gt;
        {
            // Modify document
        });
    }
}
</code></pre>
<h3 id="using-the-call-gate">Using the Call Gate</h3>
<pre><code class="lang-csharp">// Get element data from Revit (thread-safe)
var result = await callGate.RunAsync(uiapp =&gt;
{
    var doc = uiapp.ActiveUIDocument.Document;
    return doc.GetElement(elementId);
}, ct, RevitCallMode.RequiresActiveView);
</code></pre>
<h3 id="registering-a-tool-module">Registering a Tool Module</h3>
<pre><code class="lang-csharp">public class MyToolModule : DbtToolModule
{
    public override void RegisterServices(IServiceCollection services, DbtToolManifest manifest)
    {
        services.AddSingleton&lt;IMyService, MyService&gt;();
    }
    
    public override void RegisterHooks(DbtToolRegistry registry, DbtToolManifest manifest)
    {
        registry.RegisterHook&lt;IViewActivatedHookHandler, MyViewHandler&gt;();
    }
}
</code></pre>
<h2 id="extension-points">Extension Points</h2>
<ol>
<li><strong>Custom Call Gates</strong> - Implement <code>IRevitCallGate</code> for specialized execution modes</li>
<li><strong>Hook Handlers</strong> - Register implementations of <code>IViewActivatedHookHandler</code> or <code>IContextualRibbonInjector</code></li>
<li><strong>Settings Packs</strong> - Create <code>DbtToolSettingsPack&lt;T&gt;</code> instances for tool-specific settings UI</li>
<li><strong>Alert Bodies</strong> - Implement <code>IAlertBody</code> for custom alert dialog content</li>
</ol>
<h2 id="build-considerations">Build Considerations</h2>
<h3 id="conditional-compilation">Conditional Compilation</h3>
<ul>
<li><strong>Sandbox builds</strong> (<code>DBT_IsSandboxBuild</code>): Revit-dependent files excluded, sandbox stubs used</li>
<li><strong>Designer builds</strong> (<code>DBT_IsDesignerBuild</code>): Revit sources excluded for XAML designer</li>
<li><strong>wpftmp builds</strong>: Special handling for temporary projects during BAML compilation</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:12-99</code></p>
</blockquote>
<h3 id="internalsvisibleto">InternalsVisibleTo</h3>
<p>Test projects and DBTools.App have access to internal types:</p>
<ul>
<li><code>DBTools.App</code></li>
<li><code>DBTools.GM.Tests</code></li>
<li><code>DBTools.SGT.Tests</code></li>
<li><code>DBTools.TDV.Tests</code></li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/DBTools.Core.csproj:27-32</code></p>
</blockquote>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="../architecture/overview.html">Architecture Overview</a> - System-wide architecture</li>
<li><a href="../architecture/project-references.html">Project References</a> - Inter-project dependencies</li>
<li><a href="loader.html">DBTools.Loader</a> - Revit entry point</li>
</ul>
<hr>
<h2 id="verification-status">Verification Status</h2>
<table>
<thead>
<tr>
<th>Check</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source anchors for all claims</td>
<td>Yes</td>
</tr>
<tr>
<td>UNVERIFIED markers where needed</td>
<td>No (all verified)</td>
</tr>
<tr>
<td>Cross-references added</td>
<td>Yes</td>
</tr>
<tr>
<td>Examples tested</td>
<td>N/A</td>
</tr>
<tr>
<td>No assumptions without evidence</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Verified by:</strong> docs-run-20260124-020412<br>
<strong>Date:</strong> 2026-01-24</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/projects/core.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
