<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Architecture Overview | DB Tools </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Architecture Overview | DB Tools ">
      
      
      <link rel="icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/architecture/overview.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        localStorage.setItem('theme', 'dark')
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      </script>

      <script src="../../public/main.js" defer></script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" src="../../images/logo.png" alt="DB Tools" width="32" height="32">
            DB Tools
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="architecture-overview">Architecture Overview</h1>

<!-- STATUS: draft -->
<!-- Last Updated: 2026-01-24 -->
<!-- Verified By: docs-run-20260124-020412 -->
<p>DBTools is a modular Revit add-in suite built with modern C#/.NET practices. It provides a collection of productivity tools for structural engineers working in Autodesk Revit.</p>
<h2 id="high-level-architecture">High-Level Architecture</h2>
<pre><code class="lang-mermaid">graph TB
    subgraph Revit[&quot;Revit Host&quot;]
        RevitAPI[&quot;Revit API&lt;br/&gt;(RevitAPI.dll, RevitAPIUI.dll)&quot;]
    end
    
    subgraph DBTools[&quot;DBTools Add-in&quot;]
        Loader[&quot;DBTools.Loader&lt;br/&gt;(Entry Point)&quot;]
        App[&quot;DBTools.App&lt;br/&gt;(DBTools.dll)&quot;]
        Core[&quot;DBTools.Core&lt;br/&gt;(Core Library)&quot;]
        Themes[&quot;DBTools.Themes&lt;br/&gt;(WPF Resources)&quot;]
        
        subgraph Tools[&quot;Tool Modules (File-linked)&quot;]
            GM[&quot;GM&quot;]
            SGT[&quot;SGT&quot;]
            TDV[&quot;TDV&quot;]
            Others[&quot;...&quot;]
        end
    end
    
    Revit --&gt;|&quot;.addin manifest&quot;| Loader
    Loader --&gt;|&quot;Loads &amp; resolves&quot;| App
    App --&gt; Core
    App --&gt; Themes
    App --&gt;|&quot;Discovers via manifest.yml&quot;| Tools
    Core --&gt; RevitAPI
    
    style Revit fill:#f5f5f5,stroke:#333
    style DBTools fill:#e3f2fd,stroke:#1946B9
    style Tools fill:#fff3e0,stroke:#FEC425
</code></pre>
<h3 id="ascii-diagram-for-reference">ASCII Diagram (for reference)</h3>
<pre><code>+-----------------------------------------------------------------------------------+
|                                 Revit Host                                        |
+-----------------------------------------------------------------------------------+
        |                                                           |
        v                                                           v
+-------------------+                                    +----------------------+
|  DBTools.Loader   |  &lt;-- Revit .addin manifest         |   Revit API          |
|  (Entry Point)    |      points here                   |   (RevitAPI.dll,     |
+-------------------+                                    |   RevitAPIUI.dll)    |
        |                                                +----------------------+
        | Loads DBTools.dll, installs                              ^
        | EmbeddedAssemblyResolver                                 |
        v                                                          |
+-------------------+     References      +----------------------+ |
|   DBTools.App     | -----------------&gt; |    DBTools.Core      |-+
|   (DBTools.dll)   |                    |    (Core Library)    |
|                   |                    +----------------------+
|  - AddinEntry     |                              ^
|  - Tool Modules   |                              |
|  - Ribbon UI      |     References               |
|  - Commands       | -----------------&gt; +----------------------+
+-------------------+                    |   DBTools.Themes     |
        |                                |   (WPF Resources)    |
        | Discovers via manifest.yml     +----------------------+
        v
+-------------------+
|   Tool Modules    |
|  (File-linked)    |
|  - GM, SGT, TDV   |
|  - Settings       |
|  - Structural/*   |
+-------------------+
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:12-38</code></p>
</blockquote>
<h2 id="project-organization">Project Organization</h2>
<p>The solution follows a layered architecture with clear separation of concerns:</p>
<h3 id="core-projects">Core Projects</h3>
<table>
<thead>
<tr>
<th>Project</th>
<th>Purpose</th>
<th>Target Frameworks</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DBTools.Loader</strong></td>
<td>Revit entry point; loads DBTools.dll and resolves embedded assemblies</td>
<td>net48, net8.0-windows</td>
</tr>
<tr>
<td><strong>DBTools.App</strong></td>
<td>Main application assembly (outputs as <code>DBTools.dll</code>); contains ribbon UI and tool registration</td>
<td>net48, net8.0-windows</td>
</tr>
<tr>
<td><strong>DBTools.Core</strong></td>
<td>Core library with shared infrastructure (DI, logging, settings, Revit abstractions)</td>
<td>net48, net8.0-windows</td>
</tr>
<tr>
<td><strong>DBTools.Themes</strong></td>
<td>WPF theme resources and styling (HandyControl, Fluent.Ribbon)</td>
<td>net48, net8.0-windows</td>
</tr>
<tr>
<td><strong>DBTools.Sandbox</strong></td>
<td>Standalone WPF app for UI development without Revit</td>
<td>net48, net8.0-windows</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/</code> directory structure</p>
</blockquote>
<h3 id="tool-projects-file-linked-into-dbtoolsapp">Tool Projects (File-Linked into DBTools.App)</h3>
<p>Tools are organized under <code>csharp/src/Tools/</code> and compiled into the main <code>DBTools.dll</code> assembly via MSBuild file linking:</p>
<pre><code>Tools/
+-- Common/
|   +-- GM/               # Global Mapper
|   +-- TDV/              # Type Data Viewer
|   +-- ElevationTags/
|   +-- 3DElementsFromList/
+-- Structural/
|   +-- SGT/              # Structural Grid Tool
|   +-- FoundationTags/
|   +-- FramingJoins/
|   +-- JoistGirderWeight/
|   +-- OrganizeFoundationTypes/
|   +-- AnalyticalSnapToLevel/
+-- Settings/             # Settings management tool
+-- Testing/
    +-- VTC/              # View Test Coordinator
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:62-78</code> (file linking configuration)</p>
</blockquote>
<p>Tool source files are linked (not copied) into the DBTools.App project:</p>
<pre><code class="lang-xml">&lt;Compile Include=&quot;..\Tools\**\*.cs&quot;
         Exclude=&quot;..\Tools\**\Tests\**\*.cs;..\Tools\**\obj\**\*.cs&quot;
         Link=&quot;Tools\%(RecursiveDir)%(Filename)%(Extension)&quot; /&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:64-66</code></p>
</blockquote>
<h2 id="multi-year-revit-support">Multi-Year Revit Support</h2>
<p>DBTools supports multiple Revit versions through dual target frameworks:</p>
<table>
<thead>
<tr>
<th>Revit Version</th>
<th>Target Framework</th>
<th>Runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td>Revit 2024</td>
<td><code>net48</code></td>
<td>.NET Framework 4.8</td>
</tr>
<tr>
<td>Revit 2025+</td>
<td><code>net8.0-windows</code></td>
<td>.NET 8</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/Revit.props:2-6</code></p>
</blockquote>
<p>The build system auto-detects installed Revit versions and builds for all available years:</p>
<pre><code class="lang-xml">&lt;DBT_RevitLegacyTFM&gt;net48&lt;/DBT_RevitLegacyTFM&gt;
&lt;DBT_RevitModernTFM&gt;net8.0-windows&lt;/DBT_RevitModernTFM&gt;
&lt;DBT_RevitTargetFrameworks&gt;$(DBT_RevitLegacyTFM);$(DBT_RevitModernTFM)&lt;/DBT_RevitTargetFrameworks&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build/Revit.props:3-5</code></p>
</blockquote>
<h2 id="tool-discovery-and-registration">Tool Discovery and Registration</h2>
<p>DBTools uses a YAML manifest-driven tool discovery system. Each tool declares its module, commands, and UI configuration in a <code>manifest.yml</code> file.</p>
<h3 id="manifest-structure">Manifest Structure</h3>
<pre><code class="lang-yaml">id: DBTools.GM
assembly: DBTools
moduleType: DBTools.GM.GmToolModule
order: 0
sandboxWindows:
  - id: DBTools.GM.Main
    displayName: &quot;Global Mapper&quot;
    windowType: &quot;DBTools.GM.Shell.UI.Views.GmWindow&quot;
tool:
  ribbonTools:
    - internalName: DBTools.GM
      commandType: DBTools.GM.Features.GmCommand
      availabilityType: DBTools.App.Tools.Availability.DbtDocumentAvailability
      displayText: &quot;Global Mapper&quot;
      iconBaseKey: gm
      controlKind: PushButton
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/Tools/Common/GM/manifest.yml:1-26</code></p>
</blockquote>
<h3 id="discovery-flow">Discovery Flow</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant App as DBTools.App
    participant Loader as DbtToolManifestLoader
    participant Catalog as DbtToolModuleCatalog
    participant Module as DbtToolModule
    participant DI as IServiceCollection
    participant Ribbon as RibbonManager

    App-&gt;&gt;Loader: ScanEmbeddedResources()
    Loader--&gt;&gt;App: List&lt;DbtToolManifest&gt;
    
    loop For each manifest
        App-&gt;&gt;Catalog: CreateModule(manifest)
        Catalog-&gt;&gt;Module: new() via reflection
        Module--&gt;&gt;Catalog: DbtToolModule instance
        
        App-&gt;&gt;Module: RegisterSettings()
        App-&gt;&gt;Module: RegisterServices()
        Module-&gt;&gt;DI: AddScoped&lt;T&gt;()
        
        App-&gt;&gt;Module: RegisterHooks()
        App-&gt;&gt;Ribbon: RegisterRibbonToolsFromManifest()
    end
</code></pre>
<ol>
<li><strong>Manifest Loading</strong>: <code>DbtToolManifestLoader</code> scans embedded resources for <code>manifest.yml</code> files</li>
<li><strong>Module Instantiation</strong>: <code>DbtToolModuleCatalog</code> creates <code>DbtToolModule</code> instances via reflection</li>
<li><strong>Service Registration</strong>: Each module's <code>RegisterServices()</code>, <code>RegisterSettings()</code>, and <code>RegisterHooks()</code> are called</li>
<li><strong>Ribbon Tool Registration</strong>: <code>RegisterRibbonToolsFromManifest()</code> parses ribbon definitions and registers commands</li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolModuleCatalog.cs:11-64</code></p>
</blockquote>
<h3 id="tool-module-base-class">Tool Module Base Class</h3>
<p>All tools inherit from <code>DbtToolModule</code>, which provides hooks for:</p>
<ul>
<li><code>RegisterSettings()</code> - Bind configuration sections to strongly-typed options</li>
<li><code>RegisterServices()</code> - Register tool-specific DI services</li>
<li><code>RegisterSettingsPacks()</code> - Register settings UI definitions</li>
<li><code>RegisterHooks()</code> - Register event handlers (e.g., DocumentOpened, ViewActivated)</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Core/Tools/DbtToolModule.cs:9-49</code></p>
</blockquote>
<h2 id="dependency-injection-architecture">Dependency Injection Architecture</h2>
<p>DBTools uses Microsoft.Extensions.DependencyInjection with a two-tier service scope pattern:</p>
<h3 id="singleton-services-application-lifetime">Singleton Services (Application Lifetime)</h3>
<ul>
<li><code>IDbtLoggingHost</code> - Serilog-based logging infrastructure</li>
<li><code>IConfiguration</code> - Settings from <code>settings.json</code></li>
<li><code>DbtToolRegistry</code> - Discovered tool registrations</li>
<li><code>ISafeExecutor</code> - Centralized error handling</li>
<li><code>ISettingsProvider</code> - Settings read/write access</li>
</ul>
<h3 id="scoped-services-per-command-lifetime">Scoped Services (Per-Command Lifetime)</h3>
<ul>
<li><code>IRevitRunScope</code> - Active command execution context</li>
<li><code>IRevitCallGate</code> - Thread-safe Revit API access</li>
<li><code>ITransactionRunner</code> - Transaction management</li>
<li><code>ITransactionGroupService</code> - Transaction grouping</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/Bootstrap/DbtServiceBootstrapper.cs:68-130</code></p>
</blockquote>
<h2 id="assembly-loading-strategy">Assembly Loading Strategy</h2>
<h3 id="loader-bootstrap">Loader Bootstrap</h3>
<p>The <code>DBTools.Loader</code> assembly is the Revit entry point. It:</p>
<ol>
<li>Locates <code>DBTools.dll</code> in the same directory</li>
<li>Installs <code>EmbeddedAssemblyResolver</code> for runtime dependency resolution</li>
<li>Pre-loads critical assemblies (Configuration, Serilog) on net48</li>
<li>Reflectively creates and invokes <code>DBTools.App.AddinEntry</code></li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/Addin/AddinEntry.cs:17-47</code></p>
</blockquote>
<h3 id="embedded-dependencies">Embedded Dependencies</h3>
<p>Dependencies are embedded as resources in <code>DBTools.dll</code> to minimize deployment complexity:</p>
<pre><code class="lang-xml">&lt;EmbeddedResource Include=&quot;%(_EmbedLogicalDistinct.SourcePath)&quot;
                  LogicalName=&quot;%(_EmbedLogicalDistinct.Identity)&quot; /&gt;
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/DBTools.App.csproj:267-268</code></p>
</blockquote>
<p>The resolver uses different strategies per framework:</p>
<table>
<thead>
<tr>
<th>Framework</th>
<th>Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td>net48</td>
<td>ILRepack merges most assemblies; ricaun.* embedded as resources</td>
</tr>
<tr>
<td>net8.0</td>
<td>All dependencies embedded as resources, loaded via <code>AssemblyLoadContext</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:14-96</code></p>
</blockquote>
<h3 id="wpf-theme-assemblies">WPF Theme Assemblies</h3>
<p>WPF assemblies (Fluent.Ribbon, ControlzEx, HandyControl) cannot be embedded because they require <code>Assembly.Location</code> for <code>pack://</code> URI resolution. These are:</p>
<ol>
<li>Vendored/renamed to avoid conflicts with pyRevit (e.g., <code>DBTools.Fluent.Ribbon</code>)</li>
<li>Deployed as files alongside <code>DBTools.dll</code></li>
</ol>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.Loader/AssemblyResolution/EmbeddedAssemblyResolver.cs:134-143</code></p>
</blockquote>
<h2 id="build-system-overview">Build System Overview</h2>
<p>The build uses NUKE (C# build automation) invoked via <code>build.sh</code>:</p>
<pre><code class="lang-bash"># Fast incremental build (default)
bash csharp/build.sh

# Clean rebuild
bash csharp/build.sh --clean

# Build specific Revit year
bash csharp/build.sh -y 2025 BuildAll

# Common targets
bash csharp/build.sh BuildAll          # Build everything
bash csharp/build.sh BuildApp          # Build DBTools.dll only
bash csharp/build.sh BuildSandbox      # Build UI sandbox
bash csharp/build.sh PromoteToDist     # Stage for deployment
</code></pre>
<blockquote>
<p><strong>Source:</strong> <code>csharp/build.sh:33-60</code></p>
</blockquote>
<p>Key build features:</p>
<ul>
<li><strong>Centralized Artifacts</strong>: All outputs go to <code>csharp/.artifacts/</code> (not per-project <code>bin/obj</code>)</li>
<li><strong>Vendored Dependencies</strong>: UI assemblies built via <code>build-vendored-deps.sh</code></li>
<li><strong>Strict Analysis</strong>: <code>TreatWarningsAsErrors=true</code>, Roslyn analyzers enabled</li>
<li><strong>Multi-Year</strong>: Builds for all detected Revit installations</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/Directory.Build.props:8-28</code></p>
</blockquote>
<p>For detailed build pipeline documentation, see <a href="build-pipeline.html">Build Pipeline</a>.</p>
<h2 id="error-handling-philosophy">Error Handling Philosophy</h2>
<p>All entrypoints execute within <code>ISafeExecutor</code>, which:</p>
<ul>
<li>Catches and logs all exceptions</li>
<li>Displays user-friendly error dialogs</li>
<li>Prevents silent failures</li>
<li>Centralizes error reporting</li>
</ul>
<blockquote>
<p><strong>Source:</strong> <code>csharp/src/DBTools.App/Bootstrap/DbtServiceBootstrapper.cs:435-436</code></p>
</blockquote>
<p><strong>Non-Negotiable Rules:</strong></p>
<ul>
<li>No fallbacks that hide failures</li>
<li>No silent exception swallowing</li>
<li>No returning defaults as if nothing failed</li>
</ul>
<h2 id="related-documentation">Related Documentation</h2>
<ul>
<li><a href="build-pipeline.html">Build Pipeline</a> - Detailed build system reference</li>
<li><a href="test-pipeline.html">Test Pipeline</a> - Testing infrastructure</li>
<li><a href="project-references.html">Project References</a> - Dependency relationships</li>
<li><a href="../projects/core.html">DBTools.Core</a> - Core library documentation</li>
<li><a href="../projects/loader.html">DBTools.Loader</a> - Revit entry point</li>
</ul>
<hr>
<h2 id="verification-status">Verification Status</h2>
<table>
<thead>
<tr>
<th>Check</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source anchors for all claims</td>
<td>Yes</td>
</tr>
<tr>
<td>UNVERIFIED markers where needed</td>
<td>No (all verified)</td>
</tr>
<tr>
<td>Cross-references added</td>
<td>Yes</td>
</tr>
<tr>
<td>Examples tested</td>
<td>N/A</td>
</tr>
<tr>
<td>No assumptions without evidence</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p><strong>Verified by:</strong> docs-run-20260124-020412<br>
<strong>Date:</strong> 2026-01-24</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/kirsch33/dbtools/blob/claude/bulk-pr-merge1-Two45/csharp/wiki/developer-guide/architecture/overview.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DB Tools - Revit Add-in Toolkit
        </div>
      </div>
    </footer>
  </body>
</html>
